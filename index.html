<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cradero - Complete Maintenance Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' blob: data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'self' blob: data: https://*.supabase.co https://cdn.jsdelivr.net https://fonts.googleapis.com https://fonts.gstatic.com; worker-src 'self' blob:;">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #0066FF;
            --primary-dark: #0052CC;
            --primary-light: #3385FF;
            --secondary: #FF6B35;
            --success: #00C853;
            --warning: #FFB300;
            --danger: #FF3D00;
            --dark: #1A1A1A;
            --gray-900: #2D2D2D;
            --gray-800: #3D3D3D;
            --gray-700: #4D4D4D;
            --gray-600: #666666;
            --gray-500: #808080;
            --gray-400: #999999;
            --gray-300: #CCCCCC;
            --gray-200: #E5E5E5;
            --gray-100: #F5F5F5;
            --white: #FFFFFF;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gray-100);
            color: var(--dark);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: var(--white);
            border-bottom: 2px solid var(--gray-200);
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .logo-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(145deg, #003DA6, #0066FF, #2979FF);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 102, 255, 0.3), inset 0 1px 0 rgba(255,255,255,0.1);
            border: 1px solid rgba(0, 82, 204, 0.3);
        }

        .logo-icon svg {
            width: 26px;
            height: 26px;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .notification-bell {
            position: relative;
            background: var(--gray-100);
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .notification-bell:hover {
            background: var(--gray-200);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
        }

        .notification-dropdown {
            position: absolute;
            top: 70px;
            right: 2rem;
            width: 380px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: none;
            max-height: 500px;
            overflow-y: auto;
            z-index: 1001;
        }

        .notification-dropdown.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--gray-200);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .notification-item {
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--gray-100);
        }

        .notification-item.unread {
            background: rgba(0, 102, 255, 0.05);
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--dark);
        }

        .notification-text {
            font-size: 0.9rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--gray-500);
        }

        /* Main Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--gray-200);
            overflow-x: auto;
        }

        .nav-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: var(--gray-600);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            font-size: 1rem;
            font-family: 'Work Sans', sans-serif;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: var(--primary);
            background: var(--gray-100);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tier-essential .order-part-btn { display: none; }
        .tier-essential .pro-only-feature { display: none; }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--dark);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--white), var(--gray-100));
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--gray-200);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-label {
            color: var(--gray-600);
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            font-family: 'IBM Plex Mono', monospace;
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            font-family: 'Work Sans', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 102, 255, 0.3);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Work Orders List */
        .work-orders-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .work-order-item {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 1.5rem;
            align-items: center;
            transition: all 0.2s;
        }

        .work-order-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 102, 255, 0.1);
        }

        .wo-priority {
            width: 8px;
            height: 60px;
            border-radius: 4px;
        }

        .wo-priority.high { background: var(--danger); }
        .wo-priority.medium { background: var(--warning); }
        .wo-priority.low { background: var(--success); }

        .wo-details {
            flex: 1;
        }

        .wo-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .wo-meta {
            display: flex;
            gap: 1.5rem;
            color: var(--gray-600);
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .wo-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .wo-images {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .wo-image-thumb {
            width: 60px;
            height: 60px;
            border-radius: 6px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--gray-200);
            transition: all 0.2s;
        }

        .wo-image-thumb:hover {
            transform: scale(1.05);
            border-color: var(--primary);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .status-badge.open {
            background: rgba(0, 102, 255, 0.1);
            color: var(--primary);
        }

        .status-badge.in-progress {
            background: rgba(255, 179, 0, 0.1);
            color: var(--warning);
        }

        .status-badge.completed {
            background: rgba(0, 200, 83, 0.1);
            color: var(--success);
        }

        /* Equipment List */
        .equipment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .equipment-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .equipment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .equipment-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .equipment-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark);
            margin-bottom: 0.25rem;
        }

        .equipment-id {
            color: var(--gray-600);
            font-size: 0.9rem;
            font-family: 'IBM Plex Mono', monospace;
        }

        .equipment-status {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .equipment-status.operational {
            background: rgba(0, 200, 83, 0.1);
            color: var(--success);
        }

        .equipment-status.maintenance {
            background: rgba(255, 179, 0, 0.1);
            color: var(--warning);
        }

        .equipment-status.down {
            background: rgba(255, 61, 0, 0.1);
            color: var(--danger);
        }

        .equipment-info {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
        }

        .equipment-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .equipment-info-label {
            color: var(--gray-600);
        }

        .equipment-info-value {
            font-weight: 600;
            color: var(--dark);
        }

        .equipment-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        /* Parts Inventory */
        .parts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .part-card {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
        }

        .part-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .part-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark);
        }

        .part-number {
            color: var(--gray-600);
            font-size: 0.9rem;
            font-family: 'IBM Plex Mono', monospace;
            margin-top: 0.25rem;
        }

        .stock-indicator {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .stock-indicator.in-stock {
            background: rgba(0, 200, 83, 0.1);
            color: var(--success);
        }

        .stock-indicator.low-stock {
            background: rgba(255, 179, 0, 0.1);
            color: var(--warning);
        }

        .stock-indicator.out-of-stock {
            background: rgba(255, 61, 0, 0.1);
            color: var(--danger);
        }

        .part-details {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .part-detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .part-detail-label {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .part-detail-value {
            font-weight: 600;
            color: var(--dark);
        }

        /* PM Schedule */
        .pm-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .pm-item {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-left: 6px solid var(--primary);
            border-radius: 12px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 1.5rem;
            align-items: center;
        }

        .pm-item.overdue {
            border-left-color: var(--danger);
        }

        .pm-item.due-soon {
            border-left-color: var(--warning);
        }

        .pm-info {
            flex: 1;
        }

        .pm-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .pm-meta {
            display: flex;
            gap: 1.5rem;
            color: var(--gray-600);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .due-date {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .due-date.overdue {
            background: rgba(255, 61, 0, 0.1);
            color: var(--danger);
        }

        .due-date.due-soon {
            background: rgba(255, 179, 0, 0.1);
            color: var(--warning);
        }

        .due-date.upcoming {
            background: rgba(0, 102, 255, 0.1);
            color: var(--primary);
        }

        /* Daily Activity Log */
        .activity-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .activity-item {
            position: relative;
            padding-bottom: 2rem;
        }

        .activity-item::before {
            content: '';
            position: absolute;
            left: -2rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gray-300);
        }

        .activity-item:last-child::before {
            display: none;
        }

        .activity-dot {
            position: absolute;
            left: -2.5rem;
            top: 0.25rem;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 3px solid var(--primary);
            background: white;
        }

        .activity-dot.completed {
            border-color: var(--success);
        }

        .activity-dot.in-progress {
            border-color: var(--warning);
        }

        .activity-dot.created {
            border-color: var(--primary);
        }

        .activity-content {
            background: var(--white);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }

        .activity-title {
            font-weight: 700;
            color: var(--dark);
        }

        .activity-time {
            color: var(--gray-600);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .activity-description {
            color: var(--gray-600);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .activity-meta {
            display: flex;
            gap: 1.5rem;
            margin-top: 0.75rem;
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        /* Analytics Dashboard */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            border: 2px solid var(--gray-200);
        }

        .chart-header {
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .chart-subtitle {
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .chart-placeholder {
            height: 250px;
            background: linear-gradient(135deg, var(--gray-100), var(--gray-200));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-600);
            font-style: italic;
        }

        .metric-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--gray-100);
            border-radius: 8px;
        }

        .metric-label {
            color: var(--gray-600);
            font-weight: 600;
        }

        .metric-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'IBM Plex Mono', monospace;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-300);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Work Sans', sans-serif;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .file-upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: rgba(0, 102, 255, 0.02);
        }

        .file-upload-area.dragging {
            border-color: var(--primary);
            background: rgba(0, 102, 255, 0.05);
        }

        .file-upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .file-upload-text {
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .file-preview {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .file-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--gray-300);
        }

        .file-preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .file-preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.2s;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 2px solid var(--gray-200);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 2px solid var(--gray-200);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Search Bar */
        .search-bar {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--gray-300);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-500);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-600);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .empty-state-text {
            margin-bottom: 2rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            color: white;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease;
            min-width: 280px;
            max-width: 400px;
        }
        .toast.success { background: var(--success); }
        .toast.error   { background: var(--danger); }
        .toast.info    { background: var(--primary); }
        .toast.warning { background: var(--warning); color: var(--dark); }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(40px); }
            to   { opacity: 1; transform: translateX(0); }
        }

        /* Breakdown Card */
        .breakdown-card {
            display: grid;
            grid-template-columns: 6px 1fr auto auto;
            gap: 0;
            background: var(--white);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 0.75rem;
            align-items: start;
        }
        .breakdown-bar { width: 6px; min-height: 80px; flex-shrink: 0; }
        .breakdown-bar.resolved    { background: var(--success); }
        .breakdown-bar.in-progress { background: var(--warning); }
        .breakdown-bar.pending     { background: var(--danger); }
        .breakdown-body { padding: 1rem; }
        .breakdown-machine { font-weight: 700; font-size: 1rem; color: var(--dark); }
        .breakdown-fault   { color: var(--gray-600); margin-top: 0.25rem; font-size: 0.9rem; }
        .breakdown-meta    { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 0.5rem; font-size: 0.8rem; color: var(--gray-500); }
        .breakdown-resolution {
            margin-top: 0.6rem; padding: 0.5rem 0.75rem;
            background: var(--gray-100); border-radius: 8px; font-size: 0.85rem;
        }
        .breakdown-status  { padding: 1rem 0.5rem; }
        .breakdown-actions { padding: 1rem 1rem 1rem 0.5rem; display: flex; flex-direction: column; gap: 0.5rem; justify-content: flex-start; }
        /* Filter Bar */
        .filter-bar {
            display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: flex-end;
            padding: 1rem; background: var(--gray-100); border-radius: 10px; margin-bottom: 1.25rem;
        }
        .filter-bar .form-group { margin-bottom: 0; }
        /* Calendar */
        .cal-header {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem;
        }
        .cal-title { font-size: 1.25rem; font-weight: 700; min-width: 180px; }
        .cal-nav-btn {
            background: var(--gray-100); border: none; width: 36px; height: 36px;
            border-radius: 8px; cursor: pointer; font-size: 1.2rem; display: flex;
            align-items: center; justify-content: center; font-weight: 700;
        }
        .cal-nav-btn:hover { background: var(--gray-200); }
        .cal-view-toggle { display: flex; gap: 0.25rem; }
        .cal-view-btn {
            padding: 0.4rem 0.9rem; border: 1px solid var(--gray-200);
            background: var(--white); border-radius: 6px; cursor: pointer;
            font-weight: 600; font-size: 0.85rem; font-family: inherit;
        }
        .cal-view-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .cal-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden;
        }
        .cal-day-header {
            background: var(--gray-100); text-align: center; padding: 0.6rem 0;
            font-weight: 700; font-size: 0.78rem; color: var(--gray-600);
            border-right: 1px solid var(--gray-200);
        }
        .cal-day-header:last-child { border-right: none; }
        .cal-day {
            min-height: 90px; padding: 0.4rem;
            border-right: 1px solid var(--gray-200); border-bottom: 1px solid var(--gray-200);
            background: var(--white); vertical-align: top;
        }
        .cal-day:nth-child(7n) { border-right: none; }
        .cal-day.empty { background: var(--gray-100); }
        .cal-day.today { outline: 2px solid var(--primary); outline-offset: -2px; }
        .cal-day-num { font-size: 0.85rem; font-weight: 600; color: var(--gray-700); margin-bottom: 0.25rem; }
        .cal-day.today .cal-day-num { color: var(--primary); }
        .cal-event-pill {
            display: block; font-size: 0.7rem; padding: 2px 5px; border-radius: 4px;
            color: white; margin-bottom: 2px; cursor: pointer;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .cal-more { font-size: 0.7rem; color: var(--gray-500); cursor: pointer; }
        .evt-weekly-pm     { background: #0066FF; }
        .evt-monthly-pm    { background: #7C3AED; }
        .evt-major-service { background: #FF3D00; }
        .evt-inspection    { background: #FFB300; color: var(--dark) !important; }
        .evt-shutdown      { background: #8B0000; }
        .week-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;
        }
        .week-day-col {
            background: var(--white); border: 1px solid var(--gray-200);
            border-radius: 10px; overflow: hidden;
        }
        .week-day-header {
            background: var(--gray-100); padding: 0.5rem; text-align: center;
            font-weight: 700; font-size: 0.82rem; border-bottom: 1px solid var(--gray-200);
        }
        .week-day-header.today-header { background: var(--primary); color: white; }
        .week-events { padding: 0.5rem; display: flex; flex-direction: column; gap: 0.4rem; min-height: 60px; }
        .week-event {
            padding: 0.4rem 0.6rem; border-radius: 6px; color: white;
            font-size: 0.78rem; font-weight: 600; cursor: pointer;
        }
        .week-event.evt-inspection { color: var(--dark); }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .work-order-item {
                grid-template-columns: auto 1fr;
                gap: 1rem;
            }

            .wo-actions {
                grid-column: 1 / -1;
                display: flex;
                gap: 0.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .parts-grid,
            .equipment-grid {
                grid-template-columns: 1fr;
            }

            .analytics-grid {
                grid-template-columns: 1fr;
            }

            .pm-item {
                grid-template-columns: 1fr;
            }

            .notification-dropdown {
                right: 1rem;
                left: 1rem;
                width: auto;
            }
        }

        /* ‚îÄ‚îÄ Auth Screen ‚îÄ‚îÄ */
        #authScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0052CC 0%, #0066FF 50%, #3385FF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        #authScreen.hidden { display: none; }

        .auth-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .auth-logo .logo-icon {
            width: 52px;
            height: 52px;
            background: linear-gradient(145deg, #003DA6, #0066FF, #2979FF);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 102, 255, 0.35), inset 0 1px 0 rgba(255,255,255,0.1);
            border: 1px solid rgba(0, 82, 204, 0.3);
        }

        .auth-logo .logo-icon svg {
            width: 36px;
            height: 36px;
        }

        .auth-logo span {
            font-weight: 700;
            font-size: 1.75rem;
            color: var(--primary);
        }

        .auth-title {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--dark);
        }

        .auth-form .form-group { margin-bottom: 1rem; }

        .auth-form .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
            color: var(--gray-700);
        }

        .auth-form .form-input,
        .auth-form .form-select {
            width: 100%;
            padding: 0.7rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .auth-form .form-input:focus,
        .auth-form .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .auth-form .btn-auth {
            width: 100%;
            padding: 0.8rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: background 0.2s;
        }

        .auth-form .btn-auth:hover { background: var(--primary-dark); }
        .auth-form .btn-auth:disabled { opacity: 0.6; cursor: not-allowed; }

        .auth-toggle {
            text-align: center;
            margin-top: 1.25rem;
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .auth-toggle a {
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        .auth-toggle a:hover { text-decoration: underline; }

        .auth-message {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: none;
        }

        .auth-message.error {
            display: block;
            background: #FFF0F0;
            color: var(--danger);
            border: 1px solid #FFCDD2;
        }

        .auth-message.success {
            display: block;
            background: #F0FFF4;
            color: #2E7D32;
            border: 1px solid #C8E6C9;
        }

        .auth-form-section { display: none; }
        .auth-form-section.active { display: block; }

        .user-email-display {
            font-size: 0.8rem;
            color: var(--gray-600);
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Auth Screen -->
    <div id="authScreen">
        <div class="auth-card">
            <div class="auth-logo">
                <div class="logo-icon"><svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M30 9 A16.5 16.5 0 1 0 30 39" stroke="white" stroke-width="5.5" stroke-linecap="round" fill="none"/><path d="M28.5 14.5 A10.5 10.5 0 1 0 28.5 33.5" stroke="white" stroke-width="1" stroke-linecap="round" fill="none" opacity="0.35"/><path d="M22 20.5 L25.5 24 L22 27.5 L18.5 24 Z" stroke="white" stroke-width="1.5" fill="white" fill-opacity="0.15"/><circle cx="22" cy="24" r="1" fill="white"/><line x1="32" y1="8.5" x2="35.5" y2="6.5" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="32" y1="39.5" x2="35.5" y2="41.5" stroke="white" stroke-width="2" stroke-linecap="round"/></svg></div>
                <span>Cradero</span>
            </div>

            <div id="authMessage" class="auth-message"></div>

            <!-- Login Form -->
            <div id="loginSection" class="auth-form-section active">
                <div class="auth-title">Log in to your account</div>
                <form class="auth-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required placeholder="you@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" required placeholder="Enter your password" minlength="6">
                    </div>
                    <button type="submit" class="btn-auth" id="loginBtn">Log In</button>
                </form>
                <div class="auth-toggle">
                    Don't have an account? <a onclick="showAuthSection('signup')">Sign up</a>
                </div>
            </div>

            <!-- Sign Up Form -->
            <div id="signupSection" class="auth-form-section">
                <div class="auth-title">Create a new account</div>
                <form class="auth-form" onsubmit="handleSignUp(event)">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="signupName" required placeholder="John Smith">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="signupEmail" required placeholder="you@company.com">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="signupPassword" required placeholder="Minimum 6 characters" minlength="6">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-input" id="signupPasswordConfirm" required placeholder="Re-enter your password" minlength="6">
                    </div>
                    <button type="submit" class="btn-auth" id="signupBtn">Sign Up</button>
                </form>
                <div class="auth-toggle">
                    Already have an account? <a onclick="showAuthSection('login')">Log in</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Approval Screen -->
    <div id="pendingScreen" style="display:none;">
        <div style="position:fixed;inset:0;background:linear-gradient(135deg,#0052CC 0%,#0066FF 50%,#3385FF 100%);display:flex;align-items:center;justify-content:center;z-index:9998;">
            <div class="auth-card" style="text-align:center;">
                <div class="auth-logo">
                    <div class="logo-icon"><svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M30 9 A16.5 16.5 0 1 0 30 39" stroke="white" stroke-width="5.5" stroke-linecap="round" fill="none"/><path d="M28.5 14.5 A10.5 10.5 0 1 0 28.5 33.5" stroke="white" stroke-width="1" stroke-linecap="round" fill="none" opacity="0.35"/><path d="M22 20.5 L25.5 24 L22 27.5 L18.5 24 Z" stroke="white" stroke-width="1.5" fill="white" fill-opacity="0.15"/><circle cx="22" cy="24" r="1" fill="white"/><line x1="32" y1="8.5" x2="35.5" y2="6.5" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="32" y1="39.5" x2="35.5" y2="41.5" stroke="white" stroke-width="2" stroke-linecap="round"/></svg></div>
                    <span>Cradero</span>
                </div>
                <div style="font-size:3rem;margin-bottom:1rem;">&#9203;</div>
                <h2 style="margin-bottom:0.75rem;color:var(--dark);">Account Pending Approval</h2>
                <p style="color:var(--gray-600);margin-bottom:1.5rem;line-height:1.6;">Your account has been created but is awaiting admin approval. You will be able to access the app once an administrator has reviewed and approved your account.</p>
                <button class="btn-auth" onclick="handleLogout()" style="background:var(--gray-700);">Log Out</button>
            </div>
        </div>
    </div>

    <!-- App Content (hidden until authenticated) -->
    <div id="appContent" style="display:none;">

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon"><svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M30 9 A16.5 16.5 0 1 0 30 39" stroke="white" stroke-width="5.5" stroke-linecap="round" fill="none"/><path d="M28.5 14.5 A10.5 10.5 0 1 0 28.5 33.5" stroke="white" stroke-width="1" stroke-linecap="round" fill="none" opacity="0.35"/><path d="M22 20.5 L25.5 24 L22 27.5 L18.5 24 Z" stroke="white" stroke-width="1.5" fill="white" fill-opacity="0.15"/><circle cx="22" cy="24" r="1" fill="white"/><line x1="32" y1="8.5" x2="35.5" y2="6.5" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="32" y1="39.5" x2="35.5" y2="41.5" stroke="white" stroke-width="2" stroke-linecap="round"/></svg></div>
                <span>Cradero</span>
            </div>
            <div class="header-actions">
                <span id="offlineIndicator" style="display:none;background:#FF3D00;color:white;padding:4px 12px;border-radius:6px;font-size:0.75rem;font-weight:600;letter-spacing:0.5px;">OFFLINE</span>
                <button class="notification-bell" onclick="toggleNotifications()">
                    üîî
                    <span class="notification-badge" id="notificationCount">5</span>
                </button>
                <button class="btn btn-primary" onclick="openModal('workOrderModal')">
                    + New Work Order
                </button>
                <span class="user-email-display" id="userEmailDisplay"></span>
                <button class="btn btn-secondary" onclick="handleLogout()">Log Out</button>
            </div>
        </div>
        
        <!-- Notification Dropdown -->
        <div class="notification-dropdown" id="notificationDropdown">
            <div class="notification-header">Notifications</div>
            <div class="notification-item unread" onclick="handleNotificationClick('pm', 'fire-alarm')">
                <div class="notification-title">üî• Fire Alarm Test Overdue</div>
                <div class="notification-text">Weekly fire alarm system test was due yesterday - immediate completion required for compliance</div>
                <div class="notification-time">30 minutes ago</div>
            </div>
            <div class="notification-item unread" onclick="handleNotificationClick('pm', 'line3-lube')">
                <div class="notification-title">‚ö†Ô∏è PM Maintenance Overdue</div>
                <div class="notification-text">Line 3 Filler - Monthly Lubrication is 2 days overdue</div>
                <div class="notification-time">2 hours ago</div>
            </div>
            <div class="notification-item unread" onclick="handleNotificationClick('workOrders', 3)">
                <div class="notification-title">üìã Unassigned Work Order</div>
                <div class="notification-text">Line 2 Packaging - Sensor Calibration has been unassigned for 24 hours</div>
                <div class="notification-time">5 hours ago</div>
            </div>
            <div class="notification-item unread" onclick="handleNotificationClick('permits', 'hotwork')">
                <div class="notification-title">üî• Hot Work Permit Expiring Soon</div>
                <div class="notification-text">Welding permit for Line 3 expires in 3 hours - ensure work is completed or extend permit</div>
                <div class="notification-time">6 hours ago</div>
            </div>
            <div class="notification-item" onclick="handleNotificationClick('workOrders', 2)">
                <div class="notification-title">‚úÖ Work Order Completed</div>
                <div class="notification-text">Line 1 Conveyor - Belt Replacement completed by John Smith</div>
                <div class="notification-time">Yesterday</div>
            </div>
            <div class="notification-item unread" onclick="handleNotificationClick('pm', 'emergency-lighting')">
                <div class="notification-title">üí° Emergency Lighting Test Due Soon</div>
                <div class="notification-text">Monthly emergency lighting test is due in 2 days</div>
                <div class="notification-time">Yesterday</div>
            </div>
            <div class="notification-item" onclick="handleNotificationClick('equipment', 1)">
                <div class="notification-title">üõ°Ô∏è Warranty Expired</div>
                <div class="notification-text">Line 3 - Filler Machine warranty from FoodTech Pro has expired</div>
                <div class="notification-time">2 days ago</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Maintenance Dashboard</h1>
            <p class="page-subtitle">Complete maintenance management system</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Open Work Orders</div>
                <div class="stat-value" id="openWorkOrders">12</div>
                <div class="stat-change positive">‚Üë 2 from yesterday</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Equipment Assets</div>
                <div class="stat-value" id="totalEquipment">24</div>
                <div class="stat-change positive">3 operational issues</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">PM Compliance</div>
                <div class="stat-value">94%</div>
                <div class="stat-change positive">‚Üë 3% this month</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Downtime This Week</div>
                <div class="stat-value">8.5h</div>
                <div class="stat-change negative">‚Üë 2.1h vs last week</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('workOrders')">Work Orders</button>
            <button class="nav-tab" onclick="switchTab('equipment')">Equipment</button>
            <button class="nav-tab" onclick="switchTab('parts')">Parts Inventory</button>
            <button class="nav-tab" onclick="switchTab('purchaseOrders')">Purchase Orders</button>
            <button class="nav-tab" onclick="switchTab('permits')">Permits</button>
            <button class="nav-tab" onclick="switchTab('pm')">Preventive Maintenance</button>
            <button class="nav-tab" onclick="switchTab('dailyLog')">Daily Activity</button>
            <button class="nav-tab" onclick="switchTab('analytics')">Analytics & Reports</button>
            <button class="nav-tab" onclick="switchTab('reactive')">&#9889; Reactive Maintenance</button>
            <button class="nav-tab" onclick="switchTab('calendar')">&#128197; Maintenance Calendar</button>
            <button class="nav-tab" onclick="switchTab('myTasks')" id="myTasksTab">My Tasks</button>
            <button class="nav-tab" onclick="switchTab('workRequests')" id="workRequestsTab">Work Requests</button>
        </div>

        <!-- Work Orders Tab -->
        <div id="workOrders" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Active Work Orders</h2>
                    <button class="btn btn-secondary" onclick="showFilterOptions()">Filter & Sort</button>
                </div>

                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search work orders by equipment, description, or assigned engineer...">
                </div>

                <div class="work-orders-list" id="workOrdersList">
                    <div class="work-order-item">
                        <div class="wo-priority high"></div>
                        <div class="wo-details">
                            <div class="wo-title">Line 3 Filler - Motor Overheating</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>Line 3 Filler</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span style="color: var(--danger); font-weight: 600;">Unassigned</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Created 2 hours ago</span>
                                </div>
                            </div>
                            <div class="wo-images">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect fill='%23E5E5E5' width='60' height='60'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='monospace' font-size='12' fill='%23666'%3Eüì∑%3C/text%3E%3C/svg%3E" class="wo-image-thumb" alt="Photo 1">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect fill='%23E5E5E5' width='60' height='60'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='monospace' font-size='12' fill='%23666'%3Eüì∑%3C/text%3E%3C/svg%3E" class="wo-image-thumb" alt="Photo 2">
                            </div>
                        </div>
                        <div class="status-badge open">Open</div>
                        <button class="btn btn-primary" onclick="openWorkOrderDetail(1)">View Details</button>
                    </div>

                    <div class="work-order-item">
                        <div class="wo-priority medium"></div>
                        <div class="wo-details">
                            <div class="wo-title">Line 1 Conveyor - Belt Replacement</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>Line 1 Conveyor</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>John Smith</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Started 1 hour ago</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-badge in-progress">In Progress</div>
                        <button class="btn btn-primary" onclick="openWorkOrderDetail(2)">View Details</button>
                    </div>

                    <div class="work-order-item">
                        <div class="wo-priority low"></div>
                        <div class="wo-details">
                            <div class="wo-title">Line 2 Packaging - Sensor Calibration</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>Line 2 Packaging</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span style="color: var(--danger); font-weight: 600;">Unassigned</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Created yesterday</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-badge open">Open</div>
                        <button class="btn btn-primary" onclick="openWorkOrderDetail(3)">View Details</button>
                    </div>

                    <div class="work-order-item">
                        <div class="wo-priority high"></div>
                        <div class="wo-details">
                            <div class="wo-title">Line 4 Mixer - Bearing Noise Investigation</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>Line 4 Mixer</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Mike Johnson</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Started 3 hours ago</span>
                                </div>
                            </div>
                            <div class="wo-images">
                                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect fill='%23E5E5E5' width='60' height='60'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='monospace' font-size='12' fill='%23666'%3Eüì∑%3C/text%3E%3C/svg%3E" class="wo-image-thumb" alt="Photo 1">
                            </div>
                        </div>
                        <div class="status-badge in-progress">In Progress</div>
                        <button class="btn btn-primary" onclick="openWorkOrderDetail(4)">View Details</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Tab -->
        <div id="equipment" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Equipment Assets</h2>
                    <button class="btn btn-primary" onclick="openModal('equipmentModal')">+ Add Equipment</button>
                </div>

                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search equipment by name, ID, or location...">
                </div>

                <div class="equipment-grid" id="equipmentGrid">
                    <div class="equipment-card">
                        <div class="equipment-header">
                            <div>
                                <div class="equipment-name">Line 3 - Filler Machine</div>
                                <div class="equipment-id">EQ-FL-003</div>
                            </div>
                            <div class="equipment-status down">Down</div>
                        </div>
                        <div class="equipment-info">
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Location</span>
                                <span class="equipment-info-value">Production Floor - Line 3</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Manufacturer</span>
                                <span class="equipment-info-value">FoodTech Pro</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Install Date</span>
                                <span class="equipment-info-value">Jan 2021</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Work Orders (30d)</span>
                                <span class="equipment-info-value">8 total</span>
                            </div>
                        </div>
                        <div class="equipment-actions">
                            <button class="btn btn-primary btn-small" onclick="openEquipmentHistory(1)">View History</button>
                            <button class="btn btn-secondary btn-small" onclick="openEquipmentEdit(1)">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteEquipment(1)">Delete</button>
                        </div>
                    </div>

                    <div class="equipment-card">
                        <div class="equipment-header">
                            <div>
                                <div class="equipment-name">Line 1 - Conveyor System</div>
                                <div class="equipment-id">EQ-CV-001</div>
                            </div>
                            <div class="equipment-status maintenance">Maintenance</div>
                        </div>
                        <div class="equipment-info">
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Location</span>
                                <span class="equipment-info-value">Production Floor - Line 1</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Manufacturer</span>
                                <span class="equipment-info-value">ConveyorMax</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Install Date</span>
                                <span class="equipment-info-value">Mar 2020</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Work Orders (30d)</span>
                                <span class="equipment-info-value">3 total</span>
                            </div>
                        </div>
                        <div class="equipment-actions">
                            <button class="btn btn-primary btn-small" onclick="openEquipmentHistory(2)">View History</button>
                            <button class="btn btn-secondary btn-small" onclick="openEquipmentEdit(2)">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteEquipment(2)">Delete</button>
                        </div>
                    </div>

                    <div class="equipment-card">
                        <div class="equipment-header">
                            <div>
                                <div class="equipment-name">Line 2 - Industrial Mixer</div>
                                <div class="equipment-id">EQ-MX-002</div>
                            </div>
                            <div class="equipment-status operational">Operational</div>
                        </div>
                        <div class="equipment-info">
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Location</span>
                                <span class="equipment-info-value">Production Floor - Line 2</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Manufacturer</span>
                                <span class="equipment-info-value">MixMaster Industrial</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Install Date</span>
                                <span class="equipment-info-value">Aug 2019</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Work Orders (30d)</span>
                                <span class="equipment-info-value">2 total</span>
                            </div>
                        </div>
                        <div class="equipment-actions">
                            <button class="btn btn-primary btn-small" onclick="openEquipmentHistory(3)">View History</button>
                            <button class="btn btn-secondary btn-small" onclick="openEquipmentEdit(3)">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteEquipment(3)">Delete</button>
                        </div>
                    </div>

                    <div class="equipment-card">
                        <div class="equipment-header">
                            <div>
                                <div class="equipment-name">Line 4 - Packaging Unit</div>
                                <div class="equipment-id">EQ-PK-004</div>
                            </div>
                            <div class="equipment-status operational">Operational</div>
                        </div>
                        <div class="equipment-info">
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Location</span>
                                <span class="equipment-info-value">Production Floor - Line 4</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Manufacturer</span>
                                <span class="equipment-info-value">PackPro Systems</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Install Date</span>
                                <span class="equipment-info-value">Dec 2020</span>
                            </div>
                            <div class="equipment-info-row">
                                <span class="equipment-info-label">Work Orders (30d)</span>
                                <span class="equipment-info-value">4 total</span>
                            </div>
                        </div>
                        <div class="equipment-actions">
                            <button class="btn btn-primary btn-small" onclick="openEquipmentHistory(4)">View History</button>
                            <button class="btn btn-secondary btn-small" onclick="openEquipmentEdit(4)">Edit</button>
                            <button class="btn btn-danger btn-small" onclick="deleteEquipment(4)">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parts Inventory Tab -->
        <div id="parts" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Parts Inventory</h2>
                    <button class="btn btn-primary" onclick="openAddPartModal()">+ Add Part</button>
                </div>

                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search parts by name, number, or location...">
                </div>

                <div class="parts-grid" id="partsGrid">
                    <div class="part-card">
                        <div class="part-header">
                            <div>
                                <div class="part-name">Motor Bearing 6205</div>
                                <div class="part-number">PN-MB-6205-001</div>
                            </div>
                            <div class="stock-indicator in-stock">In Stock</div>
                        </div>
                        <div class="part-details">
                            <div class="part-detail-row">
                                <span class="part-detail-label">Quantity</span>
                                <span class="part-detail-value">15 units</span>
                            </div>
                            <div class="part-detail-row">
                                <span class="part-detail-label">Location</span>
                                <span class="part-detail-value">Shelf B3, Bin 12</span>
                            </div>
                            <div class="part-detail-row">
                                <span class="part-detail-label">Min Stock</span>
                                <span class="part-detail-value">8 units</span>
                            </div>
                            <div class="part-detail-row">
                                <span class="part-detail-label">Used This Month</span>
                                <span class="part-detail-value">3 times</span>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="orderPart('PN-MB-6205-001', 'Motor Bearing 6205')">Order More</button>
                    </div>

                    <div class="part-card">
                        <div class="part-header">
                            <div>
                                <div class="part-name">Conveyor Belt 48"</div>
                                <div class="part-number">PN-CB-48-002</div>
                            </div>
                            <div class="stock-indicator low-stock">Low Stock</div>
                        </div>
                        <div class="part-details">
                            <div class="part-detail-row">
                                <span class="part-detail-label">Quantity</span>
                                <span class="part-detail-value">2 units</span>
                            </div>
                            <div class="part-detail-row">
                                <span class="part-detail-label">Location</span>
                                <span class="part-detail-value">Shelf A1, Bin 5</span>
                            </div>
                            <div class="part-detail-row">
                                <span class="part-detail-label">Min Stock</span>
                                <span class="part-detail-value">4 units</span>
                            </div>
                            <div class="part-detail-row">
                                <span class="part-detail-label">Used This Month</span>
                                <span class="part-detail-value">1 time</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="orderPart('PN-CB-48-002', 'Conveyor Belt 48', true)">üö® Order Now</button>
                    </div>

                    <div class="part-card">
                        <div class="part-header">
                            <div>
                                <div class="part-name">Proximity Sensor M18</div>
                                <div class="part-number">PN-PS-M18-004</div>
                            </div>
                            <div class="stock-indicator out-of-stock">Out of Stock</div>
                        </div>
                        <div class="part-details">
                            <div class="part-detail-row">
                                <span class="part-detail-label">Quantity</span>
                                <span class="part-detail-value">0 units</span>
                            </div>
                            <div class="part-detail-row">
                                <span class="part-detail-label">Location</span>
                                <span class="part-detail-value">Shelf D4, Bin 15</span>
                            </div>
                            <div class="part-detail-row">
                                <span class="part-detail-label">Min Stock</span>
                                <span class="part-detail-value">5 units</span>
                            </div>
                            <div class="part-detail-row">
                                <span class="part-detail-label">Used This Month</span>
                                <span class="part-detail-value">2 times</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="orderPart('PN-PS-M18-004', 'Proximity Sensor M18', true)">üö® Emergency Order</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Orders Tab -->
        <div id="purchaseOrders" class="tab-content">
            <!-- PO Summary Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Open POs</div>
                    <div class="stat-value">8</div>
                    <div class="stat-change positive">3 pending approval</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Value (Open)</div>
                    <div class="stat-value">¬£4,235</div>
                    <div class="stat-change negative">‚Üë ¬£850 this week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">This Month Spending</div>
                    <div class="stat-value">¬£12,847</div>
                    <div class="stat-change positive">‚Üì 12% vs last month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">YTD Parts Budget</div>
                    <div class="stat-value">¬£28,340</div>
                    <div class="stat-change positive">47% of annual budget</div>
                </div>
            </div>

            <!-- Quick Filters -->
            <div class="card" style="margin-bottom: 2rem;">
                <div style="padding: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: var(--dark);">Quick Filters:</span>
                    <button class="btn btn-secondary btn-small" onclick="filterPOs('all')" style="background: var(--primary); color: white;">All POs</button>
                    <button class="btn btn-secondary btn-small" onclick="filterPOs('pending')">Pending</button>
                    <button class="btn btn-secondary btn-small" onclick="filterPOs('approved')">Approved</button>
                    <button class="btn btn-secondary btn-small" onclick="filterPOs('ordered')">Ordered</button>
                    <button class="btn btn-secondary btn-small" onclick="filterPOs('received')">Received</button>
                    <button class="btn btn-secondary btn-small" onclick="filterPOs('cancelled')">Cancelled</button>
                </div>
            </div>

            <!-- Active Purchase Orders -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Active Purchase Orders</h2>
                    <button class="btn btn-primary" onclick="openModal('createPOModal')">+ Create PO</button>
                </div>

                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search POs by number, vendor, or part...">
                </div>

                <div class="work-orders-list" id="poList">
                    <!-- PO 1 - Emergency Order -->
                    <div class="work-order-item" style="border-left: 6px solid var(--danger);">
                        <div class="wo-priority high"></div>
                        <div class="wo-details">
                            <div class="wo-title">PO-2026-00145 - Emergency Parts Order</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè¢</span>
                                    <span>Grainger</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üì¶</span>
                                    <span>3 items</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üí∞</span>
                                    <span style="font-weight: 700; color: var(--dark);">¬£1,245.00</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Created: Today, 10:30 AM</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üöö</span>
                                    <span style="color: var(--warning); font-weight: 600;">Expected: Same Day</span>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <span style="padding: 0.25rem 0.75rem; background: var(--gray-100); border-radius: 20px; font-size: 0.85rem;">Proximity Sensor M18 (5x)</span>
                                <span style="padding: 0.25rem 0.75rem; background: var(--gray-100); border-radius: 20px; font-size: 0.85rem;">Motor Bearing 6205 (2x)</span>
                                <span style="padding: 0.25rem 0.75rem; background: var(--gray-100); border-radius: 20px; font-size: 0.85rem;">Conveyor Belt (1x)</span>
                            </div>
                        </div>
                        <div class="status-badge" style="background: rgba(255, 179, 0, 0.1); color: var(--warning);">ORDERED</div>
                        <button class="btn btn-primary" onclick="openPODetail('PO-2026-00145')">View Details</button>
                    </div>

                    <!-- PO 2 - Awaiting Approval -->
                    <div class="work-order-item">
                        <div class="wo-priority medium"></div>
                        <div class="wo-details">
                            <div class="wo-title">PO-2026-00144 - Monthly Restock Order</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè¢</span>
                                    <span>RS Components</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üì¶</span>
                                    <span>12 items</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üí∞</span>
                                    <span style="font-weight: 700; color: var(--dark);">¬£2,890.00</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Created: Yesterday</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Requested by: John Smith</span>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem;">
                                <span style="padding: 0.5rem 1rem; background: rgba(255, 179, 0, 0.1); color: var(--warning); border-radius: 8px; font-size: 0.9rem; font-weight: 600;">
                                    ‚è≥ Awaiting Manager Approval
                                </span>
                            </div>
                        </div>
                        <div class="status-badge" style="background: rgba(0, 102, 255, 0.1); color: var(--primary);">PENDING</div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-success btn-small" onclick="approvePO('PO-2026-00144')">Approve</button>
                            <button class="btn btn-primary btn-small" onclick="openPODetail('PO-2026-00144')">View</button>
                        </div>
                    </div>

                    <!-- PO 3 - In Transit -->
                    <div class="work-order-item">
                        <div class="wo-priority low"></div>
                        <div class="wo-details">
                            <div class="wo-title">PO-2026-00143 - Preventive Maintenance Parts</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè¢</span>
                                    <span>Motion Industries</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üì¶</span>
                                    <span>8 items</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üí∞</span>
                                    <span style="font-weight: 700; color: var(--dark);">¬£1,567.50</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Ordered: Feb 12</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üöö</span>
                                    <span style="color: var(--success); font-weight: 600;">In Transit - Arrives Tomorrow</span>
                                </div>
                            </div>
                            <div style="margin-top: 0.75rem;">
                                <span style="padding: 0.5rem 1rem; background: var(--gray-100); border-radius: 8px; font-size: 0.85rem;">
                                    üìç Tracking: 1Z999AA10123456784
                                </span>
                            </div>
                        </div>
                        <div class="status-badge" style="background: rgba(255, 179, 0, 0.1); color: var(--warning);">IN TRANSIT</div>
                        <button class="btn btn-primary" onclick="openPODetail('PO-2026-00143')">Track Order</button>
                    </div>

                    <!-- PO 4 - Received -->
                    <div class="work-order-item">
                        <div class="wo-priority low"></div>
                        <div class="wo-details">
                            <div class="wo-title">PO-2026-00142 - Line 3 Repair Parts</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè¢</span>
                                    <span>Local Supplier - BearingMax</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üì¶</span>
                                    <span>5 items</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üí∞</span>
                                    <span style="font-weight: 700; color: var(--dark);">¬£532.00</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Received: Today, 8:45 AM</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span style="color: var(--success); font-weight: 600;">Inventory Updated</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-badge completed">RECEIVED</div>
                        <button class="btn btn-secondary btn-small" onclick="openPODetail('PO-2026-00142')">View Details</button>
                    </div>
                </div>
            </div>

            <!-- Spending Analysis -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">Spending Analysis</h2>
                    <select class="form-select" style="width: 200px;">
                        <option>This Month</option>
                        <option>Last 30 Days</option>
                        <option>Last 90 Days</option>
                        <option>Year to Date</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    <!-- By Vendor -->
                    <div>
                        <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--dark);">Spending by Vendor</h3>
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Grainger</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£4,532</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">RS Components</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£3,890</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Motion Industries</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£2,145</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Local Suppliers</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£2,280</span>
                            </div>
                        </div>
                    </div>

                    <!-- By Category -->
                    <div>
                        <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--dark);">Spending by Category</h3>
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Bearings</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£3,245</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Belts & Chains</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£2,890</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Sensors</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£2,567</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Electrical</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£4,145</span>
                            </div>
                        </div>
                    </div>

                    <!-- By Budget Code -->
                    <div>
                        <h3 style="font-size: 1rem; font-weight: 700; margin-bottom: 1rem; color: var(--dark);">Spending by Budget Code</h3>
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Emergency Repairs</span>
                                <span class="metric-value" style="font-size: 1.2rem; color: var(--danger);">¬£5,234</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Maintenance Budget</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£4,567</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Line Operating</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£2,346</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Capital Projects</span>
                                <span class="metric-value" style="font-size: 1.2rem;">¬£700</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Permits Tab -->
        <div id="permits" class="tab-content">
            <!-- Active Permits Summary -->
            <div class="stats-grid" id="permitStatsGrid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-label">Active Permits</div>
                    <div class="stat-value" id="permitStatActive">4</div>
                    <div class="stat-change positive" id="permitStatActiveNote">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Hot Work Permits</div>
                    <div class="stat-value" id="permitStatHW">1</div>
                    <div class="stat-change" id="permitStatHWNote">‚Äî</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Contractor Permits</div>
                    <div class="stat-value" id="permitStatCP">3</div>
                    <div class="stat-change positive" id="permitStatCPNote">All valid</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Closed (Archived)</div>
                    <div class="stat-value" id="permitStatClosed">0</div>
                    <div class="stat-change" id="permitStatClosedNote">Available for audit</div>
                </div>
            </div>

            <!-- Permit Filter Bar -->
            <div class="card" style="margin-bottom: 2rem;">
                <div style="padding: 1rem; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <span style="font-weight: 600; color: var(--dark);">View:</span>
                    <button class="btn btn-small" id="permitFilterActive" onclick="filterPermits('active')" style="background: var(--primary); color: white;">Active Permits</button>
                    <button class="btn btn-secondary btn-small" id="permitFilterClosed" onclick="filterPermits('closed')">Closed / Archived</button>
                    <button class="btn btn-secondary btn-small" id="permitFilterAll" onclick="filterPermits('all')">All Permits</button>
                    <div style="flex:1;"></div>
                    <div class="form-group" style="margin-bottom:0;">
                        <select class="form-select" id="permitFilterType" onchange="filterPermits(currentPermitFilter)" style="min-width:160px;">
                            <option value="">All Types</option>
                            <option value="hotwork">Hot Work Only</option>
                            <option value="contractor">Contractor Only</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Hot Work Permits -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üî• Hot Work Permits</h2>
                    <button class="btn btn-primary" onclick="openModal('hotWorkPermitModal')">+ Issue Hot Work Permit</button>
                </div>

                <div class="work-orders-list" id="hotWorkList">
                    <div class="work-order-item" style="border-left: 6px solid var(--danger);">
                        <div class="wo-priority high"></div>
                        <div class="wo-details">
                            <div class="wo-title">üî• Welding Work - Line 3 Filler Repair</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>Production Floor - Line 3</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Mike Johnson</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Valid until: 5:00 PM today</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚è±Ô∏è</span>
                                    <span style="color: var(--danger); font-weight: 600;">Expires in 3 hours</span>
                                </div>
                            </div>
                            <div class="wo-meta" style="margin-top: 0.5rem;">
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Fire extinguisher on-site</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Fire watch assigned</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Area cleared</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-badge in-progress">Active</div>
                        <button class="btn btn-danger" onclick="closePermit('hotwork', 1)">Close Permit</button>
                    </div>
                </div>

                <div class="empty-state" style="padding: 2rem;">
                    <p style="color: var(--gray-600); font-size: 0.95rem;">
                        ‚ö†Ô∏è Hot work permits are required for welding, cutting, grinding, or any work that produces sparks or flames. 
                        Always ensure fire watch is in place and proper safety equipment is available.
                    </p>
                </div>
            </div>

            <!-- Contractor Work Permits -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë∑ Contractor Work Permits</h2>
                    <button class="btn btn-primary" onclick="openModal('contractorPermitModal')">+ Issue Contractor Permit</button>
                </div>

                <div class="work-orders-list" id="contractorPermitsList">
                    <div class="work-order-item">
                        <div class="wo-priority low"></div>
                        <div class="wo-details">
                            <div class="wo-title">HVAC System Maintenance - XYZ Mechanical</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè¢</span>
                                    <span>XYZ Mechanical Services</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Supervisor: Tom Davis</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Valid: Feb 13-14, 2026</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚è±Ô∏è</span>
                                    <span>Expires tomorrow</span>
                                </div>
                            </div>
                            <div class="wo-meta" style="margin-top: 0.5rem;">
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Safety orientation completed</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Insurance verified</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Tools inspected</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-badge in-progress">Active</div>
                        <button class="btn btn-primary" onclick="openPermitDetail('contractor', 1)">View Details</button>
                    </div>

                    <div class="work-order-item">
                        <div class="wo-priority low"></div>
                        <div class="wo-details">
                            <div class="wo-title">Electrical Panel Upgrade - ABC Electric</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè¢</span>
                                    <span>ABC Electric Co.</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Supervisor: Lisa Chen</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Valid: Feb 13-15, 2026</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚è±Ô∏è</span>
                                    <span>Expires in 2 days</span>
                                </div>
                            </div>
                            <div class="wo-meta" style="margin-top: 0.5rem;">
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Safety orientation completed</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Insurance verified</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Lock-out tag-out trained</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-badge in-progress">Active</div>
                        <button class="btn btn-primary" onclick="openPermitDetail('contractor', 2)">View Details</button>
                    </div>

                    <div class="work-order-item">
                        <div class="wo-priority medium"></div>
                        <div class="wo-details">
                            <div class="wo-title">Fire Suppression System Inspection - SafeGuard Fire</div>
                            <div class="wo-meta">
                                <div class="wo-meta-item">
                                    <span>üè¢</span>
                                    <span>SafeGuard Fire Protection</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Supervisor: Robert Martinez</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üìÖ</span>
                                    <span>Valid: Feb 13, 2026</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚è±Ô∏è</span>
                                    <span style="color: var(--warning); font-weight: 600;">Expires tonight</span>
                                </div>
                            </div>
                            <div class="wo-meta" style="margin-top: 0.5rem;">
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Safety orientation completed</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Insurance verified</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚úÖ</span>
                                    <span>Equipment certified</span>
                                </div>
                            </div>
                        </div>
                        <div class="status-badge in-progress">Active</div>
                        <button class="btn btn-primary" onclick="openPermitDetail('contractor', 3)">View Details</button>
                    </div>
                </div>
            </div>

            <!-- Closed Permits Archive -->
            <div class="card" id="closedPermitsCard" style="margin-top: 2rem; display: none;">
                <div class="card-header">
                    <h2 class="card-title">üìÅ Closed Permits Archive</h2>
                    <span style="font-size: 0.9rem; color: var(--gray-600);">For audit and compliance records</span>
                </div>

                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="closedPermitSearch" placeholder="Search closed permits..." oninput="filterPermits(currentPermitFilter)">
                </div>

                <div id="closedPermitsList"></div>
            </div>
        </div>

        <!-- Preventive Maintenance Tab -->
        <div id="pm" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Preventive Maintenance Schedule</h2>
                    <button class="btn btn-primary" onclick="openModal('addPMModal')">+ Schedule PM</button>
                </div>

                <div class="search-bar">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" placeholder="Search PM tasks by equipment or description...">
                </div>

                <div class="filter-bar">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="pmFilterStatus" style="min-width:160px;">
                            <option value="">All</option>
                            <option value="completed">Complete</option>
                            <option value="scheduled">Scheduled</option>
                            <option value="unscheduled">Unscheduled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Equipment</label>
                        <select class="form-select" id="pmFilterEquipment" style="min-width:180px;"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">From</label>
                        <input type="date" class="form-input" id="pmFilterFrom" style="min-width:140px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To</label>
                        <input type="date" class="form-input" id="pmFilterTo" style="min-width:140px;">
                    </div>
                    <button class="btn btn-secondary" onclick="filterPMs()" style="align-self:flex-end;">Apply Filter</button>
                    <button class="btn btn-secondary" onclick="clearPMFilter()" style="align-self:flex-end;">Clear</button>
                </div>

                <div class="pm-list" id="pmList">
                    <div class="pm-item overdue">
                        <div class="pm-info">
                            <div class="pm-title">üî• Fire Alarm System - Weekly Test</div>
                            <div class="pm-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>Facility-Wide</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üîÑ</span>
                                    <span>Weekly (Every Monday)</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚è±Ô∏è</span>
                                    <span>15 minutes</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Mike Johnson</span>
                                </div>
                            </div>
                        </div>
                        <div class="due-date overdue">
                            Overdue by 1 day
                        </div>
                        <button class="btn btn-danger" onclick="completePM('fire-alarm')">Complete Now</button>
                    </div>

                    <div class="pm-item due-soon">
                        <div class="pm-info">
                            <div class="pm-title">üí° Emergency Lighting - Monthly Test</div>
                            <div class="pm-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>All Emergency Exits</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üîÑ</span>
                                    <span>Monthly (1st of month)</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚è±Ô∏è</span>
                                    <span>45 minutes</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Sarah Williams</span>
                                </div>
                            </div>
                        </div>
                        <div class="due-date due-soon">
                            Due in 2 days
                        </div>
                        <button class="btn btn-primary" onclick="schedulePM('emergency-lighting')">Schedule</button>
                    </div>

                    <div class="pm-item overdue">
                        <div class="pm-info">
                            <div class="pm-title">Line 3 Filler - Monthly Lubrication</div>
                            <div class="pm-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>Line 3 Filler</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üîÑ</span>
                                    <span>Monthly</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚è±Ô∏è</span>
                                    <span>30 minutes</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Sarah Williams</span>
                                </div>
                            </div>
                        </div>
                        <div class="due-date overdue">
                            Overdue by 2 days
                        </div>
                        <button class="btn btn-danger" onclick="completePM('line3-lube')">Complete Now</button>
                    </div>

                    <div class="pm-item due-soon">
                        <div class="pm-info">
                            <div class="pm-title">Line 1 Conveyor - Belt Tension Check</div>
                            <div class="pm-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>Line 1 Conveyor</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üîÑ</span>
                                    <span>Weekly</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚è±Ô∏è</span>
                                    <span>15 minutes</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>John Smith</span>
                                </div>
                            </div>
                        </div>
                        <div class="due-date due-soon">
                            Due tomorrow
                        </div>
                        <button class="btn btn-primary" onclick="schedulePM('line1-belt')">Schedule</button>
                    </div>

                    <div class="pm-item">
                        <div class="pm-info">
                            <div class="pm-title">Line 2 Mixer - Gearbox Oil Change</div>
                            <div class="pm-meta">
                                <div class="wo-meta-item">
                                    <span>üè≠</span>
                                    <span>Line 2 Mixer</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üîÑ</span>
                                    <span>Quarterly</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>‚è±Ô∏è</span>
                                    <span>1 hour</span>
                                </div>
                                <div class="wo-meta-item">
                                    <span>üë§</span>
                                    <span>Mike Johnson</span>
                                </div>
                            </div>
                        </div>
                        <div class="due-date upcoming">
                            Due in 5 days
                        </div>
                        <button class="btn btn-primary" onclick="schedulePM('line2-oil')">Schedule</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Activity Log Tab -->
        <div id="dailyLog" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Today's Activity Log</h2>
                    <input type="date" class="form-input" style="width: 200px;" value="2026-02-13">
                </div>

                <div class="activity-timeline">
                    <div class="activity-item">
                        <div class="activity-dot completed"></div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">‚úÖ Work Order Completed</div>
                                <div class="activity-time">14:30</div>
                            </div>
                            <div class="activity-description">
                                Line 1 Conveyor - Belt Replacement completed successfully
                            </div>
                            <div class="activity-meta">
                                <span>üë§ John Smith</span>
                                <span>‚è±Ô∏è Duration: 2.5 hours</span>
                                <span>üîß Parts Used: 1 conveyor belt</span>
                            </div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-dot in-progress"></div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">üîß Work Order In Progress</div>
                                <div class="activity-time">11:15</div>
                            </div>
                            <div class="activity-description">
                                Line 4 Mixer - Bearing Noise Investigation started
                            </div>
                            <div class="activity-meta">
                                <span>üë§ Mike Johnson</span>
                                <span>‚è±Ô∏è Elapsed: 3 hours 45 minutes</span>
                            </div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-dot created"></div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">üìã New Work Order Created</div>
                                <div class="activity-time">09:20</div>
                            </div>
                            <div class="activity-description">
                                Line 3 Filler - Motor Overheating (High Priority)
                            </div>
                            <div class="activity-meta">
                                <span>üë§ Unassigned</span>
                                <span>üì∏ 2 photos attached</span>
                            </div>
                        </div>
                    </div>

                    <div class="activity-item">
                        <div class="activity-dot completed"></div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <div class="activity-title">‚úÖ PM Task Completed</div>
                                <div class="activity-time">08:00</div>
                            </div>
                            <div class="activity-description">
                                Line 2 Packaging - Daily Safety Inspection completed
                            </div>
                            <div class="activity-meta">
                                <span>üë§ Sarah Williams</span>
                                <span>‚è±Ô∏è Duration: 20 minutes</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Daily Summary</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Work Orders Created</div>
                        <div class="stat-value">3</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Work Orders Completed</div>
                        <div class="stat-value">2</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">PM Tasks Completed</div>
                        <div class="stat-value">1</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Downtime</div>
                        <div class="stat-value">1.5h</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics & Reports Tab -->
        <div id="analytics" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Analytics & Reports</h2>
                    <div style="display: flex; gap: 1rem;">
                        <select class="form-select" style="width: 200px;">
                            <option>Last 7 Days</option>
                            <option>Last 30 Days</option>
                            <option>Last 90 Days</option>
                            <option>This Year</option>
                        </select>
                        <div style="position:relative;display:inline-block;">
                            <button class="btn btn-secondary" onclick="toggleExportMenu()">Export Report ‚ñæ</button>
                            <div id="exportMenu" style="display:none;position:absolute;top:100%;right:0;margin-top:4px;background:white;border:1px solid var(--gray-300);border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:100;min-width:200px;">
                                <div style="padding:0.5rem 0;">
                                    <div style="padding:0.5rem 1rem;font-weight:700;font-size:0.85rem;color:var(--gray-600);">Export as CSV</div>
                                    <button onclick="exportCSV('workOrders')" style="display:block;width:100%;text-align:left;padding:0.5rem 1rem;border:none;background:none;cursor:pointer;font-size:0.9rem;">Work Orders</button>
                                    <button onclick="exportCSV('equipment')" style="display:block;width:100%;text-align:left;padding:0.5rem 1rem;border:none;background:none;cursor:pointer;font-size:0.9rem;">Equipment</button>
                                    <button onclick="exportCSV('parts')" style="display:block;width:100%;text-align:left;padding:0.5rem 1rem;border:none;background:none;cursor:pointer;font-size:0.9rem;">Parts Inventory</button>
                                    <button onclick="exportCSV('breakdowns')" style="display:block;width:100%;text-align:left;padding:0.5rem 1rem;border:none;background:none;cursor:pointer;font-size:0.9rem;">Breakdowns</button>
                                    <button onclick="exportCSV('pm')" style="display:block;width:100%;text-align:left;padding:0.5rem 1rem;border:none;background:none;cursor:pointer;font-size:0.9rem;">PM Schedule</button>
                                    <button onclick="exportCSV('purchaseOrders')" style="display:block;width:100%;text-align:left;padding:0.5rem 1rem;border:none;background:none;cursor:pointer;font-size:0.9rem;">Purchase Orders</button>
                                    <div style="border-top:1px solid var(--gray-200);margin:0.25rem 0;"></div>
                                    <button onclick="exportFullReport()" style="display:block;width:100%;text-align:left;padding:0.5rem 1rem;border:none;background:none;cursor:pointer;font-size:0.9rem;font-weight:600;">Full Maintenance Report</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analytics-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Equipment Downtime by Line</div>
                            <div class="chart-subtitle">Total hours this month</div>
                        </div>
                        <canvas id="downtimeChart" style="max-height: 250px;"></canvas>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Work Order Status</div>
                            <div class="chart-subtitle">Current distribution</div>
                        </div>
                        <canvas id="workOrderChart" style="max-height: 250px;"></canvas>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">PM Compliance Trend</div>
                            <div class="chart-subtitle">Last 6 months</div>
                        </div>
                        <canvas id="complianceChart" style="max-height: 250px;"></canvas>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Top 5 Problem Equipment</div>
                            <div class="chart-subtitle">By work order count (30 days)</div>
                        </div>
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Line 3 Filler</span>
                                <span class="metric-value" style="font-size: 1.2rem;">8</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Line 4 Packaging</span>
                                <span class="metric-value" style="font-size: 1.2rem;">4</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Line 1 Conveyor</span>
                                <span class="metric-value" style="font-size: 1.2rem;">3</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Line 2 Mixer</span>
                                <span class="metric-value" style="font-size: 1.2rem;">2</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Compressor Unit</span>
                                <span class="metric-value" style="font-size: 1.2rem;">2</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Maintenance Cost Breakdown</div>
                            <div class="chart-subtitle">This month</div>
                        </div>
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Labor Costs</span>
                                <span class="metric-value">¬£12,450</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Parts Costs</span>
                                <span class="metric-value">¬£8,230</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Contractor Costs</span>
                                <span class="metric-value">¬£3,500</span>
                            </div>
                            <div class="metric-item" style="background: var(--primary); color: white;">
                                <span class="metric-label" style="color: white;">Total</span>
                                <span class="metric-value" style="color: white;">¬£24,180</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">PM Completion Rate</div>
                            <div class="chart-subtitle">This month</div>
                        </div>
                        <div class="metric-list">
                            <div class="metric-item">
                                <span class="metric-label">Completed On Time</span>
                                <span class="metric-value" style="color: var(--success);">47</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Completed Late</span>
                                <span class="metric-value" style="color: var(--warning);">3</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label">Currently Overdue</span>
                                <span class="metric-value" style="color: var(--danger);">1</span>
                            </div>
                            <div class="metric-item" style="background: var(--success); color: white;">
                                <span class="metric-label" style="color: white;">Compliance Rate</span>
                                <span class="metric-value" style="color: white;">94%</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Parts Stock Forecast</div>
                            <div class="chart-subtitle">Parts at risk of depletion</div>
                        </div>
                        <div class="metric-list" id="partsAtRiskList">
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">MTTR & MTBF</div>
                            <div class="chart-subtitle">Mean Time to Repair / Between Failures</div>
                        </div>
                        <div class="metric-list" id="mttrMtbfList">
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Technician Workload</div>
                            <div class="chart-subtitle">Active assignments per engineer</div>
                        </div>
                        <div class="metric-list" id="techWorkloadList">
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Equipment Health Scores</div>
                            <div class="chart-subtitle">Composite score (0-100)</div>
                        </div>
                        <div class="metric-list" id="equipHealthList">
                        </div>
                    </div>

                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Labor Costs</div>
                            <div class="chart-subtitle">Based on tracked time</div>
                        </div>
                        <div class="metric-list" id="laborCostList">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Reactive Maintenance Tab -->
        <div id="reactive" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">&#9889; Reactive Maintenance Log</h2>
                    <button class="btn btn-primary" onclick="openModal('logBreakdownModal')">+ Log Breakdown</button>
                </div>
                <div class="filter-bar">
                    <div class="form-group">
                        <label class="form-label">Machine</label>
                        <select class="form-select" id="brFilterMachine" style="min-width:180px;"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="brFilterStatus" style="min-width:140px;">
                            <option value="">All Statuses</option>
                            <option value="resolved">Resolved</option>
                            <option value="in-progress">In Progress</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">From</label>
                        <input type="date" class="form-input" id="brFilterFrom" style="min-width:140px;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">To</label>
                        <input type="date" class="form-input" id="brFilterTo" style="min-width:140px;">
                    </div>
                    <button class="btn btn-secondary" onclick="filterBreakdowns()" style="align-self:flex-end;">Apply Filter</button>
                    <button class="btn btn-secondary" onclick="clearBreakdownFilter()" style="align-self:flex-end;">Clear</button>
                </div>
                <div id="breakdownsList"></div>
            </div>
        </div>

        <!-- Maintenance Calendar Tab -->
        <div id="calendar" class="tab-content">
            <div class="card">
                <div class="cal-header">
                    <div style="display:flex;align-items:center;gap:0.75rem;">
                        <button class="cal-nav-btn" onclick="prevPeriod()">&#8249;</button>
                        <span class="cal-title" id="calTitle"></span>
                        <button class="cal-nav-btn" onclick="nextPeriod()">&#8250;</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.75rem;">
                        <div class="cal-view-toggle">
                            <button class="cal-view-btn active" id="calMonthBtn" onclick="toggleCalendarView('month')">Month</button>
                            <button class="cal-view-btn" id="calWeekBtn" onclick="toggleCalendarView('week')">Week</button>
                        </div>
                        <button class="btn btn-primary" onclick="openModal('addCalendarEventModal')">+ Add Job</button>
                    </div>
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;font-size:0.82rem;align-items:center;">
                    <span style="display:flex;align-items:center;gap:0.3rem;"><span style="width:12px;height:12px;border-radius:3px;background:#0066FF;display:inline-block;"></span> Weekly PM</span>
                    <span style="display:flex;align-items:center;gap:0.3rem;"><span style="width:12px;height:12px;border-radius:3px;background:#7C3AED;display:inline-block;"></span> Monthly PM</span>
                    <span style="display:flex;align-items:center;gap:0.3rem;"><span style="width:12px;height:12px;border-radius:3px;background:#FF3D00;display:inline-block;"></span> Major Service</span>
                    <span style="display:flex;align-items:center;gap:0.3rem;"><span style="width:12px;height:12px;border-radius:3px;background:#FFB300;display:inline-block;"></span> Inspection</span>
                    <span style="display:flex;align-items:center;gap:0.3rem;"><span style="width:12px;height:12px;border-radius:3px;background:#8B0000;display:inline-block;"></span> Shutdown</span>
                </div>
                <div id="calendarView"></div>
            </div>
        </div>

        <!-- My Tasks / Engineer Dashboard -->
        <div id="myTasks" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" id="myTasksTitle">My Assigned Tasks</h2>
                </div>
                <div style="margin-bottom:1rem;">
                    <label style="font-weight:600;margin-right:0.5rem;">Viewing tasks for:</label>
                    <select class="form-select" id="myTasksEngineerSelect" onchange="renderEngineerDashboard()" style="display:inline-block;width:auto;min-width:180px;">
                        <option value="John Smith">John Smith</option>
                        <option value="Mike Johnson">Mike Johnson</option>
                        <option value="Sarah Williams">Sarah Williams</option>
                    </select>
                </div>

                <div style="margin-bottom:1.5rem;">
                    <h3 style="font-size:1rem;font-weight:700;margin-bottom:0.75rem;color:var(--primary);">Work Orders</h3>
                    <div id="myTasksWOList"></div>
                </div>

                <div>
                    <h3 style="font-size:1rem;font-weight:700;margin-bottom:0.75rem;color:var(--primary);">Preventive Maintenance</h3>
                    <div id="myTasksPMList"></div>
                </div>
            </div>
        </div>

        <!-- Work Requests Tab -->
        <div id="workRequests" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Maintenance Requests</h2>
                    <button class="btn btn-primary" onclick="openModal('submitRequestModal')">+ Submit Request</button>
                </div>
                <p style="color:var(--gray-600);margin-bottom:1rem;">Submit maintenance requests for equipment issues. Managers and admins can approve requests to create work orders.</p>
                <div class="filter-bar" style="margin-bottom:1rem;">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="reqFilterStatus" onchange="filterWorkRequests()" style="min-width:150px;">
                            <option value="">All Requests</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="declined">Declined</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Urgency</label>
                        <select class="form-select" id="reqFilterUrgency" onchange="filterWorkRequests()" style="min-width:150px;">
                            <option value="">All Urgencies</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="form-group" style="display:flex;align-items:flex-end;">
                        <button class="btn btn-secondary btn-small" onclick="clearRequestFilter()">Clear</button>
                    </div>
                </div>
                <div id="workRequestsList"></div>
            </div>
        </div>

    <!-- Submit Request Modal -->
    <div id="submitRequestModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Submit Maintenance Request</h2>
            </div>
            <div class="modal-body">
                <form id="requestForm">
                    <div class="form-group">
                        <label class="form-label">Equipment / Area *</label>
                        <select class="form-select" id="requestEquipment">
                            <option value="">Select equipment...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description of Issue *</label>
                        <textarea class="form-textarea" id="requestDescription" placeholder="Describe the problem, what you noticed, when it started..." rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Urgency</label>
                        <select class="form-select" id="requestUrgency">
                            <option value="low">Low ‚Äî Can wait for scheduled maintenance</option>
                            <option value="medium" selected>Medium ‚Äî Should be addressed soon</option>
                            <option value="high">High ‚Äî Affecting production / safety risk</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Name</label>
                        <input type="text" class="form-input" id="requestSubmitter" placeholder="e.g., John from Packaging">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('submitRequestModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitWorkRequest()">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- New Work Order Modal -->
    <div id="workOrderModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create New Work Order</h2>
            </div>
            <div class="modal-body">
                <form id="workOrderForm">
                    <div class="form-group">
                        <label class="form-label">Equipment *</label>
                        <select class="form-select" id="woEquipment" required>
                            <option value="">Select equipment...</option>
                            <option value="Line 1 - Conveyor System">Line 1 - Conveyor System</option>
                            <option value="Line 2 - Industrial Mixer">Line 2 - Industrial Mixer</option>
                            <option value="Line 3 - Filler Machine">Line 3 - Filler Machine</option>
                            <option value="Line 4 - Packaging Unit">Line 4 - Packaging Unit</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Title *</label>
                        <input type="text" class="form-input" id="woTitle" placeholder="e.g., Motor overheating issue" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <textarea class="form-textarea" id="woDescription" placeholder="Describe the issue in detail..." required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Priority *</label>
                            <select class="form-select" id="woPriority" required>
                                <option value="">Select priority...</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Assign To Engineer</label>
                            <select class="form-select" id="woAssignTo">
                                <option value="">Unassigned</option>
                                <option value="John Smith">John Smith</option>
                                <option value="Mike Johnson">Mike Johnson</option>
                                <option value="Sarah Williams">Sarah Williams</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Attach Photos</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="file-upload-icon">üì∑</div>
                            <div class="file-upload-text">Drag & drop photos here or click to browse</div>
                            <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
                        </div>
                        <div class="file-preview" id="filePreview"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('workOrderModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitWorkOrder()">Create Work Order</button>
            </div>
        </div>
    </div>

    <!-- Add Equipment Modal -->
    <div id="equipmentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Equipment</h2>
            </div>
            <div class="modal-body">
                <form id="equipmentForm">
                    <div class="form-group">
                        <label class="form-label">Equipment Name *</label>
                        <input type="text" class="form-input" id="addEquipName" placeholder="e.g., Line 5 - Filler Machine" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Equipment ID *</label>
                        <input type="text" class="form-input" id="addEquipId" placeholder="e.g., EQ-FL-005" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Manufacturer</label>
                            <input type="text" class="form-input" id="addManufacturer" placeholder="e.g., FoodTech Pro">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Model Number</label>
                            <input type="text" class="form-input" id="addModel" placeholder="e.g., FT-500X">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Location *</label>
                            <input type="text" class="form-input" id="addLocation" placeholder="e.g., Production Floor - Line 5" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Install Date</label>
                            <input type="date" class="form-input" id="addInstallDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status *</label>
                            <select class="form-select" id="addEquipStatus">
                                <option value="operational">Operational</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="down">Down</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Criticality</label>
                            <select class="form-select" id="addEquipCriticality">
                                <option value="A">A ‚Äî Critical</option>
                                <option value="B" selected>B ‚Äî Important</option>
                                <option value="C">C ‚Äî Low</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="border-top:1px solid var(--gray-200);padding-top:1rem;margin-top:0.5rem;">
                        <label class="form-label">Warranty Information</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Warranty Expiry</label>
                                <input type="date" class="form-input" id="addWarrantyExpiry">
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Warranty Provider</label>
                                <input type="text" class="form-input" id="addWarrantyProvider" placeholder="e.g., FoodTech Pro">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Warranty Notes</label>
                            <input type="text" class="form-input" id="addWarrantyNotes" placeholder="e.g., 3-year parts warranty">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="addEquipNotes" placeholder="Any additional information..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('equipmentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitEquipment()">Add Equipment</button>
            </div>
        </div>
    </div>

    <!-- Hot Work Permit Modal -->
    <div id="hotWorkPermitModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">üî• Issue Hot Work Permit</h2>
            </div>
            <div class="modal-body">
                <form id="hotWorkPermitForm">
                    <div class="form-group">
                        <label class="form-label">Work Description *</label>
                        <input type="text" class="form-input" id="hwDescription" placeholder="e.g., Welding repair on Line 3 filler" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Location *</label>
                        <input type="text" class="form-input" id="hwLocation" placeholder="e.g., Production Floor - Line 3" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Assigned Engineer *</label>
                            <select class="form-select" id="hwEngineer" required>
                                <option value="">Select engineer...</option>
                                <option value="John Smith">John Smith</option>
                                <option value="Mike Johnson">Mike Johnson</option>
                                <option value="Sarah Williams">Sarah Williams</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fire Watch Person *</label>
                            <input type="text" class="form-input" id="hwFireWatch" placeholder="Name of fire watch" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Time *</label>
                            <input type="time" class="form-input" id="hwStartTime" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">End Time *</label>
                            <input type="time" class="form-input" id="hwEndTime" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Safety Checklist *</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>Fire extinguisher is on-site and accessible</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>Work area has been cleared of flammable materials</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>Fire watch personnel assigned and briefed</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>Hot work equipment inspected and in good condition</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>Emergency procedures reviewed with all personnel</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-textarea" placeholder="Any special precautions or requirements..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('hotWorkPermitModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitHotWorkPermit()">Issue Permit</button>
            </div>
        </div>
    </div>

    <!-- Contractor Permit Modal -->
    <div id="contractorPermitModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">üë∑ Issue Contractor Permit</h2>
            </div>
            <div class="modal-body">
                <form id="contractorPermitForm">
                    <div class="form-group">
                        <label class="form-label">Work Description *</label>
                        <input type="text" class="form-input" id="cpDescription" placeholder="e.g., HVAC system maintenance" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Company Name *</label>
                            <input type="text" class="form-input" id="cpCompany" placeholder="e.g., XYZ Mechanical Services" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Supervisor Name *</label>
                            <input type="text" class="form-input" id="cpSupervisor" placeholder="e.g., Tom Davis" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Supervisor Phone *</label>
                            <input type="tel" class="form-input" id="cpPhone" placeholder="e.g., (555) 123-4567" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Number of Workers *</label>
                            <input type="number" class="form-input" id="cpWorkers" min="1" placeholder="e.g., 3" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Work Location *</label>
                        <input type="text" class="form-input" id="cpLocation" placeholder="e.g., Mechanical Room, Production Floor" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Start Date *</label>
                            <input type="date" class="form-input" id="cpStartDate" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">End Date *</label>
                            <input type="date" class="form-input" id="cpEndDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Insurance Certificate Number *</label>
                        <input type="text" class="form-input" id="cpInsurance" placeholder="e.g., INS-2024-12345" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Compliance Checklist *</label>
                        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 0.5rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>Safety orientation completed</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>Insurance certificate verified and on file</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>Emergency procedures explained</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>PPE requirements communicated</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" required>
                                <span>Tools and equipment inspected</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Scope of Work</label>
                        <textarea class="form-textarea" placeholder="Detailed description of work to be performed..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('contractorPermitModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitContractorPermit()">Issue Permit</button>
            </div>
        </div>
    </div>

    <!-- Work Order Detail Modal -->
    <div id="workOrderDetailModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="woDetailTitle">Work Order Details</h2>
            </div>
            <div class="modal-body">
                <div id="woDetailContent">
                    <!-- Content will be dynamically loaded -->
                    <div class="form-group">
                        <label class="form-label">Work Order ID</label>
                        <div style="font-family: 'IBM Plex Mono', monospace; font-size: 1.1rem; color: var(--dark); font-weight: 600;">
                            <span id="woDetailId">WO-2024-001</span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Equipment</label>
                            <div style="font-weight: 600; color: var(--dark);" id="woDetailEquipment">Line 3 Filler</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Priority</label>
                            <div id="woDetailPriority">
                                <span class="status-badge" style="background: rgba(255, 61, 0, 0.1); color: var(--danger);">HIGH</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <div style="padding: 1rem; background: var(--gray-100); border-radius: 8px; line-height: 1.6;" id="woDetailDescription">
                            Motor temperature reading above normal range. Noticed unusual heat during production run. Requires immediate inspection to prevent potential failure.
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Assigned To</label>
                            <div style="font-weight: 600; color: var(--dark);" id="woDetailAssigned">Unassigned</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <div id="woDetailStatus">
                                <span class="status-badge open">OPEN</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Created</label>
                            <div id="woDetailCreated">Feb 13, 2026 - 9:20 AM</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Created By</label>
                            <div id="woDetailCreatedBy">Sarah Williams</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Attached Photos</label>
                        <div id="woDetailPhotos" style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%23E5E5E5' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='monospace' font-size='20' fill='%23666'%3Eüì∑ Photo 1%3C/text%3E%3C/svg%3E" style="width: 150px; height: 150px; border-radius: 8px; border: 2px solid var(--gray-300); cursor: pointer;">
                            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%23E5E5E5' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='monospace' font-size='20' fill='%23666'%3Eüì∑ Photo 2%3C/text%3E%3C/svg%3E" style="width: 150px; height: 150px; border-radius: 8px; border: 2px solid var(--gray-300); cursor: pointer;">
                        </div>
                    </div>

                    <div class="form-group" style="border-top:1px solid var(--gray-200);padding-top:1rem;">
                        <label class="form-label">Time Tracking</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Start Time</label>
                                <input type="datetime-local" class="form-input" id="woDetailStartTime">
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Finish Time</label>
                                <input type="datetime-local" class="form-input" id="woDetailFinishTime">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Total Job Time</label>
                                <div id="woDetailTotalJobTime" style="padding:0.5rem 0.75rem;background:var(--gray-100);border-radius:6px;font-weight:600;">‚Äî</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Machine Downtime</label>
                                <input type="text" class="form-input" id="woDetailMachineDowntime" placeholder="e.g., 2.5 hours">
                            </div>
                        </div>
                    </div>

                    <div class="form-group" style="border-top:1px solid var(--gray-200);padding-top:1rem;">
                        <label class="form-label">Comments</label>
                        <div id="woCommentsContainer" style="display:flex;flex-direction:column;gap:0.75rem;max-height:250px;overflow-y:auto;margin-bottom:0.75rem;">
                        </div>
                        <div style="display:flex;gap:0.5rem;">
                            <input type="text" class="form-input" id="woNewComment" placeholder="Add a comment..." style="flex:1;" onkeydown="if(event.key==='Enter'){addWoComment();}">
                            <button type="button" class="btn btn-primary btn-small" onclick="addWoComment()">Post</button>
                        </div>
                    </div>

                    <div class="form-group" style="border-top:1px solid var(--gray-200);padding-top:1rem;">
                        <label class="form-label">Update Status or Reassign</label>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <select class="form-select" id="woUpdateAssign" style="flex: 1; min-width: 200px;">
                                <option value="">Reassign to...</option>
                                <option value="John Smith">John Smith</option>
                                <option value="Mike Johnson">Mike Johnson</option>
                                <option value="Sarah Williams">Sarah Williams</option>
                            </select>
                            <select class="form-select" id="woUpdateStatus" style="flex: 1; min-width: 200px;">
                                <option value="">Change status...</option>
                                <option value="open">Open</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="on-hold">On Hold</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('workOrderDetailModal')">Close</button>
                <button class="btn btn-success" onclick="updateWorkOrder()">Update Work Order</button>
            </div>
        </div>
    </div>

    <!-- Permit Detail Modal -->
    <div id="permitDetailModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="permitDetailTitle">Permit Details</h2>
            </div>
            <div class="modal-body">
                <div id="permitDetailContent">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('permitDetailModal')">Close</button>
                <button class="btn btn-danger" id="permitActionBtn" onclick="revokePermitFromModal()">Close Permit</button>
            </div>
        </div>
    </div>

    <!-- Equipment History Modal -->
    <div id="equipmentHistoryModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="equipHistoryTitle">Equipment History</h2>
            </div>
            <div class="modal-body">
                <div id="equipHistoryContent">
                    <!-- Content will be dynamically loaded -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('equipmentHistoryModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Equipment Edit Modal -->
    <div id="equipmentEditModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Edit Equipment</h2>
            </div>
            <div class="modal-body">
                <form id="equipmentEditForm">
                    <div class="form-group">
                        <label class="form-label">Equipment Name *</label>
                        <input type="text" class="form-input" id="editEquipName" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Equipment ID *</label>
                        <input type="text" class="form-input" id="editEquipId" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Manufacturer</label>
                            <input type="text" class="form-input" id="editManufacturer">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Model Number</label>
                            <input type="text" class="form-input" id="editModel">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Location *</label>
                            <input type="text" class="form-input" id="editLocation" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Install Date</label>
                            <input type="date" class="form-input" id="editInstallDate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="editStatus">
                                <option value="operational">Operational</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="down">Down</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Criticality</label>
                            <select class="form-select" id="editEquipCriticality">
                                <option value="A">A ‚Äî Critical</option>
                                <option value="B">B ‚Äî Important</option>
                                <option value="C">C ‚Äî Low</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group" style="border-top:1px solid var(--gray-200);padding-top:1rem;margin-top:0.5rem;">
                        <label class="form-label">Warranty Information</label>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Warranty Expiry</label>
                                <input type="date" class="form-input" id="editWarrantyExpiry">
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Warranty Provider</label>
                                <input type="text" class="form-input" id="editWarrantyProvider">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size:0.85rem;color:var(--gray-600);">Warranty Notes</label>
                            <input type="text" class="form-input" id="editWarrantyNotes">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="editNotes" placeholder="Any additional information..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('equipmentEditModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveEquipmentEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Part Modal -->
    <div id="addPartModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Part</h2>
            </div>
            <div class="modal-body">
                <form id="addPartForm">
                    <div class="form-group">
                        <label class="form-label">Part Name *</label>
                        <input type="text" class="form-input" id="addPartName" placeholder="e.g., Motor Bearing 6205" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Part Number *</label>
                        <input type="text" class="form-input" id="addPartNumber" placeholder="e.g., PN-MB-6205-001" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-input" id="addPartQty" min="0" placeholder="e.g., 10" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Minimum Stock Level *</label>
                            <input type="number" class="form-input" id="addPartMinStock" min="0" placeholder="e.g., 5" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Location - Shelf *</label>
                            <input type="text" class="form-input" id="addPartShelf" placeholder="e.g., B3" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Location - Bin *</label>
                            <input type="text" class="form-input" id="addPartBin" placeholder="e.g., 12" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="addPartCategory">
                            <option value="">Select category...</option>
                            <option value="bearings">Bearings</option>
                            <option value="belts">Belts & Chains</option>
                            <option value="sensors">Sensors</option>
                            <option value="electrical">Electrical Components</option>
                            <option value="hydraulic">Hydraulic Parts</option>
                            <option value="consumables">Consumables</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Compatible Equipment</label>
                        <div id="partEquipCheckboxes" style="display:flex;flex-direction:column;gap:0.5rem;padding:0.75rem;background:var(--gray-100);border-radius:8px;max-height:150px;overflow-y:auto;">
                        </div>
                    </div>

                    <div class="pro-only-feature">
                        <div class="form-group">
                            <label class="form-label" style="font-weight:700;font-size:1rem;margin-bottom:0.5rem;">Supplier Information</label>
                            <div style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:0.75rem;">
                                <div class="form-row">
                                    <div class="form-group" style="flex:1;">
                                        <label class="form-label">Supplier</label>
                                        <select class="form-select" id="partSupplierName">
                                            <option value="">Select supplier...</option>
                                            <option value="RS Components">RS Components</option>
                                            <option value="Grainger">Grainger</option>
                                            <option value="Motion Industries">Motion Industries</option>
                                            <option value="Local Supplier">Local Supplier</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group" style="flex:1;">
                                        <label class="form-label">Supplier Part No.</label>
                                        <input type="text" class="form-input" id="partSupplierPartNo" placeholder="e.g., 286-3421">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group" style="flex:1;">
                                        <label class="form-label">Price (¬£)</label>
                                        <input type="number" class="form-input" id="partSupplierPrice" step="0.01" min="0" placeholder="e.g., 12.50">
                                    </div>
                                    <div class="form-group" style="flex:1;">
                                        <label class="form-label">Lead Time</label>
                                        <input type="text" class="form-input" id="partSupplierLeadTime" placeholder="e.g., Next day">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary" onclick="addPartSupplier()" style="align-self:flex-start;">+ Add Supplier</button>
                            </div>
                            <div id="partSupplierBuilder"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" placeholder="Any additional information..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addPartModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitAddPart()">Add Part</button>
            </div>
        </div>
    </div>

    <!-- Add PM Modal -->
    <div id="addPMModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Schedule New PM Task</h2>
            </div>
            <div class="modal-body">
                <form id="addPMForm">
                    <div class="form-group">
                        <label class="form-label">PM Task Name *</label>
                        <input type="text" class="form-input" id="pmTaskName" placeholder="e.g., Monthly Lubrication" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Equipment *</label>
                        <select class="form-select" id="pmEquipment" required>
                            <option value="">Select equipment...</option>
                            <option value="Line 1 - Conveyor System">Line 1 - Conveyor System</option>
                            <option value="Line 2 - Industrial Mixer">Line 2 - Industrial Mixer</option>
                            <option value="Line 3 - Filler Machine">Line 3 - Filler Machine</option>
                            <option value="Line 4 - Packaging Unit">Line 4 - Packaging Unit</option>
                            <option value="Facility-Wide">Facility-Wide</option>
                            <option value="All Emergency Exits">All Emergency Exits</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description *</label>
                        <textarea class="form-textarea" id="pmDescription" placeholder="Detailed description of the PM task..." required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Frequency *</label>
                            <select class="form-select" id="pmFrequency" required>
                                <option value="">Select frequency...</option>
                                <option value="Daily">Daily</option>
                                <option value="Weekly">Weekly</option>
                                <option value="Bi-weekly">Bi-weekly</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Semi-annual">Semi-annual</option>
                                <option value="Annual">Annual</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Estimated Duration *</label>
                            <input type="text" class="form-input" id="pmDuration" placeholder="e.g., 30 minutes" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Assign To *</label>
                            <select class="form-select" id="pmAssignTo" required>
                                <option value="">Select engineer...</option>
                                <option value="John Smith">John Smith</option>
                                <option value="Mike Johnson">Mike Johnson</option>
                                <option value="Sarah Williams">Sarah Williams</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Next Due Date *</label>
                            <input type="date" class="form-input" id="pmDueDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Required Parts/Tools</label>
                        <textarea class="form-textarea" id="pmPartsTools" placeholder="List any parts or tools needed..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Checklist Items</label>
                        <p style="font-size:0.85rem;color:var(--gray-500);margin:0 0 0.5rem;">Define the checks an engineer must complete. All items must be ticked off before the task can be marked complete.</p>
                        <div style="display:flex;gap:0.5rem;margin-bottom:0.75rem;">
                            <input type="text" class="form-input" id="pmChecklistInput" placeholder="e.g., Check belt tension" style="flex:1;margin:0;" onkeydown="if(event.key==='Enter'){event.preventDefault();addPMChecklistItem();}">
                            <button type="button" class="btn btn-primary" onclick="addPMChecklistItem()" style="white-space:nowrap;">+ Add</button>
                        </div>
                        <div id="pmChecklistBuilder" style="display:flex;flex-direction:column;gap:0.5rem;"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addPMModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitAddPM()">Schedule PM</button>
            </div>
        </div>
    </div>

    <!-- PM Completion Modal -->
    <div id="completePMModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Complete PM Task</h2>
            </div>
            <div class="modal-body" id="completePMBody">
                <!-- Dynamically populated -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('completePMModal')">Cancel</button>
                <button class="btn btn-primary" id="completePMSubmitBtn" onclick="submitCompletePM()" disabled>Complete Task</button>
            </div>
        </div>
    </div>

    <!-- PM Detail Modal (read-only view of completed checklist) -->
    <div id="pmDetailModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">PM Task Details</h2>
            </div>
            <div class="modal-body" id="pmDetailBody">
                <!-- Dynamically populated -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('pmDetailModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Order Part Modal -->
    <div id="orderPartModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Order Part</h2>
            </div>
            <div class="modal-body">
                <div style="padding: 1rem; background: var(--gray-100); border-radius: 8px; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <div>
                            <div style="font-weight: 700; font-size: 1.1rem; color: var(--dark);" id="orderPartName">Motor Bearing 6205</div>
                            <div style="font-family: 'IBM Plex Mono', monospace; color: var(--gray-600); margin-top: 0.25rem;" id="orderPartNumber">PN-MB-6205-001</div>
                        </div>
                        <div style="font-weight: 700; font-size: 1rem;" id="orderUrgency">Standard Order</div>
                    </div>
                </div>

                <form id="orderPartForm">
                    <div class="form-group">
                        <label class="form-label">Quantity to Order *</label>
                        <input type="number" class="form-input" id="orderQuantity" min="1" placeholder="e.g., 5" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Select Vendor *</label>
                        <select class="form-select" id="orderVendor" required>
                            <option value="">Choose vendor...</option>
                        </select>
                    </div>

                    <div id="orderSupplierPanel"></div>

                    <div class="form-group">
                        <label class="form-label">Delivery Location</label>
                        <select class="form-select">
                            <option value="warehouse">Main Warehouse</option>
                            <option value="maintenance">Maintenance Shop</option>
                            <option value="line1">Line 1 - Direct</option>
                            <option value="line2">Line 2 - Direct</option>
                            <option value="line3">Line 3 - Direct</option>
                            <option value="line4">Line 4 - Direct</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Priority Shipping</label>
                        <select class="form-select">
                            <option value="standard">Standard Shipping</option>
                            <option value="expedited">Expedited (2-day)</option>
                            <option value="overnight">Overnight</option>
                            <option value="same-day">Same Day (if available)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Reason for Order</label>
                        <select class="form-select">
                            <option value="restock">Regular Restock</option>
                            <option value="low-stock">Low Stock Alert</option>
                            <option value="emergency">Emergency Breakdown</option>
                            <option value="pm">Preventive Maintenance</option>
                            <option value="project">Project/Upgrade</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Work Order Number (Optional)</label>
                        <input type="text" class="form-input" placeholder="e.g., WO-2024-001">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Special Instructions / Notes</label>
                        <textarea class="form-textarea" placeholder="Any special delivery instructions or requirements..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Budget Code / Cost Center</label>
                        <select class="form-select">
                            <option value="maintenance">Maintenance Budget</option>
                            <option value="emergency">Emergency Repairs</option>
                            <option value="capital">Capital Projects</option>
                            <option value="line1">Line 1 Operating</option>
                            <option value="line2">Line 2 Operating</option>
                            <option value="line3">Line 3 Operating</option>
                            <option value="line4">Line 4 Operating</option>
                        </select>
                    </div>

                    <div style="padding: 1rem; background: rgba(0, 102, 255, 0.05); border-left: 4px solid var(--primary); border-radius: 8px; margin-top: 1.5rem;">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">üìã What happens after ordering:</div>
                        <div style="font-size: 0.9rem; color: var(--gray-700); line-height: 1.6;">
                            ‚úì Purchase order sent to vendor electronically<br>
                            ‚úì PO number generated for tracking<br>
                            ‚úì Expected delivery date calculated<br>
                            ‚úì Inventory updated with "on order" status<br>
                            ‚úì Email notification sent to requester<br>
                            ‚úì Delivery tracking information provided<br>
                            ‚úì Automatic notification when parts arrive<br>
                            ‚úì Stock levels updated upon receipt
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('orderPartModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitPartOrder()">
                    <span style="margin-right: 0.5rem;">üõí</span> Place Order
                </button>
            </div>
        </div>
    </div>

    <!-- Create PO Modal -->
    <div id="createPOModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create Purchase Order</h2>
            </div>
            <div class="modal-body">
                <form id="createPOForm">
                    <div class="form-group">
                        <label class="form-label">Vendor *</label>
                        <select class="form-select" required>
                            <option value="">Select vendor...</option>
                            <option value="rs">RS Components</option>
                            <option value="grainger">Grainger</option>
                            <option value="motion">Motion Industries</option>
                            <option value="local">Local Supplier - BearingMax</option>
                            <option value="other">Other Vendor</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">PO Type *</label>
                        <select class="form-select" required>
                            <option value="">Select type...</option>
                            <option value="standard">Standard Order</option>
                            <option value="emergency">Emergency Order</option>
                            <option value="blanket">Blanket PO</option>
                            <option value="standing">Standing Order</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Budget Code / Cost Center *</label>
                        <select class="form-select" required>
                            <option value="">Select budget code...</option>
                            <option value="maintenance">Maintenance Budget</option>
                            <option value="emergency">Emergency Repairs</option>
                            <option value="capital">Capital Projects</option>
                            <option value="line1">Line 1 Operating</option>
                            <option value="line2">Line 2 Operating</option>
                            <option value="line3">Line 3 Operating</option>
                            <option value="line4">Line 4 Operating</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Work Order Number (Optional)</label>
                        <input type="text" class="form-input" placeholder="e.g., WO-2024-001">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Delivery Location *</label>
                        <select class="form-select" required>
                            <option value="">Select location...</option>
                            <option value="warehouse">Main Warehouse</option>
                            <option value="maintenance">Maintenance Shop</option>
                            <option value="line1">Line 1 - Direct</option>
                            <option value="line2">Line 2 - Direct</option>
                            <option value="line3">Line 3 - Direct</option>
                            <option value="line4">Line 4 - Direct</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Line Items *</label>
                        <div style="background: var(--gray-100); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem;">
                                <div>Part / Description</div>
                                <div>Qty</div>
                                <div>Unit Price</div>
                                <div>Total</div>
                                <div></div>
                            </div>
                            <div id="poLineItems">
                                <div class="po-line-item" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                                    <input type="text" class="form-input" placeholder="Part name or description" style="margin: 0;">
                                    <input type="number" class="form-input" placeholder="Qty" min="1" style="margin: 0;">
                                    <input type="number" class="form-input" placeholder="¬£0.00" step="0.01" style="margin: 0;">
                                    <input type="text" class="form-input" placeholder="¬£0.00" readonly style="margin: 0; background: var(--gray-200);">
                                    <button type="button" class="btn btn-danger btn-small" onclick="removeLineItem(this)">‚úï</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="addLineItem()" style="margin-top: 0.5rem;">+ Add Line Item</button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Shipping Cost</label>
                            <input type="number" class="form-input" step="0.01" placeholder="¬£0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tax</label>
                            <input type="number" class="form-input" step="0.01" placeholder="¬£0.00">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Expected Delivery Date</label>
                        <input type="date" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Special Instructions / Notes</label>
                        <textarea class="form-textarea" placeholder="Any special requirements or notes..."></textarea>
                    </div>

                    <div style="padding: 1rem; background: var(--gray-100); border-radius: 8px; margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="font-weight: 600;">Subtotal:</span>
                            <span style="font-weight: 600;">¬£0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Shipping:</span>
                            <span>¬£0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Tax:</span>
                            <span>¬£0.00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 0.5rem; border-top: 2px solid var(--gray-300);">
                            <span style="font-weight: 700; font-size: 1.1rem;">Total:</span>
                            <span style="font-weight: 700; font-size: 1.1rem; color: var(--primary);">¬£0.00</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createPOModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitCreatePO()">Create Purchase Order</button>
            </div>
        </div>
    </div>

    <!-- PO Detail Modal -->
    <div id="poDetailModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="poDetailTitle">Purchase Order Details</h2>
            </div>
            <div class="modal-body">
                <div id="poDetailContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('poDetailModal')">Close</button>
                <button class="btn btn-primary" onclick="downloadPOPDF()">üìÑ Download PDF</button>
            </div>
        </div>
    </div>

    <!-- Log Breakdown Modal -->
    <div id="logBreakdownModal" class="modal-overlay">
        <div class="modal" style="max-width:640px;">
            <div class="modal-header">
                <h2 class="modal-title">&#9889; Log Breakdown</h2>
            </div>
            <div class="modal-body">
                <form id="logBreakdownForm">
                    <div class="form-group">
                        <label class="form-label">Machine / Equipment *</label>
                        <select class="form-select" id="brMachine" required></select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-input" id="brDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Time *</label>
                            <input type="time" class="form-input" id="brTime" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fault Description *</label>
                        <textarea class="form-textarea" id="brFaultDesc" rows="3" placeholder="Describe the fault / breakdown in detail..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Root Cause</label>
                        <input type="text" class="form-input" id="brRootCause" placeholder="What caused the fault?">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Assigned Engineer</label>
                            <select class="form-select" id="brEngineer">
                                <option value="">Select engineer...</option>
                                <option>John Smith</option>
                                <option>Mike Johnson</option>
                                <option>Sarah Williams</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Production Loss</label>
                            <input type="text" class="form-input" id="brProductionLoss" placeholder="e.g., 2.5 hours">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="brStatus" onchange="toggleBrResolutionField()" required>
                            <option value="resolved">Resolved</option>
                            <option value="in-progress">In Progress</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div id="brResolutionWrap" class="form-group">
                        <label class="form-label">Resolution / Fix Applied</label>
                        <textarea class="form-textarea" id="brActionTaken" rows="3" placeholder="Describe exactly what was done to fix the fault..."></textarea>
                    </div>
                    <div id="brTimeResolveWrap" class="form-group">
                        <label class="form-label">Time to Resolve</label>
                        <input type="text" class="form-input" id="brTimeToResolve" placeholder="e.g., 1.5 hours">
                    </div>
                    <div class="form-group" id="brRaiseWoWrap">
                        <label style="display:flex;align-items:center;gap:0.6rem;cursor:pointer;font-weight:600;">
                            <input type="checkbox" id="brRaiseWo" style="width:18px;height:18px;">
                            Also raise a Work Order for this breakdown
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('logBreakdownModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitBreakdown()">Log Breakdown</button>
            </div>
        </div>
    </div>

    <!-- Breakdown Detail / Edit Modal -->
    <div id="breakdownDetailModal" class="modal-overlay">
        <div class="modal" style="max-width:640px;">
            <div class="modal-header">
                <h2 class="modal-title" id="brDetailTitle">Breakdown Detail</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Machine / Equipment</label>
                    <select class="form-select" id="brEditMachine"></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="brEditDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Time</label>
                        <input type="time" class="form-input" id="brEditTime">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Fault Description</label>
                    <textarea class="form-textarea" id="brEditFaultDesc" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Root Cause</label>
                    <input type="text" class="form-input" id="brEditRootCause">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Resolved By</label>
                        <select class="form-select" id="brEditEngineer">
                            <option value="">Select engineer...</option>
                            <option>John Smith</option>
                            <option>Mike Johnson</option>
                            <option>Sarah Williams</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Production Loss</label>
                        <input type="text" class="form-input" id="brEditProductionLoss">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="brEditStatus">
                        <option value="resolved">Resolved</option>
                        <option value="in-progress">In Progress</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Resolution / Fix Applied</label>
                    <textarea class="form-textarea" id="brEditActionTaken" rows="3" placeholder="Describe exactly what was done to fix the fault..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Time to Resolve</label>
                    <input type="text" class="form-input" id="brEditTimeToResolve">
                </div>
                <div id="brDetailLinkedWo" style="margin-top:0.5rem;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('breakdownDetailModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveBreakdownEdit()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add Calendar Event Modal -->
    <div id="addCalendarEventModal" class="modal-overlay">
        <div class="modal" style="max-width:540px;">
            <div class="modal-header">
                <h2 class="modal-title">&#128197; Add Planned Job</h2>
            </div>
            <div class="modal-body">
                <form id="addCalendarEventForm">
                    <div class="form-group">
                        <label class="form-label">Job Title *</label>
                        <input type="text" class="form-input" id="calJobTitle" placeholder="e.g., Line 3 Annual Service" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Equipment</label>
                            <select class="form-select" id="calEquipment"></select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="calType">
                                <option value="weekly-pm">Weekly PM</option>
                                <option value="monthly-pm">Monthly PM</option>
                                <option value="major-service">Major Service</option>
                                <option value="inspection">Inspection</option>
                                <option value="shutdown">Factory Shutdown</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date *</label>
                            <input type="date" class="form-input" id="calDate" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Duration</label>
                            <input type="text" class="form-input" id="calDuration" placeholder="e.g., 4 hours">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Assigned To</label>
                            <select class="form-select" id="calAssignedTo">
                                <option value="">Unassigned</option>
                                <option>John Smith</option>
                                <option>Mike Johnson</option>
                                <option>Sarah Williams</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="calStatus">
                                <option value="planned">Planned</option>
                                <option value="in-progress">In Progress</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea class="form-textarea" id="calNotes" rows="2" placeholder="Any additional notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addCalendarEventModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitAddCalendarEvent()">Add Job</button>
            </div>
        </div>
    </div>

    </div><!-- end #appContent -->

    <script>
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // SERVICE WORKER REGISTRATION
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Service Worker registered conditionally after login (Pro tier only)
        // See applyTierRestrictions()

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // TIER ACCESS CONFIGURATION
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var PRO_ONLY_TABS = ['purchaseOrders', 'permits', 'analytics', 'calendar'];
        var currentUserTier = 'essential';

        function hasAccess(tabName) {
            if (currentUserTier === 'pro') return true;
            return PRO_ONLY_TABS.indexOf(tabName) === -1;
        }

        function applyTierRestrictions() {
            console.log('[Cradero] applyTierRestrictions ‚Äî tier:', currentUserTier);
            // Show or hide nav tabs based on access
            var hiddenCount = 0;
            var allTabs = document.querySelectorAll('.nav-tab');
            allTabs.forEach(function(btn) {
                var onclick = btn.getAttribute('onclick') || '';
                var match = onclick.match(/switchTab\('(\w+)'\)/);
                if (!match) return;
                var tabName = match[1];
                if (!hasAccess(tabName)) {
                    btn.style.display = 'none';
                    hiddenCount++;
                } else {
                    btn.style.display = '';
                }
            });
            // Also hide the tab content panels for restricted tabs
            PRO_ONLY_TABS.forEach(function(tabName) {
                var panel = document.getElementById(tabName);
                if (panel) {
                    panel.style.display = hasAccess(tabName) ? '' : 'none';
                }
            });
            console.log('[Cradero] Tabs hidden:', hiddenCount, '/ Total:', allTabs.length);
            // If active tab is locked, switch to Work Orders
            var activeTab = document.querySelector('.tab-content.active');
            if (activeTab && !hasAccess(activeTab.id)) {
                document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
                document.getElementById('workOrders').classList.add('active');
                document.querySelectorAll('.nav-tab').forEach(function(btn) {
                    btn.classList.remove('active');
                    if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'workOrders'")) {
                        btn.classList.add('active');
                    }
                });
            }
            // Toggle body class for CSS-based hiding (parts vendor elements)
            if (currentUserTier === 'essential') {
                document.body.classList.add('tier-essential');
            } else {
                document.body.classList.remove('tier-essential');
            }
            // Register Service Worker only for Pro tier (offline mode)
            if (currentUserTier === 'pro' && 'serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(reg) { console.log('SW registered:', reg.scope); })
                    .catch(function(err) { console.warn('SW registration failed:', err); });
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // DATA PERSISTENCE (localStorage)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var STORAGE_PREFIX = 'cradero_';

        function saveData(key, data) {
            try {
                localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(data));
            } catch (e) {
                console.warn('Storage save failed for ' + key, e);
            }
        }

        function loadData(key, defaultValue) {
            try {
                var stored = localStorage.getItem(STORAGE_PREFIX + key);
                return stored !== null ? JSON.parse(stored) : defaultValue;
            } catch (e) {
                console.warn('Storage load failed for ' + key, e);
                return defaultValue;
            }
        }

        function clearAllData() {
            Object.keys(localStorage)
                .filter(function(k) { return k.startsWith(STORAGE_PREFIX); })
                .forEach(function(k) { localStorage.removeItem(k); });
        }

        function persistAllData() {
            saveData('workOrders', workOrdersData);
            saveData('equipment', equipmentList);
            saveData('parts', partsData);
            saveData('purchaseOrders', purchaseOrdersData);
            saveData('hotWorkPermits', hotWorkPermits);
            saveData('contractorPermits', contractorPermits);
            saveData('closedHotWorkPermits', closedHotWorkPermits);
            saveData('closedContractorPermits', closedContractorPermits);
            saveData('pmSchedule', pmData);
            saveData('breakdowns', breakdownsData);
            saveData('calendarEvents', calendarEvents);
            saveData('nextWoId', nextWoId);
            saveData('nextEquipId', nextEquipId);
            saveData('nextPartId', nextPartId);
            saveData('nextPoId', nextPoId);
            saveData('nextHwId', nextHwId);
            saveData('nextCpId', nextCpId);
            saveData('nextPmId', nextPmId);
            saveData('nextBrId', nextBrId);
            saveData('nextCalId', nextCalId);
            saveData('workRequests', workRequestsData);
            saveData('nextRequestId', nextRequestId);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // SUPABASE CLIENT
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const SUPABASE_URL = 'https://ckjdwiipogxdkehxqrzh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNramR3aWlwb2d4ZGtlaHhxcnpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTE5NDEsImV4cCI6MjA4NzQyNzk0MX0.lLXFAr42AgrkyakPZ4ketX0BfvLK9RayghmkIddXoYg';
        var supabaseClient;
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch(e) {
            supabaseClient = {
                auth: {
                    getSession: function() { return Promise.resolve({ data: { session: null } }); },
                    signInWithPassword: function() { return Promise.resolve({ error: { message: 'You are offline. Please connect to the internet to sign in for the first time.' } }); },
                    signUp: function() { return Promise.resolve({ error: { message: 'You are offline. Please connect to the internet to sign up.' } }); },
                    signOut: function() { return Promise.resolve({}); },
                    onAuthStateChange: function() { return { data: { subscription: { unsubscribe: function() {} } } }; }
                },
                from: function() { return { select: function() { return { eq: function() { return { single: function() { return Promise.resolve({ data: null, error: { message: 'Offline' } }); } }; } }; } }; }
            };
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // AUTHENTICATION
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function showAuthSection(section) {
            document.getElementById('loginSection').classList.remove('active');
            document.getElementById('signupSection').classList.remove('active');
            document.getElementById(section === 'signup' ? 'signupSection' : 'loginSection').classList.add('active');
            clearAuthMessage();
        }

        function showAuthMessage(text, type) {
            const el = document.getElementById('authMessage');
            el.textContent = text;
            el.className = 'auth-message ' + type;
        }

        function clearAuthMessage() {
            const el = document.getElementById('authMessage');
            el.textContent = '';
            el.className = 'auth-message';
        }

        var appInitialized = false;

        async function showApp(user) {
            // Check if user's role is 'pending' ‚Äî block access if so
            var role = null;
            if (user) {
                if (navigator.onLine) {
                    try {
                        var profileResult = await supabaseClient
                            .from('profiles')
                            .select('role, tier, full_name')
                            .eq('id', user.id)
                            .single();
                        if (profileResult.data) {
                            role = profileResult.data.role;
                            currentUserTier = profileResult.data.tier || 'essential';
                            currentUserName = profileResult.data.full_name || user.email;
                        }
                        currentUserRole = role;
                        // Cache successful auth for offline use
                        saveData('cachedUser', { id: user.id, email: user.email, role: role, tier: currentUserTier, name: currentUserName });
                    } catch (e) {
                        var cached = loadData('cachedUser', null);
                        if (cached && cached.id === user.id) { role = cached.role; currentUserTier = cached.tier || 'essential'; currentUserName = cached.name || user.email; currentUserRole = role; }
                    }
                } else {
                    var cached = loadData('cachedUser', null);
                    if (cached && cached.id === user.id) { role = cached.role; currentUserTier = cached.tier || 'essential'; currentUserName = cached.name || user.email; currentUserRole = role; }
                }
            }

            if (role === 'pending') {
                document.getElementById('authScreen').classList.add('hidden');
                document.getElementById('appContent').style.display = 'none';
                document.getElementById('pendingScreen').style.display = '';
                return;
            }

            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('pendingScreen').style.display = 'none';
            document.getElementById('appContent').style.display = '';
            if (user && user.email) {
                document.getElementById('userEmailDisplay').textContent = user.email;
            }
            if (!appInitialized) {
                appInitialized = true;
                if (typeof renderWorkOrders === 'function') {
                    renderWorkOrders();
                    renderEquipment();
                    renderParts();
                    renderPurchaseOrders();
                    renderHotWorkPermits();
                    renderContractorPermits();
                    renderPM();
                    updateNotificationCount();
                    initializeCharts();
                    if (typeof renderBreakdowns === 'function') {
                        renderBreakdowns();
                        renderCalendar();
                        populateEquipDropdown('brMachine', false);
                        populateEquipDropdown('brFilterMachine', true);
                        populateEquipDropdown('brEditMachine', false);
                        populateEquipDropdown('calEquipment', false);
                    }
                    if (typeof renderWorkRequests === 'function') {
                        renderWorkRequests();
                        populateRequestEquipDropdown();
                    }
                }
            }
            console.log('[Cradero] showApp ‚Äî tier:', currentUserTier, 'role:', role, 'name:', currentUserName);
            applyTierRestrictions();
            // Set engineer dashboard dropdown to current user's name if it matches
            var engSelect = document.getElementById('myTasksEngineerSelect');
            if (engSelect && currentUserName) {
                var opts = engSelect.options;
                for (var i = 0; i < opts.length; i++) {
                    if (opts[i].value === currentUserName) { engSelect.value = currentUserName; break; }
                }
            }
            if (typeof renderEngineerDashboard === 'function') renderEngineerDashboard();
            if (typeof renderProAnalytics === 'function') renderProAnalytics();
            if (typeof updatePermitStats === 'function') updatePermitStats();
        }

        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('appContent').style.display = 'none';
            document.getElementById('pendingScreen').style.display = 'none';
            document.getElementById('userEmailDisplay').textContent = '';
        }

        async function handleSignUp(e) {
            e.preventDefault();
            var btn = document.getElementById('signupBtn');
            var name = document.getElementById('signupName').value.trim();
            var email = document.getElementById('signupEmail').value.trim();
            var password = document.getElementById('signupPassword').value;
            var confirm = document.getElementById('signupPasswordConfirm').value;

            if (password !== confirm) {
                showAuthMessage('Passwords do not match.', 'error');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Signing up...';
            clearAuthMessage();

            var result = await supabaseClient.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: { full_name: name, role: 'pending' }
                }
            });

            btn.disabled = false;
            btn.textContent = 'Sign Up';

            if (result.error) {
                showAuthMessage(result.error.message, 'error');
                return;
            }

            showAuthMessage('Account created! An admin will review and approve your access. Check your email to confirm your address, then you can log in.', 'success');
            showAuthSection('login');
        }

        async function handleLogin(e) {
            e.preventDefault();
            var btn = document.getElementById('loginBtn');
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;

            btn.disabled = true;
            btn.textContent = 'Logging in...';
            clearAuthMessage();

            var result = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password
            });

            btn.disabled = false;
            btn.textContent = 'Log In';

            if (result.error) {
                showAuthMessage(result.error.message, 'error');
                return;
            }

            if (!appInitialized) {
                await showApp(result.data.user);
            }
        }

        async function handleLogout() {
            try { await supabaseClient.auth.signOut(); } catch(e) {}
            saveData('cachedUser', null);
            appInitialized = false;
            showAuthScreen();
        }

        async function checkAuthOnLoad() {
            try {
                var result = await supabaseClient.auth.getSession();
                if (result.data.session) {
                    await showApp(result.data.session.user);
                    return true;
                }
            } catch (e) {
                // Supabase unreachable ‚Äî check for cached session
                var cached = loadData('cachedUser', null);
                if (cached && cached.role !== 'pending') {
                    currentUserTier = cached.tier || 'essential';
                    currentUserRole = cached.role;
                    currentUserName = cached.name || cached.email || '';
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('pendingScreen').style.display = 'none';
                    document.getElementById('appContent').style.display = '';
                    document.getElementById('userEmailDisplay').textContent = cached.email || '';
                    if (!appInitialized) {
                        appInitialized = true;
                        if (typeof renderWorkOrders === 'function') {
                            renderWorkOrders();
                            renderEquipment();
                            renderParts();
                            renderPurchaseOrders();
                            renderHotWorkPermits();
                            renderContractorPermits();
                            renderPM();
                            updateNotificationCount();
                            initializeCharts();
                            if (typeof renderBreakdowns === 'function') {
                                renderBreakdowns();
                                renderCalendar();
                                populateEquipDropdown('brMachine', false);
                                populateEquipDropdown('brFilterMachine', true);
                                populateEquipDropdown('brEditMachine', false);
                                populateEquipDropdown('calEquipment', false);
                            }
                            if (typeof renderWorkRequests === 'function') {
                                renderWorkRequests();
                                populateRequestEquipDropdown();
                            }
                        }
                    }
                    applyTierRestrictions();
                    return true;
                }
            }
            showAuthScreen();
            return false;
        }

        // Listen for auth state changes (e.g. session expiry, tab focus)
        var showAppInProgress = false;
        supabaseClient.auth.onAuthStateChange(function(event, session) {
            if (event === 'SIGNED_IN' && session) {
                if (!showAppInProgress && !appInitialized) {
                    showAppInProgress = true;
                    showApp(session.user).finally(function() { showAppInProgress = false; });
                }
            } else if (event === 'SIGNED_OUT') {
                appInitialized = false;
                showAppInProgress = false;
                showAuthScreen();
            }
        });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // TOAST NOTIFICATIONS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.4s';
                setTimeout(() => toast.remove(), 400);
            }, 2500);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // DATA STORES (loaded from localStorage, with hardcoded defaults)
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var _hasStoredData = localStorage.getItem(STORAGE_PREFIX + 'workOrders') !== null;

        var DEFAULT_WORK_ORDERS = [
            { id: 1, woId: 'WO-2024-001', title: 'Line 3 Filler - Motor Overheating', equipment: 'Line 3 Filler', priority: 'high', status: 'open', assignedTo: '', createdBy: 'Sarah Williams', created: 'Feb 13, 2026 - 9:20 AM', description: 'Motor temperature reading above normal range. Noticed unusual heat during production run. Requires immediate inspection to prevent potential failure.', hasPhotos: true, comments: [{author:'Sarah Williams',timestamp:'Feb 13, 2026 - 9:25 AM',text:'Temperature reading was 95¬∞C, normal range is 60-75¬∞C. Production stopped on Line 3.'},{author:'Mike Johnson',timestamp:'Feb 13, 2026 - 10:00 AM',text:'Checked motor bearings ‚Äî outer bearing feels rough. Likely needs replacement. Ordering parts now.'}], startTime: '', finishTime: '', totalJobTime: '', machineDowntime: '' },
            { id: 2, woId: 'WO-2024-002', title: 'Line 1 Conveyor - Belt Replacement', equipment: 'Line 1 Conveyor', priority: 'medium', status: 'in-progress', assignedTo: 'John Smith', createdBy: 'Mike Johnson', created: 'Feb 13, 2026 - 8:00 AM', description: 'Conveyor belt showing signs of wear and cracking. Scheduled replacement to prevent unexpected failure during production.', hasPhotos: false, comments: [{author:'John Smith',timestamp:'Feb 13, 2026 - 8:30 AM',text:'Belt received from stores. Starting replacement during lunch break.'}], startTime: '2026-02-13T08:30', finishTime: '', totalJobTime: '', machineDowntime: '' },
            { id: 3, woId: 'WO-2024-003', title: 'Line 2 Packaging - Sensor Calibration', equipment: 'Line 2 Packaging', priority: 'low', status: 'open', assignedTo: '', createdBy: 'Sarah Williams', created: 'Feb 12, 2026 - 3:45 PM', description: 'Routine calibration of proximity sensors on packaging line. Sensors need to be adjusted for optimal product detection.', hasPhotos: false, comments: [], startTime: '', finishTime: '', totalJobTime: '', machineDowntime: '' },
            { id: 4, woId: 'WO-2024-004', title: 'Line 4 Mixer - Bearing Noise Investigation', equipment: 'Line 4 Mixer', priority: 'high', status: 'in-progress', assignedTo: 'Mike Johnson', createdBy: 'John Smith', created: 'Feb 13, 2026 - 11:00 AM', description: 'Unusual grinding noise coming from main mixer bearing. Investigating potential bearing failure. May require replacement if wear is detected.', hasPhotos: true, comments: [{author:'Mike Johnson',timestamp:'Feb 13, 2026 - 11:15 AM',text:'Confirmed bearing wear on main shaft. Need 6205 bearing from stores.'}], startTime: '2026-02-13T11:00', finishTime: '', totalJobTime: '', machineDowntime: '' }
        ];
        let nextWoId = loadData('nextWoId', 5);
        let workOrdersData = loadData('workOrders', DEFAULT_WORK_ORDERS);

        let nextRequestId = loadData('nextRequestId', 3);
        let workRequestsData = loadData('workRequests', [
            { id: 1, equipment: 'Line 3 - Filler Machine', description: 'Strange vibration noise coming from the filler during operation. Gets louder at higher speeds.', urgency: 'medium', submitter: 'Dave from Production', submitted: 'Feb 24, 2026 - 2:30 PM', status: 'pending' },
            { id: 2, equipment: 'Line 1 - Conveyor System', description: 'Emergency stop button on east side of conveyor feels sticky and does not spring back properly.', urgency: 'high', submitter: 'Lisa from QA', submitted: 'Feb 25, 2026 - 8:15 AM', status: 'pending' }
        ]);


        let nextEquipId = loadData('nextEquipId', 5);
        let equipmentList = loadData('equipment', [
            { id: 1, name: 'Line 3 - Filler Machine',  equipId: 'EQ-FL-003', manufacturer: 'FoodTech Pro',        model: 'FT-500X',  location: 'Production Floor - Line 3', installDate: '2021-01', status: 'down',        workOrders30d: 8, criticality: 'A', warrantyExpiry: '2025-01-15', warrantyProvider: 'FoodTech Pro', warrantyNotes: 'Extended warranty expired' },
            { id: 2, name: 'Line 1 - Conveyor System',  equipId: 'EQ-CV-001', manufacturer: 'ConveyorMax',         model: 'CM-200',   location: 'Production Floor - Line 1', installDate: '2020-03', status: 'maintenance', workOrders30d: 3, criticality: 'B', warrantyExpiry: '2026-06-30', warrantyProvider: 'ConveyorMax Ltd', warrantyNotes: '3-year parts warranty' },
            { id: 3, name: 'Line 2 - Industrial Mixer', equipId: 'EQ-MX-002', manufacturer: 'MixMaster Industrial', model: 'MM-1000',  location: 'Production Floor - Line 2', installDate: '2019-08', status: 'operational', workOrders30d: 2, criticality: 'B', warrantyExpiry: '', warrantyProvider: '', warrantyNotes: '' },
            { id: 4, name: 'Line 4 - Packaging Unit',   equipId: 'EQ-PK-004', manufacturer: 'PackPro Systems',     model: 'PP-300',   location: 'Production Floor - Line 4', installDate: '2020-12', status: 'operational', workOrders30d: 4, criticality: 'C', warrantyExpiry: '2027-12-31', warrantyProvider: 'PackPro Systems', warrantyNotes: '5-year comprehensive warranty' }
        ]);

        let nextPartId = loadData('nextPartId', 4);
        let partsData = loadData('parts', [
            { id: 1, name: 'Motor Bearing 6205',   partNumber: 'PN-MB-6205-001', qty: 15, minStock: 8, shelf: 'B3', bin: '12', monthlyUsage: 3, compatibleEquipment: [1, 3], suppliers: [{supplier:'RS Components',supplierPartNo:'286-3421',price:8.50,leadTime:'Next day'},{supplier:'Grainger',supplierPartNo:'6Y839',price:9.20,leadTime:'Same day'}] },
            { id: 2, name: 'Conveyor Belt 48"',    partNumber: 'PN-CB-48-002',   qty: 2,  minStock: 4, shelf: 'A1', bin: '5',  monthlyUsage: 1, compatibleEquipment: [2], suppliers: [{supplier:'Motion Industries',supplierPartNo:'MI-CB48-200',price:145.00,leadTime:'2-3 days'},{supplier:'Local Supplier',supplierPartNo:'BM-BELT-48',price:155.00,leadTime:'Pick up today'}] },
            { id: 3, name: 'Proximity Sensor M18', partNumber: 'PN-PS-M18-004',  qty: 0,  minStock: 5, shelf: 'D4', bin: '15', monthlyUsage: 2, compatibleEquipment: [4], suppliers: [{supplier:'RS Components',supplierPartNo:'714-6258',price:22.80,leadTime:'Next day'}] }
        ]);

        // Migrate existing work orders: add comments and time fields if missing
        workOrdersData.forEach(function(wo) {
            if (!wo.comments) wo.comments = [];
            if (typeof wo.startTime === 'undefined') wo.startTime = '';
            if (typeof wo.finishTime === 'undefined') wo.finishTime = '';
            if (typeof wo.totalJobTime === 'undefined') wo.totalJobTime = '';
            if (typeof wo.machineDowntime === 'undefined') wo.machineDowntime = '';
        });
        saveData('workOrders', workOrdersData);

        // Migrate existing equipment: add criticality and warranty if missing
        equipmentList.forEach(function(eq) {
            if (!eq.criticality) eq.criticality = 'B';
            if (typeof eq.warrantyExpiry === 'undefined') eq.warrantyExpiry = '';
            if (typeof eq.warrantyProvider === 'undefined') eq.warrantyProvider = '';
            if (typeof eq.warrantyNotes === 'undefined') eq.warrantyNotes = '';
        });
        saveData('equipment', equipmentList);

        // Migrate existing parts: add suppliers and compatibleEquipment if missing
        partsData.forEach(function(p) {
            if (!p.suppliers) p.suppliers = [];
            if (!p.compatibleEquipment) p.compatibleEquipment = [];
        });
        saveData('parts', partsData);

        let nextPoId = loadData('nextPoId', 146);
        let purchaseOrdersData = loadData('purchaseOrders', [
            { id: 1, poNumber: 'PO-2026-00145', title: 'Emergency Parts Order',         vendor: 'Grainger',                    status: 'ordered',    priority: 'high',   total: '¬£1,245.00', created: 'Today, 10:30 AM',  items: 3,  expectedDelivery: 'Same Day',      tags: ['Proximity Sensor M18 (5x)', 'Motor Bearing 6205 (2x)', 'Conveyor Belt (1x)'], tracking: null,                 notes: 'Urgent repair parts for Line 3 production issue', requestedBy: 'Sarah Williams', budgetCode: 'Emergency Repairs' },
            { id: 2, poNumber: 'PO-2026-00144', title: 'Monthly Restock Order',         vendor: 'RS Components',               status: 'pending',    priority: 'medium', total: '¬£2,890.00', created: 'Yesterday',        items: 12, expectedDelivery: 'Next Day',      tags: [],                                                                              tracking: null,                 notes: 'Monthly restock order - awaiting approval',      requestedBy: 'John Smith',    budgetCode: 'Maintenance Budget' },
            { id: 3, poNumber: 'PO-2026-00143', title: 'Preventive Maintenance Parts', vendor: 'Motion Industries',            status: 'in-transit', priority: 'low',    total: '¬£1,567.50', created: 'Feb 12',           items: 8,  expectedDelivery: 'Tomorrow',      tags: [],                                                                              tracking: '1Z999AA10123456784', notes: 'Preventive maintenance parts',                   requestedBy: 'Mike Johnson',  budgetCode: 'Maintenance Budget' },
            { id: 4, poNumber: 'PO-2026-00142', title: 'Line 3 Repair Parts',          vendor: 'Local Supplier - BearingMax', status: 'received',   priority: 'low',    total: '¬£532.00',   created: 'Feb 11',           items: 5,  expectedDelivery: 'Received',      tags: [],                                                                              tracking: null,                 notes: 'Picked up from local supplier',                  requestedBy: 'John Smith',    budgetCode: 'Emergency Repairs' }
        ]);

        let nextHwId = loadData('nextHwId', 2);
        let hotWorkPermits = loadData('hotWorkPermits', [
            { id: 1, title: 'üî• Welding Work - Line 3 Filler Repair', location: 'Production Floor - Line 3', engineer: 'Mike Johnson', fireWatch: 'Tom Carter', startTime: '09:00', endTime: '17:00', status: 'active', validText: 'Valid until: 5:00 PM today', expiryText: 'Expires in 3 hours' }
        ]);

        let nextCpId = loadData('nextCpId', 4);
        let contractorPermits = loadData('contractorPermits', [
            { id: 1, title: 'HVAC System Maintenance - XYZ Mechanical',            company: 'XYZ Mechanical Services',   supervisor: 'Tom Davis',       phone: '(555) 123-4567', workers: 3, location: 'Mechanical Room',   startDate: 'Feb 13, 2026', endDate: 'Feb 14, 2026', insurance: 'INS-2024-12345', scope: 'Complete HVAC system maintenance including filter replacement, coil cleaning, and system testing.',                                              status: 'Active', expiryText: 'Expires tomorrow' },
            { id: 2, title: 'Electrical Panel Upgrade - ABC Electric',              company: 'ABC Electric Co.',          supervisor: 'Lisa Chen',        phone: '(555) 234-5678', workers: 2, location: 'Electrical Room',   startDate: 'Feb 13, 2026', endDate: 'Feb 15, 2026', insurance: 'INS-2024-67890', scope: 'Upgrade main electrical panel and install new circuit breakers for increased capacity.',                                                         status: 'Active', expiryText: 'Expires in 2 days' },
            { id: 3, title: 'Fire Suppression System Inspection - SafeGuard Fire', company: 'SafeGuard Fire Protection', supervisor: 'Robert Martinez', phone: '(555) 345-6789', workers: 2, location: 'Facility-Wide',    startDate: 'Feb 13, 2026', endDate: 'Feb 13, 2026', insurance: 'INS-2024-11223', scope: 'Annual inspection and testing of fire suppression system including all sprinkler heads and control panels.', status: 'Active', expiryText: 'Expires tonight' }
        ]);

        let closedHotWorkPermits = loadData('closedHotWorkPermits', [
            { id: 100, title: 'üî• Grinding Work - Line 1 Conveyor Frame', location: 'Production Floor - Line 1', engineer: 'John Smith', fireWatch: 'Dave Turner', startTime: '08:00', endTime: '12:00', status: 'closed', validText: 'Was valid: 8:00 AM ‚Äì 12:00 PM', expiryText: 'Closed', closedDate: 'Feb 10, 2026', closedBy: 'John Smith' },
            { id: 101, title: 'üî• Welding Repair - Line 4 Packaging Frame', location: 'Production Floor - Line 4', engineer: 'Mike Johnson', fireWatch: 'Tom Carter', startTime: '13:00', endTime: '16:00', status: 'closed', validText: 'Was valid: 1:00 PM ‚Äì 4:00 PM', expiryText: 'Closed', closedDate: 'Feb 7, 2026', closedBy: 'Mike Johnson' }
        ]);
        let closedContractorPermits = loadData('closedContractorPermits', [
            { id: 100, title: 'Roof Repair - TopFix Roofing', company: 'TopFix Roofing Ltd', supervisor: 'James Wright', phone: '(555) 456-7890', workers: 4, location: 'Building Exterior - Roof', startDate: 'Feb 3, 2026', endDate: 'Feb 5, 2026', insurance: 'INS-2024-55678', scope: 'Repair damaged roof section above Line 2 area.', status: 'Closed', expiryText: 'Closed', closedDate: 'Feb 5, 2026', closedBy: 'Admin' },
            { id: 101, title: 'Compressed Air System Service - AirPro', company: 'AirPro Services', supervisor: 'Neil Patel', phone: '(555) 567-8901', workers: 2, location: 'Compressor Room', startDate: 'Jan 28, 2026', endDate: 'Jan 29, 2026', insurance: 'INS-2024-44321', scope: 'Annual service and filter replacement on main compressor.', status: 'Closed', expiryText: 'Closed', closedDate: 'Jan 29, 2026', closedBy: 'Admin' },
            { id: 102, title: 'Pest Control Inspection - SafePest', company: 'SafePest Solutions', supervisor: 'Karen Mills', phone: '(555) 678-9012', workers: 1, location: 'Facility-Wide', startDate: 'Jan 15, 2026', endDate: 'Jan 15, 2026', insurance: 'INS-2024-33210', scope: 'Quarterly pest control inspection and treatment.', status: 'Closed', expiryText: 'Closed', closedDate: 'Jan 15, 2026', closedBy: 'Admin' }
        ]);

        let nextPmId = loadData('nextPmId', 6);
        let pmData = loadData('pmSchedule', [
            { id: 'fire-alarm',    title: 'üî• Fire Alarm System - Weekly Test',    equipment: 'Facility-Wide',        frequency: 'Weekly (Every Monday)', duration: '15 minutes', assignedTo: 'Mike Johnson',    dueStatus: 'overdue',  dueText: 'Overdue by 1 day', status: 'overdue',   lastCompleted: 'Feb 5, 2026', scheduledDate: '2026-02-24', checklist: [{text:'Test all call points on each floor',checked:false,note:''},{text:'Verify panel shows no faults',checked:false,note:''},{text:'Check sounder/beacon activation',checked:false,note:''},{text:'Log result in fire safety register',checked:false,note:''}] },
            { id: 'emerg-light',   title: 'üí° Emergency Lighting - Monthly Test',   equipment: 'All Emergency Exits',  frequency: 'Monthly (1st of month)', duration: '45 minutes', assignedTo: 'Sarah Williams',  dueStatus: 'due-soon', dueText: 'Due in 2 days',    status: 'due-soon',  lastCompleted: 'Jan 1, 2026', scheduledDate: '2026-03-01', checklist: [{text:'Activate test switch on each unit',checked:false,note:''},{text:'Verify illumination for 3+ hours',checked:false,note:''},{text:'Replace any failed bulbs/batteries',checked:false,note:''},{text:'Record results in maintenance log',checked:false,note:''}] },
            { id: 'line3-lube',    title: 'Line 3 Filler - Monthly Lubrication',   equipment: 'Line 3 Filler',        frequency: 'Monthly',               duration: '30 minutes', assignedTo: 'Sarah Williams',  dueStatus: 'overdue',  dueText: 'Overdue by 2 days', status: 'overdue',  lastCompleted: 'Jan 12, 2026', scheduledDate: '2026-02-23', checklist: [{text:'Grease all bearing points',checked:false,note:''},{text:'Check oil level in gearbox',checked:false,note:''},{text:'Inspect seals for leaks',checked:false,note:''},{text:'Clean excess lubricant',checked:false,note:''},{text:'Record lubricant quantities used',checked:false,note:''}] },
            { id: 'line1-belt',    title: 'Line 1 Conveyor - Belt Tension Check',  equipment: 'Line 1 Conveyor',      frequency: 'Weekly',                duration: '15 minutes', assignedTo: 'John Smith',      dueStatus: 'due-soon', dueText: 'Due tomorrow',     status: 'due-soon',  lastCompleted: 'Feb 6, 2026', scheduledDate: '2026-02-26', checklist: [{text:'Measure belt tension with gauge',checked:false,note:''},{text:'Check belt alignment',checked:false,note:''},{text:'Inspect belt for wear or damage',checked:false,note:''},{text:'Adjust tension if out of spec',checked:false,note:''}] },
            { id: 'line2-oil',     title: 'Line 2 Mixer - Gearbox Oil Change',     equipment: 'Line 2 Mixer',         frequency: 'Quarterly',             duration: '1 hour',     assignedTo: 'Mike Johnson',    dueStatus: 'upcoming', dueText: 'Due in 5 days',    status: 'upcoming',  lastCompleted: 'Nov 14, 2025', scheduledDate: '2026-03-02', checklist: [{text:'Drain old oil completely',checked:false,note:''},{text:'Inspect drain plug magnet for metal particles',checked:false,note:''},{text:'Replace oil filter',checked:false,note:''},{text:'Fill with correct grade oil to spec level',checked:false,note:''},{text:'Run for 5 minutes and recheck level',checked:false,note:''},{text:'Record oil type and quantity used',checked:false,note:''}] }
        ]);

        // Migrate existing PM data: add checklist if missing
        var defaultChecklists = {
            'fire-alarm':  [{text:'Test all call points on each floor',checked:false,note:''},{text:'Verify panel shows no faults',checked:false,note:''},{text:'Check sounder/beacon activation',checked:false,note:''},{text:'Log result in fire safety register',checked:false,note:''}],
            'emerg-light': [{text:'Activate test switch on each unit',checked:false,note:''},{text:'Verify illumination for 3+ hours',checked:false,note:''},{text:'Replace any failed bulbs/batteries',checked:false,note:''},{text:'Record results in maintenance log',checked:false,note:''}],
            'line3-lube':  [{text:'Grease all bearing points',checked:false,note:''},{text:'Check oil level in gearbox',checked:false,note:''},{text:'Inspect seals for leaks',checked:false,note:''},{text:'Clean excess lubricant',checked:false,note:''},{text:'Record lubricant quantities used',checked:false,note:''}],
            'line1-belt':  [{text:'Measure belt tension with gauge',checked:false,note:''},{text:'Check belt alignment',checked:false,note:''},{text:'Inspect belt for wear or damage',checked:false,note:''},{text:'Adjust tension if out of spec',checked:false,note:''}],
            'line2-oil':   [{text:'Drain old oil completely',checked:false,note:''},{text:'Inspect drain plug magnet for metal particles',checked:false,note:''},{text:'Replace oil filter',checked:false,note:''},{text:'Fill with correct grade oil to spec level',checked:false,note:''},{text:'Run for 5 minutes and recheck level',checked:false,note:''},{text:'Record oil type and quantity used',checked:false,note:''}]
        };
        pmData.forEach(function(pm) {
            if (!pm.checklist || pm.checklist.length === 0) {
                pm.checklist = defaultChecklists[pm.id] || [];
            }
            if (typeof pm.scheduledDate === 'undefined') {
                pm.scheduledDate = '';
            }
        });
        saveData('pmSchedule', pmData);

        // Global user info for engineer dashboard
        var currentUserRole = null;
        var currentUserName = '';

        // Track currently editing IDs
        let currentEditEquipId = null;
        let currentDetailWoId = null;
        let currentEditPermitType = null;
        let currentEditPermitId = null;

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // RENDER FUNCTIONS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function renderWorkOrders() {
            const container = document.getElementById('workOrdersList');
            if (!container) return;
            if (workOrdersData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-title">No Work Orders</div><div class="empty-state-text">Click "+ New Work Order" to create one.</div></div>';
                updateKPIs();
                return;
            }
            container.innerHTML = workOrdersData.map(wo => {
                const assignedHtml = wo.assignedTo
                    ? `<span>${wo.assignedTo}</span>`
                    : `<span style="color: var(--danger); font-weight: 600;">Unassigned</span>`;
                const statusLabel = wo.status === 'in-progress' ? 'In Progress' : wo.status === 'completed' ? 'Completed' : wo.status === 'on-hold' ? 'On Hold' : 'Open';
                const statusClass = wo.status;
                const photosHtml = wo.hasPhotos ? `<div class="wo-images">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect fill='%23E5E5E5' width='60' height='60'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='monospace' font-size='12' fill='%23666'%3Eüì∑%3C/text%3E%3C/svg%3E" class="wo-image-thumb" alt="Photo">
                </div>` : '';
                return `<div class="work-order-item">
                    <div class="wo-priority ${wo.priority}"></div>
                    <div class="wo-details">
                        <div class="wo-title">${escHtml(wo.title)}${wo.fromBreakdown ? '<span style="background:var(--warning);color:var(--dark);font-size:0.7rem;padding:2px 7px;border-radius:4px;font-weight:700;margin-left:6px;">&#9889; Breakdown</span>' : ''}</div>
                        <div class="wo-meta">
                            <div class="wo-meta-item"><span>üè≠</span><span>${escHtml(wo.equipment)}</span></div>
                            <div class="wo-meta-item"><span>üë§</span>${assignedHtml}</div>
                            <div class="wo-meta-item"><span>üìÖ</span><span>${escHtml(wo.created)}</span></div>
                        </div>
                        ${photosHtml}
                    </div>
                    <div class="status-badge ${statusClass}">${statusLabel}</div>
                    <div style="display:flex;gap:0.5rem;">
                        <button class="btn btn-primary btn-small" onclick="openWorkOrderDetail(${wo.id})">View</button>
                        <button class="btn btn-danger btn-small" onclick="deleteWorkOrder(${wo.id})">Delete</button>
                    </div>
                </div>`;
            }).join('');
            updateKPIs();
        }

        function renderEquipment() {
            const container = document.getElementById('equipmentGrid');
            if (!container) return;
            if (equipmentList.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚öôÔ∏è</div><div class="empty-state-title">No Equipment</div><div class="empty-state-text">Click "+ Add Equipment" to add some.</div></div>';
                updateKPIs();
                return;
            }
            container.innerHTML = equipmentList.map(eq => {
                const statusLabel = eq.status === 'operational' ? 'Operational' : eq.status === 'maintenance' ? 'Maintenance' : 'Down';
                const installFormatted = eq.installDate ? new Date(eq.installDate + '-01').toLocaleString('en-GB', { month: 'short', year: 'numeric' }) : 'N/A';
                const critColors = { A: '#dc2626', B: '#f59e0b', C: '#22c55e' };
                const critLabels = { A: 'Critical', B: 'Important', C: 'Low' };
                const crit = eq.criticality || 'B';
                var warrantyBadge = '';
                if (eq.warrantyExpiry) {
                    var wDiff = Math.ceil((new Date(eq.warrantyExpiry) - new Date()) / 86400000);
                    if (wDiff < 0) warrantyBadge = '<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;background:rgba(220,38,38,0.1);color:#dc2626;">Warranty Expired</span>';
                    else if (wDiff <= 30) warrantyBadge = '<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;background:rgba(245,158,11,0.1);color:#f59e0b;">Warranty Expiring</span>';
                    else warrantyBadge = '<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;background:rgba(34,197,94,0.1);color:#22c55e;">Warranty Active</span>';
                }
                return `<div class="equipment-card">
                    <div class="equipment-header">
                        <div>
                            <div class="equipment-name">${escHtml(eq.name)}</div>
                            <div class="equipment-id">${escHtml(eq.equipId)}</div>
                        </div>
                        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                            <div class="equipment-status ${eq.status}">${statusLabel}</div>
                            <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;background:${critColors[crit]}15;color:${critColors[crit]};">${crit} ‚Äî ${critLabels[crit]}</span>
                        </div>
                    </div>
                    <div class="equipment-info">
                        <div class="equipment-info-row"><span class="equipment-info-label">Location</span><span class="equipment-info-value">${escHtml(eq.location)}</span></div>
                        <div class="equipment-info-row"><span class="equipment-info-label">Manufacturer</span><span class="equipment-info-value">${escHtml(eq.manufacturer)}</span></div>
                        <div class="equipment-info-row"><span class="equipment-info-label">Install Date</span><span class="equipment-info-value">${installFormatted}</span></div>
                        <div class="equipment-info-row"><span class="equipment-info-label">Work Orders (30d)</span><span class="equipment-info-value">${eq.workOrders30d} total</span></div>
                        ${warrantyBadge ? '<div class="equipment-info-row"><span class="equipment-info-label">Warranty</span><span class="equipment-info-value">' + warrantyBadge + '</span></div>' : ''}
                        ${hasAccess('analytics') ? (function() {
                            var hs = 100;
                            if (eq.installDate) { var yrs = (new Date() - new Date(eq.installDate + '-01')) / (365.25 * 86400000); hs -= Math.min(20, Math.round(yrs * 2)); }
                            var rb = breakdownsData.filter(function(b) { return b.machine === eq.name && b.dateISO && (new Date() - new Date(b.dateISO)) < 90 * 86400000; }).length;
                            hs -= Math.min(40, rb * 10);
                            if (eq.status === 'down') hs -= 20; else if (eq.status === 'maintenance') hs -= 10;
                            hs -= Math.min(15, eq.workOrders30d * 2);
                            hs = Math.max(0, Math.min(100, hs));
                            var hc = hs >= 80 ? '#22c55e' : hs >= 50 ? '#f59e0b' : '#dc2626';
                            return '<div class="equipment-info-row pro-only-feature"><span class="equipment-info-label">Health Score</span><span class="equipment-info-value" style="font-weight:700;color:' + hc + ';">' + hs + '/100</span></div>';
                        })() : ''}
                    </div>
                    <div class="equipment-actions">
                        <button class="btn btn-primary btn-small" onclick="openEquipmentHistory(${eq.id})">View History</button>
                        <button class="btn btn-secondary btn-small" onclick="openEquipmentEdit(${eq.id})">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteEquipment(${eq.id})">Delete</button>
                    </div>
                </div>`;
            }).join('');
            updateKPIs();
        }

        function getStockStatus(qty, minStock) {
            if (qty === 0) return { cls: 'out-of-stock', label: 'Out of Stock' };
            if (qty <= minStock) return { cls: 'low-stock', label: 'Low Stock' };
            return { cls: 'in-stock', label: 'In Stock' };
        }

        function renderParts() {
            const container = document.getElementById('partsGrid');
            if (!container) return;
            if (partsData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîß</div><div class="empty-state-title">No Parts</div><div class="empty-state-text">Click "+ Add Part" to add inventory.</div></div>';
                return;
            }
            container.innerHTML = partsData.map(p => {
                const stock = getStockStatus(p.qty, p.minStock);
                const orderBtnClass = stock.cls === 'in-stock' ? 'btn-primary' : 'btn-danger';
                const orderBtnLabel = stock.cls === 'in-stock' ? 'Order More' : (stock.cls === 'low-stock' ? 'üö® Order Now' : 'üö® Emergency Order');
                return `<div class="part-card">
                    <div class="part-header">
                        <div>
                            <div class="part-name">${escHtml(p.name)}</div>
                            <div class="part-number">${escHtml(p.partNumber)}</div>
                        </div>
                        <div class="stock-indicator ${stock.cls}">${stock.label}</div>
                    </div>
                    <div class="part-details">
                        <div class="part-detail-row"><span class="part-detail-label">Quantity</span><span class="part-detail-value">${p.qty} units</span></div>
                        <div class="part-detail-row"><span class="part-detail-label">Location</span><span class="part-detail-value">Shelf ${escHtml(p.shelf)}, Bin ${escHtml(p.bin)}</span></div>
                        <div class="part-detail-row"><span class="part-detail-label">Min Stock</span><span class="part-detail-value">${p.minStock} units</span></div>
                        <div class="part-detail-row"><span class="part-detail-label">Used This Month</span><span class="part-detail-value">${p.monthlyUsage} times</span></div>
                        ${p.compatibleEquipment && p.compatibleEquipment.length > 0 ? `<div class="part-detail-row"><span class="part-detail-label">Equipment</span><span class="part-detail-value" style="color:var(--primary);font-weight:600;">${p.compatibleEquipment.map(function(eId) { var eq = equipmentList.find(function(e) { return e.id === eId; }); return eq ? escHtml(eq.name) : ''; }).filter(Boolean).join(', ')}</span></div>` : ''}
                        ${hasAccess('purchaseOrders') && p.suppliers && p.suppliers.length > 0 ? `<div class="part-detail-row"><span class="part-detail-label">Suppliers</span><span class="part-detail-value" style="color:var(--primary);font-weight:600;">${p.suppliers.length} supplier${p.suppliers.length > 1 ? 's' : ''}</span></div>` : ''}
                        ${hasAccess('purchaseOrders') ? (function() { var m = p.monthlyUsage > 0 ? Math.floor(p.qty / p.monthlyUsage) : -1; var fColor = m < 0 ? 'var(--gray-600)' : m < 2 ? '#dc2626' : m < 4 ? '#f59e0b' : '#22c55e'; var fText = m < 0 ? 'No usage data' : m === 0 ? 'Depleted this month' : m + ' months remaining'; return '<div class="part-detail-row pro-only-feature"><span class="part-detail-label">Stock Forecast</span><span class="part-detail-value" style="color:' + fColor + ';font-weight:600;">' + fText + '</span></div>'; })() : ''}
                    </div>
                    <div style="display:flex;gap:0.5rem;margin-top:1rem;">
                        ${hasAccess('purchaseOrders') ? `<button class="btn ${orderBtnClass}" style="flex:1;" onclick="orderPart('${escHtml(p.partNumber)}','${escHtml(p.name)}',${stock.cls !== 'in-stock'})">${orderBtnLabel}</button>` : ''}
                        <button class="btn btn-secondary btn-small" onclick="openEditPart(${p.id})" style="flex:1;">Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deletePart(${p.id})" style="flex:1;">Delete</button>
                    </div>
                </div>`;
            }).join('');
        }

        function getPoStatusBadge(status) {
            const map = {
                'ordered':    { bg: 'rgba(255,179,0,0.1)',   color: 'var(--warning)', label: 'ORDERED' },
                'pending':    { bg: 'rgba(0,102,255,0.1)',   color: 'var(--primary)', label: 'PENDING' },
                'in-transit': { bg: 'rgba(255,179,0,0.1)',   color: 'var(--warning)', label: 'IN TRANSIT' },
                'received':   { bg: 'rgba(0,200,83,0.1)',    color: 'var(--success)', label: 'RECEIVED' },
                'approved':   { bg: 'rgba(0,200,83,0.1)',    color: 'var(--success)', label: 'APPROVED' },
                'cancelled':  { bg: 'rgba(255,61,0,0.1)',    color: 'var(--danger)',  label: 'CANCELLED' }
            };
            return map[status] || { bg: 'var(--gray-200)', color: 'var(--dark)', label: status.toUpperCase() };
        }

        let currentPoFilter = 'all';

        function renderPurchaseOrders() {
            const container = document.getElementById('poList');
            if (!container) return;
            const filtered = currentPoFilter === 'all' ? purchaseOrdersData : purchaseOrdersData.filter(po => po.status === currentPoFilter);
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div class="empty-state-title">No Purchase Orders</div><div class="empty-state-text">No orders match this filter.</div></div>';
                return;
            }
            container.innerHTML = filtered.map(po => {
                const badge = getPoStatusBadge(po.status);
                const borderStyle = po.priority === 'high' ? 'border-left: 6px solid var(--danger);' : '';
                const tagsHtml = po.tags && po.tags.length ? `<div style="margin-top:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap;">${po.tags.map(t => `<span style="padding:0.25rem 0.75rem;background:var(--gray-100);border-radius:20px;font-size:0.85rem;">${escHtml(t)}</span>`).join('')}</div>` : '';
                const approveBtn = po.status === 'pending' ? `<button class="btn btn-success btn-small" onclick="approvePO('${po.poNumber}')">Approve</button>` : '';
                return `<div class="work-order-item" style="${borderStyle}">
                    <div class="wo-priority ${po.priority}"></div>
                    <div class="wo-details">
                        <div class="wo-title">${escHtml(po.poNumber)} - ${escHtml(po.title)}</div>
                        <div class="wo-meta">
                            <div class="wo-meta-item"><span>üè¢</span><span>${escHtml(po.vendor)}</span></div>
                            <div class="wo-meta-item"><span>üì¶</span><span>${po.items} items</span></div>
                            <div class="wo-meta-item"><span>üí∞</span><span style="font-weight:700;color:var(--dark);">${escHtml(po.total)}</span></div>
                            <div class="wo-meta-item"><span>üìÖ</span><span>Created: ${escHtml(po.created)}</span></div>
                        </div>
                        ${tagsHtml}
                    </div>
                    <div class="status-badge" style="background:${badge.bg};color:${badge.color};">${badge.label}</div>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                        ${approveBtn}
                        <button class="btn btn-primary btn-small" onclick="openPODetail('${po.poNumber}')">View</button>
                        <button class="btn btn-danger btn-small" onclick="deletePO(${po.id})">Delete</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderHotWorkPermits() {
            const container = document.getElementById('hotWorkList');
            if (!container) return;
            if (hotWorkPermits.length === 0) {
                container.innerHTML = `<div style="padding:1.5rem;color:var(--gray-600);">No active hot work permits.</div>`;
                return;
            }
            container.innerHTML = hotWorkPermits.map(p => `<div class="work-order-item" style="border-left:6px solid var(--danger);">
                <div class="wo-priority high"></div>
                <div class="wo-details">
                    <div class="wo-title">${escHtml(p.title)}</div>
                    <div class="wo-meta">
                        <div class="wo-meta-item"><span>üè≠</span><span>${escHtml(p.location)}</span></div>
                        <div class="wo-meta-item"><span>üë§</span><span>${escHtml(p.engineer)}</span></div>
                        <div class="wo-meta-item"><span>üìÖ</span><span>${escHtml(p.validText)}</span></div>
                        <div class="wo-meta-item"><span>‚è±Ô∏è</span><span style="color:var(--danger);font-weight:600;">${escHtml(p.expiryText)}</span></div>
                    </div>
                    <div class="wo-meta" style="margin-top:0.5rem;">
                        <div class="wo-meta-item"><span>‚úÖ</span><span>Fire extinguisher on-site</span></div>
                        <div class="wo-meta-item"><span>‚úÖ</span><span>Fire watch: ${escHtml(p.fireWatch)}</span></div>
                        <div class="wo-meta-item"><span>‚úÖ</span><span>Area cleared</span></div>
                    </div>
                </div>
                <div class="status-badge in-progress">Active</div>
                <button class="btn btn-danger" onclick="closeHotWorkPermit(${p.id})">Close Permit</button>
            </div>`).join('');
        }

        function renderContractorPermits() {
            const container = document.getElementById('contractorPermitsList');
            if (!container) return;
            if (contractorPermits.length === 0) {
                container.innerHTML = `<div style="padding:1.5rem;color:var(--gray-600);">No active contractor permits.</div>`;
                return;
            }
            container.innerHTML = contractorPermits.map(p => `<div class="work-order-item">
                <div class="wo-priority low"></div>
                <div class="wo-details">
                    <div class="wo-title">${escHtml(p.title)}</div>
                    <div class="wo-meta">
                        <div class="wo-meta-item"><span>üè¢</span><span>${escHtml(p.company)}</span></div>
                        <div class="wo-meta-item"><span>üë§</span><span>Supervisor: ${escHtml(p.supervisor)}</span></div>
                        <div class="wo-meta-item"><span>üìÖ</span><span>Valid: ${escHtml(p.startDate)} ‚Äì ${escHtml(p.endDate)}</span></div>
                        <div class="wo-meta-item"><span>‚è±Ô∏è</span><span>${escHtml(p.expiryText)}</span></div>
                    </div>
                    <div class="wo-meta" style="margin-top:0.5rem;">
                        <div class="wo-meta-item"><span>‚úÖ</span><span>Safety orientation completed</span></div>
                        <div class="wo-meta-item"><span>‚úÖ</span><span>Insurance verified</span></div>
                    </div>
                </div>
                <div class="status-badge in-progress">Active</div>
                <div style="display:flex;gap:0.5rem;">
                    <button class="btn btn-primary btn-small" onclick="openPermitDetail('contractor',${p.id})">View</button>
                    <button class="btn btn-danger btn-small" onclick="closeContractorPermit(${p.id})">Close</button>
                </div>
            </div>`).join('');
        }

        function renderPM(data) {
            data = data || pmData;
            const container = document.getElementById('pmList');
            if (!container) return;

            // Populate equipment filter dropdown
            var eqSelect = document.getElementById('pmFilterEquipment');
            if (eqSelect && eqSelect.options.length <= 1) {
                var equipments = [];
                pmData.forEach(function(pm) {
                    if (equipments.indexOf(pm.equipment) === -1) equipments.push(pm.equipment);
                });
                equipments.sort();
                eqSelect.innerHTML = '<option value="">All Equipment</option>' +
                    equipments.map(function(eq) { return '<option value="' + escHtml(eq) + '">' + escHtml(eq) + '</option>'; }).join('');
            }

            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîÑ</div><div class="empty-state-title">No PM Tasks</div><div class="empty-state-text">No tasks match the current filter.</div></div>';
                return;
            }
            container.innerHTML = data.map(pm => {
                const isCompleted = pm.status === 'completed';
                const itemClass = isCompleted ? 'pm-item' : pm.dueStatus === 'overdue' ? 'pm-item overdue' : pm.dueStatus === 'due-soon' ? 'pm-item due-soon' : 'pm-item';
                const dueDateClass = isCompleted ? 'upcoming' : pm.dueStatus === 'overdue' ? 'overdue' : pm.dueStatus === 'due-soon' ? 'due-soon' : 'upcoming';
                const checkCount = pm.checklist ? pm.checklist.length : 0;
                const checkBadge = checkCount > 0
                    ? `<div class="wo-meta-item"><span>üìã</span><span>${checkCount} checks</span></div>`
                    : '';
                const scheduledBadge = pm.scheduledDate
                    ? `<div class="wo-meta-item"><span>üìÖ</span><span>${new Date(pm.scheduledDate + 'T00:00:00').toLocaleDateString('en-GB', { day:'numeric', month:'short', year:'numeric' })}</span></div>`
                    : '';
                var actionBtn;
                if (isCompleted) {
                    actionBtn = `<span class="status-badge" style="background:var(--success);color:#fff;font-size:0.8rem;">Completed</span>`;
                } else if (pm.dueStatus === 'overdue' || pm.dueStatus === 'due-soon') {
                    actionBtn = `<button class="btn btn-danger" onclick="completePM('${pm.id}')">Complete Now</button>`;
                } else {
                    actionBtn = `<button class="btn btn-primary" onclick="completePM('${pm.id}')">Complete</button>`;
                }
                var assignSelect = '<select class="form-select" style="font-size:0.8rem;padding:0.25rem 0.4rem;min-width:130px;" onchange="reassignPM(\'' + pm.id + '\', this.value)">' +
                    '<option value="John Smith"' + (pm.assignedTo === 'John Smith' ? ' selected' : '') + '>John Smith</option>' +
                    '<option value="Mike Johnson"' + (pm.assignedTo === 'Mike Johnson' ? ' selected' : '') + '>Mike Johnson</option>' +
                    '<option value="Sarah Williams"' + (pm.assignedTo === 'Sarah Williams' ? ' selected' : '') + '>Sarah Williams</option>' +
                '</select>';
                return `<div class="${itemClass}">
                    <div class="pm-info">
                        <div class="pm-title">${escHtml(pm.title)}</div>
                        <div class="pm-meta">
                            <div class="wo-meta-item"><span>üè≠</span><span>${escHtml(pm.equipment)}</span></div>
                            <div class="wo-meta-item"><span>üîÑ</span><span>${escHtml(pm.frequency)}</span></div>
                            <div class="wo-meta-item"><span>‚è±Ô∏è</span><span>${escHtml(pm.duration)}</span></div>
                            <div class="wo-meta-item"><span>üë§</span>${assignSelect}</div>
                            ${scheduledBadge}
                            ${checkBadge}
                        </div>
                    </div>
                    <div class="due-date ${dueDateClass}">${escHtml(pm.dueText)}</div>
                    <div style="display:flex;gap:0.5rem;flex-direction:column;align-items:flex-end;">
                        ${actionBtn}
                        <button class="btn btn-secondary btn-small" onclick="openPMDetail('${pm.id}')">View</button>
                        <button class="btn btn-danger btn-small" onclick="deletePM('${pm.id}')">Delete</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderEngineerDashboard() {
            var select = document.getElementById('myTasksEngineerSelect');
            if (!select) return;
            var engineer = select.value;

            // Work Orders assigned to this engineer
            var woContainer = document.getElementById('myTasksWOList');
            var myWOs = workOrdersData.filter(function(wo) { return wo.assignedTo === engineer && wo.status !== 'completed'; });
            if (myWOs.length === 0) {
                woContainer.innerHTML = '<div style="padding:1rem;background:var(--gray-100);border-radius:8px;color:var(--gray-500);">No open work orders assigned.</div>';
            } else {
                woContainer.innerHTML = myWOs.map(function(wo) {
                    var statusLabel = wo.status === 'in-progress' ? 'In Progress' : wo.status === 'on-hold' ? 'On Hold' : 'Open';
                    var priorityColor = wo.priority === 'high' ? 'var(--danger)' : wo.priority === 'medium' ? 'var(--warning)' : 'var(--success)';
                    return '<div style="padding:0.75rem;background:var(--gray-100);border-radius:8px;margin-bottom:0.5rem;border-left:4px solid ' + priorityColor + ';display:flex;justify-content:space-between;align-items:center;">' +
                        '<div>' +
                            '<div style="font-weight:600;">' + escHtml(wo.title) + '</div>' +
                            '<div style="font-size:0.85rem;color:var(--gray-500);">' + escHtml(wo.woId) + ' ¬∑ ' + escHtml(wo.equipment) + ' ¬∑ ' + statusLabel + '</div>' +
                        '</div>' +
                        '<span class="status-badge ' + wo.status + '" style="font-size:0.75rem;">' + wo.priority.toUpperCase() + '</span>' +
                    '</div>';
                }).join('');
            }

            // PMs assigned to this engineer
            var pmContainer = document.getElementById('myTasksPMList');
            var myPMs = pmData.filter(function(pm) { return pm.assignedTo === engineer; });
            if (myPMs.length === 0) {
                pmContainer.innerHTML = '<div style="padding:1rem;background:var(--gray-100);border-radius:8px;color:var(--gray-500);">No PM tasks assigned.</div>';
            } else {
                pmContainer.innerHTML = myPMs.map(function(pm) {
                    var dueBg = pm.dueStatus === 'overdue' ? 'var(--danger)' : pm.dueStatus === 'due-soon' ? 'var(--warning)' : 'var(--primary)';
                    var checkCount = pm.checklist ? pm.checklist.length : 0;
                    var checkBadge = checkCount > 0 ? ' ¬∑ ' + checkCount + ' checks' : '';
                    return '<div style="padding:0.75rem;background:var(--gray-100);border-radius:8px;margin-bottom:0.5rem;border-left:4px solid ' + dueBg + ';display:flex;justify-content:space-between;align-items:center;">' +
                        '<div>' +
                            '<div style="font-weight:600;">' + escHtml(pm.title) + '</div>' +
                            '<div style="font-size:0.85rem;color:var(--gray-500);">' + escHtml(pm.equipment) + ' ¬∑ ' + escHtml(pm.frequency) + checkBadge + '</div>' +
                        '</div>' +
                        '<div style="text-align:right;">' +
                            '<div style="font-size:0.8rem;font-weight:600;color:' + dueBg + ';">' + escHtml(pm.dueText) + '</div>' +
                            '<button class="btn btn-primary btn-small" style="margin-top:0.25rem;font-size:0.75rem;" onclick="completePM(\'' + pm.id + '\')">Complete</button>' +
                        '</div>' +
                    '</div>';
                }).join('');
            }
        }

        function updateKPIs() {
            const openWo = workOrdersData.filter(wo => wo.status === 'open' || wo.status === 'in-progress').length;
            document.getElementById('openWorkOrders').textContent = openWo;
            document.getElementById('totalEquipment').textContent = equipmentList.length;
        }

        function renderProAnalytics() {
            if (!hasAccess('analytics')) return;

            // P2: Parts at Risk
            var riskEl = document.getElementById('partsAtRiskList');
            if (riskEl) {
                var atRisk = partsData.map(function(p) {
                    var months = p.monthlyUsage > 0 ? Math.floor(p.qty / p.monthlyUsage) : -1;
                    return { name: p.name, partNumber: p.partNumber, months: months, qty: p.qty, minStock: p.minStock };
                }).filter(function(p) { return p.months >= 0 && p.months < 4; }).sort(function(a, b) { return a.months - b.months; });
                if (atRisk.length === 0) {
                    riskEl.innerHTML = '<div class="metric-item"><span class="metric-label" style="color:var(--success);">All parts have 4+ months of stock</span></div>';
                } else {
                    riskEl.innerHTML = atRisk.map(function(p) {
                        var color = p.months < 2 ? 'var(--danger)' : 'var(--warning)';
                        return '<div class="metric-item"><span class="metric-label">' + escHtml(p.name) + '</span><span class="metric-value" style="color:' + color + ';">' + (p.months === 0 ? 'This month' : p.months + ' mo') + '</span></div>';
                    }).join('');
                }
            }

            // P3: MTTR & MTBF
            var mttrEl = document.getElementById('mttrMtbfList');
            if (mttrEl) {
                var machineBreakdowns = {};
                breakdownsData.forEach(function(b) {
                    if (!machineBreakdowns[b.machine]) machineBreakdowns[b.machine] = [];
                    machineBreakdowns[b.machine].push(b);
                });
                var html = '';
                Object.keys(machineBreakdowns).forEach(function(machine) {
                    var bds = machineBreakdowns[machine];
                    // MTTR: average time to resolve
                    var resolvedTimes = bds.filter(function(b) { return b.status === 'resolved' && b.timeToResolve; }).map(function(b) {
                        var match = b.timeToResolve.match(/([\d.]+)/);
                        return match ? parseFloat(match[1]) : 0;
                    }).filter(function(t) { return t > 0; });
                    var mttr = resolvedTimes.length > 0 ? (resolvedTimes.reduce(function(a, b) { return a + b; }, 0) / resolvedTimes.length).toFixed(1) : 'N/A';

                    // MTBF: average time between failures
                    var sorted = bds.filter(function(b) { return b.dateISO; }).sort(function(a, b) { return new Date(a.dateISO) - new Date(b.dateISO); });
                    var gaps = [];
                    for (var i = 1; i < sorted.length; i++) {
                        var diff = (new Date(sorted[i].dateISO) - new Date(sorted[i-1].dateISO)) / 86400000;
                        if (diff > 0) gaps.push(diff);
                    }
                    var mtbf = gaps.length > 0 ? Math.round(gaps.reduce(function(a, b) { return a + b; }, 0) / gaps.length) : 'N/A';

                    html += '<div class="metric-item"><span class="metric-label">' + escHtml(machine) + '</span><span class="metric-value" style="font-size:0.9rem;">MTTR: ' + mttr + 'h ¬∑ MTBF: ' + (mtbf === 'N/A' ? mtbf : mtbf + 'd') + '</span></div>';
                });
                mttrEl.innerHTML = html || '<div class="metric-item"><span class="metric-label" style="color:var(--gray-600);">No breakdown data available</span></div>';
            }

            // P4: Technician Workload
            var workloadEl = document.getElementById('techWorkloadList');
            if (workloadEl) {
                var engineers = {};
                workOrdersData.forEach(function(wo) {
                    if (wo.assignedTo && (wo.status === 'open' || wo.status === 'in-progress')) {
                        if (!engineers[wo.assignedTo]) engineers[wo.assignedTo] = { wo: 0, pm: 0 };
                        engineers[wo.assignedTo].wo++;
                    }
                });
                pmData.forEach(function(pm) {
                    if (pm.assignedTo && pm.dueStatus !== 'completed') {
                        if (!engineers[pm.assignedTo]) engineers[pm.assignedTo] = { wo: 0, pm: 0 };
                        engineers[pm.assignedTo].pm++;
                    }
                });
                var wHtml = '';
                Object.keys(engineers).sort().forEach(function(name) {
                    var total = engineers[name].wo + engineers[name].pm;
                    var color = total > 10 ? 'var(--danger)' : total > 5 ? 'var(--warning)' : 'var(--success)';
                    wHtml += '<div class="metric-item"><span class="metric-label">' + escHtml(name) + '</span><span class="metric-value" style="color:' + color + ';">' + engineers[name].wo + ' WO ¬∑ ' + engineers[name].pm + ' PM</span></div>';
                });
                workloadEl.innerHTML = wHtml || '<div class="metric-item"><span class="metric-label" style="color:var(--gray-600);">No assigned tasks</span></div>';
            }

            // P5: Equipment Health Score
            var healthEl = document.getElementById('equipHealthList');
            if (healthEl) {
                var hHtml = '';
                equipmentList.forEach(function(eq) {
                    var score = 100;
                    // Age factor: -2 points per year since install
                    if (eq.installDate) {
                        var years = (new Date() - new Date(eq.installDate + '-01')) / (365.25 * 86400000);
                        score -= Math.min(20, Math.round(years * 2));
                    }
                    // Breakdown frequency: -10 per breakdown in last 90 days
                    var recentBreakdowns = breakdownsData.filter(function(b) {
                        return b.machine === eq.name && b.dateISO && (new Date() - new Date(b.dateISO)) < 90 * 86400000;
                    }).length;
                    score -= Math.min(40, recentBreakdowns * 10);
                    // Status factor
                    if (eq.status === 'down') score -= 20;
                    else if (eq.status === 'maintenance') score -= 10;
                    // Work order load
                    score -= Math.min(15, eq.workOrders30d * 2);
                    // Clamp
                    score = Math.max(0, Math.min(100, score));
                    var color = score >= 80 ? 'var(--success)' : score >= 50 ? 'var(--warning)' : 'var(--danger)';
                    hHtml += '<div class="metric-item"><span class="metric-label">' + escHtml(eq.name) + '</span><span class="metric-value" style="color:' + color + ';">' + score + '/100</span></div>';
                });
                healthEl.innerHTML = hHtml || '<div class="metric-item"><span class="metric-label" style="color:var(--gray-600);">No equipment</span></div>';
            }

            // P6: Labor Costs
            var laborEl = document.getElementById('laborCostList');
            if (laborEl) {
                var laborRates = loadData('laborRates', { 'John Smith': 25.00, 'Mike Johnson': 28.00, 'Sarah Williams': 30.00 });
                var laborByEngineer = {};
                workOrdersData.forEach(function(wo) {
                    if (wo.assignedTo && wo.totalJobTime) {
                        var match = wo.totalJobTime.match(/([\d]+)h\s*([\d]*)m?/);
                        var hours = 0;
                        if (match) { hours = parseFloat(match[1]) + (match[2] ? parseFloat(match[2]) / 60 : 0); }
                        else { var mMatch = wo.totalJobTime.match(/([\d]+)m/); if (mMatch) hours = parseFloat(mMatch[1]) / 60; }
                        if (hours > 0) {
                            if (!laborByEngineer[wo.assignedTo]) laborByEngineer[wo.assignedTo] = 0;
                            laborByEngineer[wo.assignedTo] += hours;
                        }
                    }
                });
                var lHtml = '';
                var totalLaborCost = 0;
                Object.keys(laborByEngineer).forEach(function(name) {
                    var rate = laborRates[name] || 25.00;
                    var cost = laborByEngineer[name] * rate;
                    totalLaborCost += cost;
                    lHtml += '<div class="metric-item"><span class="metric-label">' + escHtml(name) + ' (' + laborByEngineer[name].toFixed(1) + 'h @ ¬£' + rate.toFixed(2) + '/h)</span><span class="metric-value">¬£' + cost.toFixed(2) + '</span></div>';
                });
                if (totalLaborCost > 0) {
                    lHtml += '<div class="metric-item" style="background:var(--primary);color:white;"><span class="metric-label" style="color:white;">Total Labor Cost</span><span class="metric-value" style="color:white;">¬£' + totalLaborCost.toFixed(2) + '</span></div>';
                }
                laborEl.innerHTML = lHtml || '<div class="metric-item"><span class="metric-label" style="color:var(--gray-600);">No time tracked on work orders yet</span></div>';
            }
        }

        function escHtml(str) {
            if (!str) return '';
            return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // TAB SWITCHING
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function switchTab(tabName) {
            if (!hasAccess(tabName)) { tabName = 'workOrders'; }
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // NOTIFICATION FUNCTIONS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('active');
        }

        document.addEventListener('click', function(e) {
            const bell = document.querySelector('.notification-bell');
            const dropdown = document.getElementById('notificationDropdown');
            if (bell && dropdown && !bell.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        function updateNotificationCount() {
            const unreadCount = document.querySelectorAll('.notification-item.unread').length;
            document.getElementById('notificationCount').textContent = unreadCount;
        }

        function handleNotificationClick(tab, id) {
            document.getElementById('notificationDropdown').classList.remove('active');
            switchTabByName(tab);
            if (tab === 'workOrders' && typeof id === 'number') {
                setTimeout(() => openWorkOrderDetail(id), 300);
            }
            event.currentTarget.classList.remove('unread');
            updateNotificationCount();
        }

        function switchTabByName(tabName) {
            if (!hasAccess(tabName)) { tabName = 'workOrders'; }
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            const tabEl = document.getElementById(tabName);
            if (tabEl) tabEl.classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(btn => {
                if (btn.getAttribute('onclick') && btn.getAttribute('onclick').includes("'" + tabName + "'")) {
                    btn.classList.add('active');
                }
            });
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // MODAL FUNCTIONS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) this.classList.remove('active');
                });
            });
        });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // FILE UPLOAD
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let uploadedFiles = [];

        document.addEventListener('DOMContentLoaded', function() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');
            const filePreview = document.getElementById('filePreview');
            if (!fileUploadArea) return;

            fileUploadArea.addEventListener('click', () => fileInput.click());
            fileUploadArea.addEventListener('dragover', e => { e.preventDefault(); fileUploadArea.classList.add('dragging'); });
            fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragging'));
            fileUploadArea.addEventListener('drop', e => { e.preventDefault(); fileUploadArea.classList.remove('dragging'); handleFiles(e.dataTransfer.files); });
            fileInput.addEventListener('change', e => handleFiles(e.target.files));
        });

        function handleFiles(files) {
            const filePreview = document.getElementById('filePreview');
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    uploadedFiles.push(file);
                    const reader = new FileReader();
                    reader.onload = e => {
                        const item = document.createElement('div');
                        item.className = 'file-preview-item';
                        item.innerHTML = `<img src="${e.target.result}" class="file-preview-img"><button class="file-preview-remove" onclick="removeFile(this,'${escHtml(file.name)}')">√ó</button>`;
                        filePreview.appendChild(item);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function removeFile(button, fileName) {
            uploadedFiles = uploadedFiles.filter(f => f.name !== fileName);
            button.parentElement.remove();
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // WORK ORDERS CRUD
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function submitWorkOrder() {
            const equipment = document.getElementById('woEquipment').value;
            const title     = document.getElementById('woTitle').value.trim();
            const desc      = document.getElementById('woDescription').value.trim();
            const priority  = document.getElementById('woPriority').value;
            const assignTo  = document.getElementById('woAssignTo').value;

            if (!equipment || !title || !desc || !priority) {
                showToast('Please fill in all required fields.', 'error');
                return;
            }

            const now = new Date();
            const created = now.toLocaleString('en-GB', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });

            workOrdersData.push({
                id: nextWoId++,
                woId: 'WO-' + String(nextWoId - 1).padStart(4, '0'),
                title, equipment, priority, description: desc,
                status: 'open',
                assignedTo: assignTo,
                createdBy: 'Demo User',
                created,
                hasPhotos: uploadedFiles.length > 0
            });

            renderWorkOrders();
            closeModal('workOrderModal');
            document.getElementById('workOrderForm').reset();
            document.getElementById('filePreview').innerHTML = '';
            uploadedFiles = [];
            persistAllData();
            showToast('‚úÖ Work order created successfully!', 'success');
        }

        function openWorkOrderDetail(woId) {
            const wo = workOrdersData.find(w => w.id === woId);
            if (!wo) return;
            currentDetailWoId = woId;

            document.getElementById('woDetailTitle').textContent = wo.title;
            document.getElementById('woDetailId').textContent = wo.woId;
            document.getElementById('woDetailEquipment').textContent = wo.equipment;

            const priorityColors = { high: ['rgba(255,61,0,0.1)','var(--danger)'], medium: ['rgba(255,179,0,0.1)','var(--warning)'], low: ['rgba(0,200,83,0.1)','var(--success)'] };
            const [bg, col] = priorityColors[wo.priority] || ['var(--gray-200)','var(--dark)'];
            document.getElementById('woDetailPriority').innerHTML = `<span class="status-badge" style="background:${bg};color:${col};">${wo.priority.toUpperCase()}</span>`;
            document.getElementById('woDetailDescription').textContent = wo.description;

            const assignEl = document.getElementById('woDetailAssigned');
            assignEl.textContent = wo.assignedTo || 'Unassigned';
            assignEl.style.color = wo.assignedTo ? 'var(--dark)' : 'var(--danger)';

            const statusLabel = wo.status === 'in-progress' ? 'IN PROGRESS' : wo.status === 'completed' ? 'COMPLETED' : wo.status === 'on-hold' ? 'ON HOLD' : 'OPEN';
            document.getElementById('woDetailStatus').innerHTML = `<span class="status-badge ${wo.status}">${statusLabel}</span>`;
            document.getElementById('woDetailCreated').textContent = wo.created;
            document.getElementById('woDetailCreatedBy').textContent = wo.createdBy;

            document.getElementById('woDetailPhotos').innerHTML = wo.hasPhotos
                ? `<img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect fill='%23E5E5E5' width='150' height='150'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='monospace' font-size='16' fill='%23666'%3Eüì∑ Photo%3C/text%3E%3C/svg%3E" style="width:150px;height:150px;border-radius:8px;border:2px solid var(--gray-300);">`
                : '<div style="color:var(--gray-600);font-style:italic;">No photos attached</div>';

            // Populate time fields
            document.getElementById('woDetailStartTime').value = wo.startTime || '';
            document.getElementById('woDetailFinishTime').value = wo.finishTime || '';
            document.getElementById('woDetailMachineDowntime').value = wo.machineDowntime || '';
            calcWoJobTime();
            // Auto-calc on change
            document.getElementById('woDetailStartTime').onchange = calcWoJobTime;
            document.getElementById('woDetailFinishTime').onchange = calcWoJobTime;

            // Render comments
            renderWoComments(wo);

            // Pre-fill update selects
            const assignSel = document.getElementById('woUpdateAssign');
            const statusSel = document.getElementById('woUpdateStatus');
            if (assignSel) assignSel.value = wo.assignedTo || '';
            if (statusSel) statusSel.value = wo.status;

            openModal('workOrderDetailModal');
        }

        function updateWorkOrder() {
            const wo = workOrdersData.find(w => w.id === currentDetailWoId);
            if (!wo) return;
            const newAssign = document.getElementById('woUpdateAssign').value;
            const newStatus = document.getElementById('woUpdateStatus').value;
            if (newAssign) wo.assignedTo = newAssign;
            if (newStatus) wo.status = newStatus;
            // Save time fields
            wo.startTime = document.getElementById('woDetailStartTime').value;
            wo.finishTime = document.getElementById('woDetailFinishTime').value;
            wo.machineDowntime = document.getElementById('woDetailMachineDowntime').value.trim();
            // Calculate total job time
            if (wo.startTime && wo.finishTime) {
                var diffMs = new Date(wo.finishTime) - new Date(wo.startTime);
                if (diffMs > 0) {
                    var hrs = Math.floor(diffMs / 3600000);
                    var mins = Math.floor((diffMs % 3600000) / 60000);
                    wo.totalJobTime = hrs > 0 ? hrs + 'h ' + mins + 'm' : mins + 'm';
                }
            }
            // Auto-set start time when moving to in-progress
            if (newStatus === 'in-progress' && !wo.startTime) {
                wo.startTime = new Date().toISOString().slice(0, 16);
            }
            // Auto-set finish time when completing
            if (newStatus === 'completed' && !wo.finishTime) {
                wo.finishTime = new Date().toISOString().slice(0, 16);
                if (wo.startTime) {
                    var diffMs2 = new Date(wo.finishTime) - new Date(wo.startTime);
                    if (diffMs2 > 0) {
                        var hrs2 = Math.floor(diffMs2 / 3600000);
                        var mins2 = Math.floor((diffMs2 % 3600000) / 60000);
                        wo.totalJobTime = hrs2 > 0 ? hrs2 + 'h ' + mins2 + 'm' : mins2 + 'm';
                    }
                }
            }
            renderWorkOrders();
            if (typeof renderEngineerDashboard === 'function') renderEngineerDashboard();
            closeModal('workOrderDetailModal');
            persistAllData();
            showToast('‚úÖ Work order updated!', 'success');
        }

        function renderWoComments(wo) {
            var container = document.getElementById('woCommentsContainer');
            if (!container) return;
            if (!wo.comments || wo.comments.length === 0) {
                container.innerHTML = '<div style="color:var(--gray-600);font-style:italic;padding:0.5rem;">No comments yet.</div>';
                return;
            }
            container.innerHTML = wo.comments.map(function(c) {
                return '<div style="padding:0.75rem;background:var(--gray-100);border-radius:8px;border-left:4px solid var(--primary);">' +
                    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.25rem;">' +
                    '<div style="font-weight:600;font-size:0.9rem;">' + escHtml(c.author) + '</div>' +
                    '<div style="font-size:0.8rem;color:var(--gray-600);">' + escHtml(c.timestamp) + '</div>' +
                    '</div>' +
                    '<div style="font-size:0.9rem;line-height:1.5;">' + escHtml(c.text) + '</div>' +
                    '</div>';
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function addWoComment() {
            var input = document.getElementById('woNewComment');
            var text = input.value.trim();
            if (!text) return;
            var wo = workOrdersData.find(function(w) { return w.id === currentDetailWoId; });
            if (!wo) return;
            if (!wo.comments) wo.comments = [];
            var now = new Date();
            var timestamp = now.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' }) + ' - ' + now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            wo.comments.push({ author: currentUserName || 'User', timestamp: timestamp, text: text });
            renderWoComments(wo);
            input.value = '';
            persistAllData();
        }

        function calcWoJobTime() {
            var start = document.getElementById('woDetailStartTime').value;
            var finish = document.getElementById('woDetailFinishTime').value;
            var el = document.getElementById('woDetailTotalJobTime');
            if (start && finish) {
                var diffMs = new Date(finish) - new Date(start);
                if (diffMs > 0) {
                    var hrs = Math.floor(diffMs / 3600000);
                    var mins = Math.floor((diffMs % 3600000) / 60000);
                    el.textContent = hrs > 0 ? hrs + 'h ' + mins + 'm' : mins + 'm';
                    return;
                }
            }
            el.textContent = '‚Äî';
        }

        function deleteWorkOrder(woId) {
            if (!confirm('Delete this work order? This cannot be undone.')) return;
            workOrdersData = workOrdersData.filter(w => w.id !== woId);
            renderWorkOrders();
            persistAllData();
            showToast('Work order deleted.', 'info');
        }

        function showFilterOptions() {
            showToast('Use the search bar above to filter work orders.', 'info');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // EQUIPMENT CRUD
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function submitEquipment() {
            const name    = document.getElementById('addEquipName').value.trim();
            const equipId = document.getElementById('addEquipId').value.trim();
            const mfr     = document.getElementById('addManufacturer').value.trim();
            const model   = document.getElementById('addModel').value.trim();
            const loc     = document.getElementById('addLocation').value.trim();
            const date    = document.getElementById('addInstallDate').value;
            const status  = document.getElementById('addEquipStatus').value;

            if (!name || !equipId || !loc) {
                showToast('Please fill in Name, ID and Location.', 'error');
                return;
            }

            const criticality = document.getElementById('addEquipCriticality').value;
            const warrantyExpiry = document.getElementById('addWarrantyExpiry').value;
            const warrantyProvider = document.getElementById('addWarrantyProvider').value.trim();
            const warrantyNotes = document.getElementById('addWarrantyNotes').value.trim();
            equipmentList.push({ id: nextEquipId++, name, equipId, manufacturer: mfr, model, location: loc, installDate: date || '', status, workOrders30d: 0, criticality, warrantyExpiry, warrantyProvider, warrantyNotes });
            renderEquipment();
            closeModal('equipmentModal');
            document.getElementById('equipmentForm').reset();
            persistAllData();
            showToast('‚úÖ Equipment added successfully!', 'success');
        }

        function openEquipmentHistory(equipId) {
            const eq = equipmentList.find(e => e.id === equipId);
            if (!eq) return;
            document.getElementById('equipHistoryTitle').textContent = eq.name + ' - History';
            var critColors = { A: '#dc2626', B: '#f59e0b', C: '#22c55e' };
            var critLabels = { A: 'Critical', B: 'Important', C: 'Low' };
            var eCrit = eq.criticality || 'B';
            var warrantyHtml = '';
            if (eq.warrantyExpiry) {
                var wDays = Math.ceil((new Date(eq.warrantyExpiry) - new Date()) / 86400000);
                var wStatus = wDays < 0 ? 'Expired' : wDays <= 30 ? 'Expiring Soon' : 'Active';
                var wColor = wDays < 0 ? '#dc2626' : wDays <= 30 ? '#f59e0b' : '#22c55e';
                warrantyHtml = '<div class="form-group"><label class="form-label">Warranty</label><div style="padding:1rem;background:var(--gray-100);border-radius:8px;"><div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;"><div><div style="color:var(--gray-600);font-size:0.9rem;">Status</div><div style="font-weight:600;color:' + wColor + ';">' + wStatus + '</div></div><div><div style="color:var(--gray-600);font-size:0.9rem;">Expiry</div><div style="font-weight:600;">' + escHtml(eq.warrantyExpiry) + '</div></div><div><div style="color:var(--gray-600);font-size:0.9rem;">Provider</div><div style="font-weight:600;">' + escHtml(eq.warrantyProvider || 'N/A') + '</div></div><div><div style="color:var(--gray-600);font-size:0.9rem;">Notes</div><div style="font-weight:600;">' + escHtml(eq.warrantyNotes || '‚Äî') + '</div></div></div></div></div>';
            }
            document.getElementById('equipHistoryContent').innerHTML = `
                <div class="form-group">
                    <label class="form-label">Equipment Information</label>
                    <div style="padding:1rem;background:var(--gray-100);border-radius:8px;">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
                            <div><div style="color:var(--gray-600);font-size:0.9rem;">ID</div><div style="font-weight:600;font-family:'IBM Plex Mono',monospace;">${escHtml(eq.equipId)}</div></div>
                            <div><div style="color:var(--gray-600);font-size:0.9rem;">Manufacturer</div><div style="font-weight:600;">${escHtml(eq.manufacturer)}</div></div>
                            <div><div style="color:var(--gray-600);font-size:0.9rem;">Criticality</div><div style="font-weight:600;color:${critColors[eCrit]};">${eCrit} ‚Äî ${critLabels[eCrit]}</div></div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Maintenance Statistics (Last 30 Days)</label>
                    <div class="stats-grid" style="margin-bottom:0;">
                        <div class="stat-card"><div class="stat-label">Work Orders</div><div class="stat-value" style="font-size:1.5rem;">${eq.workOrders30d}</div></div>
                        <div class="stat-card"><div class="stat-label">Status</div><div class="stat-value" style="font-size:1.2rem;text-transform:capitalize;">${escHtml(eq.status)}</div></div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Location</label>
                    <div style="padding:1rem;background:var(--gray-100);border-radius:8px;">${escHtml(eq.location)}</div>
                </div>
                ${warrantyHtml}`;
            // Add compatible parts section
            var compatParts = partsData.filter(function(p) { return p.compatibleEquipment && p.compatibleEquipment.indexOf(eq.id) !== -1; });
            if (compatParts.length > 0) {
                document.getElementById('equipHistoryContent').innerHTML += '<div class="form-group"><label class="form-label">Compatible Parts</label><div style="display:flex;flex-direction:column;gap:0.5rem;">' +
                    compatParts.map(function(p) {
                        var stock = getStockStatus(p.qty, p.minStock);
                        return '<div style="padding:0.75rem;background:var(--gray-100);border-radius:8px;display:flex;justify-content:space-between;align-items:center;">' +
                            '<div><div style="font-weight:600;">' + escHtml(p.name) + '</div><div style="font-size:0.85rem;color:var(--gray-600);">' + escHtml(p.partNumber) + ' ¬∑ Shelf ' + escHtml(p.shelf) + ', Bin ' + escHtml(p.bin) + '</div></div>' +
                            '<span class="stock-indicator ' + stock.cls + '">' + stock.label + ' (' + p.qty + ')</span>' +
                            '</div>';
                    }).join('') + '</div></div>';
            }
            openModal('equipmentHistoryModal');
        }

        function openEquipmentEdit(equipId) {
            const eq = equipmentList.find(e => e.id === equipId);
            if (!eq) return;
            currentEditEquipId = equipId;
            document.getElementById('editEquipName').value    = eq.name;
            document.getElementById('editEquipId').value      = eq.equipId;
            document.getElementById('editManufacturer').value = eq.manufacturer;
            document.getElementById('editModel').value        = eq.model || '';
            document.getElementById('editLocation').value     = eq.location;
            document.getElementById('editInstallDate').value  = eq.installDate || '';
            document.getElementById('editStatus').value       = eq.status;
            document.getElementById('editEquipCriticality').value = eq.criticality || 'B';
            document.getElementById('editWarrantyExpiry').value   = eq.warrantyExpiry || '';
            document.getElementById('editWarrantyProvider').value = eq.warrantyProvider || '';
            document.getElementById('editWarrantyNotes').value    = eq.warrantyNotes || '';
            openModal('equipmentEditModal');
        }

        function saveEquipmentEdit() {
            const eq = equipmentList.find(e => e.id === currentEditEquipId);
            if (!eq) return;
            eq.name         = document.getElementById('editEquipName').value.trim() || eq.name;
            eq.equipId      = document.getElementById('editEquipId').value.trim() || eq.equipId;
            eq.manufacturer = document.getElementById('editManufacturer').value.trim();
            eq.model        = document.getElementById('editModel').value.trim();
            eq.location     = document.getElementById('editLocation').value.trim() || eq.location;
            eq.installDate  = document.getElementById('editInstallDate').value;
            eq.status       = document.getElementById('editStatus').value;
            eq.criticality     = document.getElementById('editEquipCriticality').value;
            eq.warrantyExpiry  = document.getElementById('editWarrantyExpiry').value;
            eq.warrantyProvider = document.getElementById('editWarrantyProvider').value.trim();
            eq.warrantyNotes   = document.getElementById('editWarrantyNotes').value.trim();
            renderEquipment();
            closeModal('equipmentEditModal');
            persistAllData();
            showToast('‚úÖ Equipment updated!', 'success');
        }

        function deleteEquipment(equipId) {
            const eq = equipmentList.find(e => e.id === equipId);
            if (!eq) return;
            if (!confirm(`Delete "${eq.name}"? This cannot be undone.`)) return;
            equipmentList = equipmentList.filter(e => e.id !== equipId);
            renderEquipment();
            persistAllData();
            showToast('Equipment deleted.', 'info');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // PARTS CRUD
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function capturePendingSupplier() {
            var supplier = document.getElementById('partSupplierName').value;
            var partNo   = document.getElementById('partSupplierPartNo').value.trim();
            if (supplier && partNo) {
                var price    = parseFloat(document.getElementById('partSupplierPrice').value);
                var leadTime = document.getElementById('partSupplierLeadTime').value.trim();
                partSupplierItems.push({ supplier: supplier, supplierPartNo: partNo, price: isNaN(price) ? 0 : price, leadTime: leadTime || '‚Äî' });
                document.getElementById('partSupplierName').value = '';
                document.getElementById('partSupplierPartNo').value = '';
                document.getElementById('partSupplierPrice').value = '';
                document.getElementById('partSupplierLeadTime').value = '';
                renderPartSupplierBuilder();
            }
        }

        function renderPartEquipCheckboxes(selectedIds) {
            var container = document.getElementById('partEquipCheckboxes');
            if (!container) return;
            if (equipmentList.length === 0) { container.innerHTML = '<span style="color:var(--gray-600);font-style:italic;">No equipment added yet.</span>'; return; }
            container.innerHTML = equipmentList.map(function(eq) {
                var checked = (selectedIds || []).indexOf(eq.id) !== -1 ? ' checked' : '';
                return '<label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;"><input type="checkbox" class="partEquipCb" value="' + eq.id + '"' + checked + '> ' + escHtml(eq.name) + ' <span style="color:var(--gray-500);font-size:0.85rem;">(' + escHtml(eq.equipId) + ')</span></label>';
            }).join('');
        }

        function getSelectedPartEquipment() {
            var cbs = document.querySelectorAll('.partEquipCb:checked');
            var ids = [];
            cbs.forEach(function(cb) { ids.push(parseInt(cb.value)); });
            return ids;
        }

        function openAddPartModal() {
            renderPartEquipCheckboxes([]);
            openModal('addPartModal');
        }

        function submitAddPart() {
            const name     = document.getElementById('addPartName').value.trim();
            const number   = document.getElementById('addPartNumber').value.trim();
            const qty      = parseInt(document.getElementById('addPartQty').value) || 0;
            const minStock = parseInt(document.getElementById('addPartMinStock').value) || 0;
            const shelf    = document.getElementById('addPartShelf').value.trim();
            const bin      = document.getElementById('addPartBin').value.trim();

            if (!name || !number) {
                showToast('Part Name and Part Number are required.', 'error');
                return;
            }

            capturePendingSupplier();
            partsData.push({ id: nextPartId++, name, partNumber: number, qty, minStock, shelf, bin, monthlyUsage: 0, compatibleEquipment: getSelectedPartEquipment(), suppliers: partSupplierItems.slice() });
            renderParts();
            closeModal('addPartModal');
            document.getElementById('addPartForm').reset();
            partSupplierItems = [];
            renderPartSupplierBuilder();
            persistAllData();
            showToast('‚úÖ Part added to inventory!', 'success');
        }

        // Edit Part Modal (reuse addPartModal with a flag)
        let editingPartId = null;
        function openEditPart(partId) {
            const p = partsData.find(x => x.id === partId);
            if (!p) return;
            editingPartId = partId;
            document.getElementById('addPartName').value     = p.name;
            document.getElementById('addPartNumber').value   = p.partNumber;
            document.getElementById('addPartQty').value      = p.qty;
            document.getElementById('addPartMinStock').value = p.minStock;
            document.getElementById('addPartShelf').value    = p.shelf;
            document.getElementById('addPartBin').value      = p.bin;
            // Load existing suppliers into builder
            partSupplierItems = (p.suppliers || []).map(function(s) { return { supplier: s.supplier, supplierPartNo: s.supplierPartNo, price: s.price, leadTime: s.leadTime }; });
            renderPartSupplierBuilder();
            // Load compatible equipment checkboxes
            renderPartEquipCheckboxes(p.compatibleEquipment || []);
            // Change modal button behavior temporarily
            const btn = document.querySelector('#addPartModal .modal-footer .btn-primary');
            btn.textContent = 'Save Changes';
            btn.setAttribute('onclick', 'saveEditPart()');
            document.querySelector('#addPartModal .modal-title').textContent = 'Edit Part';
            openModal('addPartModal');
        }

        function saveEditPart() {
            const p = partsData.find(x => x.id === editingPartId);
            if (!p) return;
            p.name     = document.getElementById('addPartName').value.trim() || p.name;
            p.partNumber = document.getElementById('addPartNumber').value.trim() || p.partNumber;
            p.qty      = parseInt(document.getElementById('addPartQty').value) || 0;
            p.minStock = parseInt(document.getElementById('addPartMinStock').value) || 0;
            p.shelf    = document.getElementById('addPartShelf').value.trim();
            p.bin      = document.getElementById('addPartBin').value.trim();
            capturePendingSupplier();
            p.suppliers = partSupplierItems.slice();
            p.compatibleEquipment = getSelectedPartEquipment();
            renderParts();
            closeModal('addPartModal');
            document.getElementById('addPartForm').reset();
            partSupplierItems = [];
            renderPartSupplierBuilder();
            // Reset button
            const btn = document.querySelector('#addPartModal .modal-footer .btn-primary');
            btn.textContent = 'Add Part';
            btn.setAttribute('onclick', 'submitAddPart()');
            document.querySelector('#addPartModal .modal-title').textContent = 'Add New Part';
            editingPartId = null;
            persistAllData();
            showToast('‚úÖ Part updated!', 'success');
        }

        function deletePart(partId) {
            const p = partsData.find(x => x.id === partId);
            if (!p) return;
            if (!confirm(`Delete "${p.name}" from inventory?`)) return;
            partsData = partsData.filter(x => x.id !== partId);
            renderParts();
            persistAllData();
            showToast('Part removed from inventory.', 'info');
        }

        function orderPart(partNumber, partName, isEmergency) {
            window.currentOrder = { partNumber, partName, isEmergency };
            document.getElementById('orderPartName').textContent = partName;
            document.getElementById('orderPartNumber').textContent = partNumber;
            document.getElementById('orderUrgency').textContent = isEmergency ? 'üö® EMERGENCY ORDER' : 'Standard Order';
            document.getElementById('orderUrgency').style.color = isEmergency ? 'var(--danger)' : 'var(--primary)';
            document.getElementById('orderQuantity').value = '';

            // Populate vendor dropdown and supplier panel from part's supplier data
            var part = partsData.find(function(p) { return p.partNumber === partNumber; });
            var suppliers = (part && part.suppliers) ? part.suppliers : [];
            var vendorSelect = document.getElementById('orderVendor');
            var panel = document.getElementById('orderSupplierPanel');

            if (suppliers.length > 0) {
                // Populate vendor dropdown from part's suppliers
                vendorSelect.innerHTML = '<option value="">Choose vendor...</option>' +
                    suppliers.map(function(s) {
                        return '<option value="' + escHtml(s.supplier) + '">' + escHtml(s.supplier) + ' ‚Äî ' + escHtml(s.leadTime) + '</option>';
                    }).join('');

                // Show supplier comparison panel
                panel.innerHTML = '<div style="margin-bottom:1rem;padding:1rem;background:var(--gray-100);border-radius:8px;border-left:4px solid var(--primary);">' +
                    '<div style="font-weight:700;margin-bottom:0.75rem;">Supplier Stock & Pricing</div>' +
                    '<div style="display:flex;flex-direction:column;gap:0.5rem;">' +
                    suppliers.map(function(s) {
                        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0.75rem;background:var(--white);border-radius:6px;border:1px solid var(--gray-200);">' +
                            '<div><strong>' + escHtml(s.supplier) + '</strong><div style="font-size:0.8rem;color:var(--gray-500);font-family:\'IBM Plex Mono\',monospace;">' + escHtml(s.supplierPartNo) + '</div></div>' +
                            '<div style="text-align:right;"><div style="font-weight:700;color:var(--success);">¬£' + s.price.toFixed(2) + '</div><div style="font-size:0.8rem;color:var(--gray-500);">' + escHtml(s.leadTime) + '</div></div>' +
                        '</div>';
                    }).join('') +
                    '</div></div>';
            } else {
                // No suppliers recorded ‚Äî show fallback with hardcoded vendor options
                vendorSelect.innerHTML = '<option value="">Choose vendor...</option>' +
                    '<option value="RS Components">RS Components - Next Day Delivery</option>' +
                    '<option value="Grainger">Grainger - Same Day (if ordered before 2pm)</option>' +
                    '<option value="Motion Industries">Motion Industries - 2-3 Days</option>' +
                    '<option value="Local Supplier">Local Supplier - Pick up today</option>';
                panel.innerHTML = '<div style="margin-bottom:1rem;padding:0.75rem;background:var(--gray-100);border-radius:8px;color:var(--gray-500);font-size:0.9rem;">No supplier information recorded for this part yet. Add suppliers via the part edit form.</div>';
            }

            vendorSelect.value = '';
            openModal('orderPartModal');
        }

        function submitPartOrder() {
            const quantity = document.getElementById('orderQuantity').value;
            const vendor   = document.getElementById('orderVendor').value;
            if (!quantity || !vendor) {
                showToast('Please fill in Quantity and Vendor.', 'error');
                return;
            }
            const order = window.currentOrder;
            const poNumber = 'PO-2026-' + String(nextPoId++).padStart(5, '0');
            const now = new Date();
            const created = now.toLocaleString('en-GB', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });

            purchaseOrdersData.unshift({
                id: purchaseOrdersData.length + 1,
                poNumber,
                title: (order.isEmergency ? 'Emergency Order - ' : 'Parts Order - ') + order.partName,
                vendor: vendor,
                status: 'pending',
                priority: order.isEmergency ? 'high' : 'medium',
                total: 'TBD',
                created,
                items: 1,
                tags: [`${order.partName} (${quantity}x)`],
                tracking: null,
                notes: order.isEmergency ? 'Emergency order' : 'Standard order',
                requestedBy: 'Demo User',
                budgetCode: order.isEmergency ? 'Emergency Repairs' : 'Maintenance Budget'
            });

            renderPurchaseOrders();
            closeModal('orderPartModal');
            document.getElementById('orderPartForm').reset();
            persistAllData();
            showToast(`‚úÖ ${poNumber} created and added to Purchase Orders!`, 'success');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // PURCHASE ORDERS CRUD
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function filterPOs(status) {
            currentPoFilter = status;
            // Update filter button styles
            document.querySelectorAll('#purchaseOrders .btn-secondary.btn-small, #purchaseOrders .btn-primary.btn-small').forEach(btn => {
                btn.style.background = '';
                btn.style.color = '';
                btn.className = 'btn btn-secondary btn-small';
            });
            event.target.style.background = 'var(--primary)';
            event.target.style.color = 'white';
            renderPurchaseOrders();
        }

        function submitCreatePO() {
            const vendorSel = document.querySelector('#createPOForm select');
            const vendor = vendorSel ? vendorSel.value : '';
            if (!vendor) {
                showToast('Please select a vendor.', 'error');
                return;
            }
            const poNumber = 'PO-2026-' + String(nextPoId++).padStart(5, '0');
            const now = new Date();
            const created = now.toLocaleString('en-GB', { day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
            const vendorLabels = { rs: 'RS Components', grainger: 'Grainger', motion: 'Motion Industries', local: 'Local Supplier - BearingMax', other: 'Other Vendor' };

            const lineItems = document.querySelectorAll('#poLineItems .po-line-item');
            let itemCount = 0;
            lineItems.forEach(row => {
                const inputs = row.querySelectorAll('input');
                if (inputs[0] && inputs[0].value.trim()) itemCount++;
            });

            purchaseOrdersData.unshift({
                id: purchaseOrdersData.length + 1,
                poNumber,
                title: 'New Purchase Order',
                vendor: vendorLabels[vendor] || vendor,
                status: 'pending',
                priority: 'medium',
                total: 'TBD',
                created,
                items: itemCount || 1,
                tags: [],
                tracking: null,
                notes: '',
                requestedBy: 'Demo User',
                budgetCode: 'Maintenance Budget'
            });

            renderPurchaseOrders();
            closeModal('createPOModal');
            document.getElementById('createPOForm').reset();
            persistAllData();
            showToast(`‚úÖ ${poNumber} created ‚Äî awaiting approval.`, 'success');
        }

        function addLineItem() {
            const container = document.getElementById('poLineItems');
            const newItem = document.createElement('div');
            newItem.className = 'po-line-item';
            newItem.style.cssText = 'display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:0.5rem;margin-bottom:0.5rem;align-items:center;';
            newItem.innerHTML = `
                <input type="text" class="form-input" placeholder="Part name or description" style="margin:0;">
                <input type="number" class="form-input" placeholder="Qty" min="1" style="margin:0;">
                <input type="number" class="form-input" placeholder="¬£0.00" step="0.01" style="margin:0;">
                <input type="text" class="form-input" placeholder="¬£0.00" readonly style="margin:0;background:var(--gray-200);">
                <button type="button" class="btn btn-danger btn-small" onclick="removeLineItem(this)">‚úï</button>`;
            container.appendChild(newItem);
        }

        function removeLineItem(button) {
            button.parentElement.remove();
        }

        function approvePO(poNumber) {
            if (!confirm(`Approve Purchase Order ${poNumber}?\n\nThis will commit budget funds and send the PO to the vendor.`)) return;
            const po = purchaseOrdersData.find(p => p.poNumber === poNumber);
            if (po) {
                po.status = 'ordered';
                renderPurchaseOrders();
                persistAllData();
                showToast(`‚úÖ ${poNumber} approved and sent to vendor!`, 'success');
            }
        }

        function deletePO(poId) {
            if (!confirm('Delete this purchase order?')) return;
            purchaseOrdersData = purchaseOrdersData.filter(p => p.id !== poId);
            renderPurchaseOrders();
            persistAllData();
            showToast('Purchase order deleted.', 'info');
        }

        function openPODetail(poNumber) {
            const po = purchaseOrdersData.find(p => p.poNumber === poNumber);
            if (!po) return;
            currentDetailPoId = po.id;
            const badge = getPoStatusBadge(po.status);
            document.getElementById('poDetailTitle').textContent = `PO ${po.poNumber}`;
            document.getElementById('poDetailContent').innerHTML = `
                <div class="form-group"><label class="form-label">PO Number</label><div style="font-family:'IBM Plex Mono',monospace;font-size:1.1rem;font-weight:600;">${escHtml(po.poNumber)}</div></div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Vendor</label><div style="font-weight:600;">${escHtml(po.vendor)}</div></div>
                    <div class="form-group"><label class="form-label">Status</label><div><span class="status-badge" style="background:${badge.bg};color:${badge.color};">${badge.label}</span></div></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label class="form-label">Created</label><div>${escHtml(po.created)}</div></div>
                    <div class="form-group"><label class="form-label">Requested By</label><div>${escHtml(po.requestedBy || 'System')}</div></div>
                </div>
                <div class="form-group"><label class="form-label">Budget Code</label><div>${escHtml(po.budgetCode || '‚Äî')}</div></div>
                ${po.tracking ? `<div class="form-group"><label class="form-label">Tracking</label><div style="font-family:'IBM Plex Mono',monospace;">${escHtml(po.tracking)}</div></div>` : ''}
                <div class="form-group"><label class="form-label">Items</label><div style="padding:1rem;background:var(--gray-100);border-radius:8px;">${po.tags && po.tags.length ? po.tags.map(t => `<div style="padding:0.5rem 0;border-bottom:1px solid var(--gray-200);">${escHtml(t)}</div>`).join('') : `<div>${po.items} item(s)</div>`}</div></div>
                <div class="form-group"><label class="form-label">Total</label><div style="font-size:1.25rem;font-weight:700;color:var(--primary);">${escHtml(po.total)}</div></div>
                ${po.notes ? `<div class="form-group"><label class="form-label">Notes</label><div style="padding:1rem;background:var(--gray-100);border-radius:8px;">${escHtml(po.notes)}</div></div>` : ''}`;
            openModal('poDetailModal');
        }

        function downloadPOPDF() {
            var po = purchaseOrdersData.find(function(p) { return p.id === currentDetailPoId; });
            if (!po) { showToast('No PO selected.', 'error'); return; }
            var jsPDF = window.jspdf.jsPDF;
            var doc = new jsPDF();
            var y = 20;
            var leftMargin = 20;
            var labelX = leftMargin;
            var valueX = 70;
            var pageWidth = doc.internal.pageSize.getWidth();

            // Header
            doc.setFillColor(0, 102, 255);
            doc.rect(0, 0, pageWidth, 12, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('CRADERO - MAINTENANCE MANAGEMENT', leftMargin, 8);

            // Title
            y = 24;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('PURCHASE ORDER', leftMargin, y);
            y += 10;
            doc.setTextColor(0, 102, 255);
            doc.setFontSize(14);
            doc.text(po.poNumber, leftMargin, y);
            y += 4;
            doc.setDrawColor(200, 200, 200);
            doc.line(leftMargin, y, pageWidth - leftMargin, y);
            y += 10;

            // Meta fields
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            var fields = [
                ['Vendor:', po.vendor || '-'],
                ['Status:', po.status.toUpperCase()],
                ['Created:', po.created || '-'],
                ['Requested By:', po.requestedBy || '-'],
                ['Budget Code:', po.budgetCode || '-'],
                ['Priority:', po.priority.toUpperCase()]
            ];
            if (po.tracking) fields.push(['Tracking:', po.tracking]);
            if (po.expectedDelivery) fields.push(['Expected Delivery:', po.expectedDelivery]);
            fields.forEach(function(f) {
                doc.setFont(undefined, 'bold');
                doc.text(f[0], labelX, y);
                doc.setFont(undefined, 'normal');
                doc.text(String(f[1]), valueX, y);
                y += 7;
            });

            // Items section
            y += 4;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Items', leftMargin, y);
            y += 6;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            if (po.tags && po.tags.length) {
                po.tags.forEach(function(t, i) {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.setFillColor(245, 245, 245);
                    doc.rect(leftMargin, y - 4, pageWidth - leftMargin * 2, 8, 'F');
                    doc.text((i + 1) + '.  ' + t, leftMargin + 4, y + 1);
                    y += 10;
                });
            } else {
                doc.text(po.items + ' item(s)', leftMargin, y);
                y += 10;
            }

            // Total
            y += 2;
            doc.setFillColor(240, 240, 240);
            doc.rect(leftMargin, y - 5, pageWidth - leftMargin * 2, 12, 'F');
            doc.setFontSize(13);
            doc.setFont(undefined, 'bold');
            doc.text('TOTAL: ' + (po.total || '-'), leftMargin + 4, y + 2);
            y += 16;

            // Notes
            if (po.notes) {
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Notes:', leftMargin, y);
                doc.setFont(undefined, 'normal');
                var noteLines = doc.splitTextToSize(po.notes, pageWidth - leftMargin * 2);
                doc.text(noteLines, leftMargin, y + 6);
                y += 6 + noteLines.length * 5;
            }

            // Footer
            y += 10;
            doc.setDrawColor(220, 220, 220);
            doc.line(leftMargin, y, pageWidth - leftMargin, y);
            y += 5;
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('Generated by Cradero ‚Äî ' + new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' }), leftMargin, y);

            doc.save(po.poNumber + '.pdf');
            showToast('PDF downloaded!', 'success');
        }

        function downloadFile(filename, content, type) {
            var blob = new Blob([content], { type: type });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // PERMITS CRUD
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function submitHotWorkPermit() {
            const desc      = document.getElementById('hwDescription').value.trim();
            const location  = document.getElementById('hwLocation').value.trim();
            const engineer  = document.getElementById('hwEngineer').value;
            const fireWatch = document.getElementById('hwFireWatch').value.trim();
            const startTime = document.getElementById('hwStartTime').value;
            const endTime   = document.getElementById('hwEndTime').value;

            if (!desc || !location || !engineer || !fireWatch || !startTime || !endTime) {
                showToast('Please fill in all required fields.', 'error');
                return;
            }

            hotWorkPermits.push({
                id: nextHwId++,
                title: 'üî• ' + desc,
                location, engineer, fireWatch,
                startTime, endTime,
                status: 'active',
                validText: `Valid: ${startTime} ‚Äì ${endTime} today`,
                expiryText: `Ends at ${endTime}`
            });

            renderHotWorkPermits();
            closeModal('hotWorkPermitModal');
            document.getElementById('hotWorkPermitForm').reset();
            updatePermitStats();
            persistAllData();
            showToast('‚úÖ Hot work permit issued!', 'success');
        }

        function closeHotWorkPermit(id) {
            if (!confirm('Close this hot work permit? It will be moved to the closed permits archive.')) return;
            var permit = hotWorkPermits.find(function(p) { return p.id === id; });
            if (permit) {
                var now = new Date();
                permit.status = 'closed';
                permit.expiryText = 'Closed';
                permit.closedDate = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                permit.closedBy = currentUserName || 'User';
                closedHotWorkPermits.unshift(permit);
            }
            hotWorkPermits = hotWorkPermits.filter(p => p.id !== id);
            renderHotWorkPermits();
            renderClosedPermits();
            updatePermitStats();
            persistAllData();
            showToast('Hot work permit closed and archived.', 'info');
        }

        function submitContractorPermit() {
            const desc       = document.getElementById('cpDescription').value.trim();
            const company    = document.getElementById('cpCompany').value.trim();
            const supervisor = document.getElementById('cpSupervisor').value.trim();
            const phone      = document.getElementById('cpPhone').value.trim();
            const workers    = document.getElementById('cpWorkers').value;
            const location   = document.getElementById('cpLocation').value.trim();
            const startDate  = document.getElementById('cpStartDate').value;
            const endDate    = document.getElementById('cpEndDate').value;
            const insurance  = document.getElementById('cpInsurance').value.trim();

            if (!desc || !company || !supervisor || !location || !startDate || !endDate || !insurance) {
                showToast('Please fill in all required fields.', 'error');
                return;
            }

            const fmt = d => d ? new Date(d + 'T00:00:00').toLocaleString('en-GB', { day:'numeric', month:'short', year:'numeric' }) : d;

            contractorPermits.push({
                id: nextCpId++,
                title: desc + ' - ' + company,
                company, supervisor, phone,
                workers: parseInt(workers) || 1,
                location,
                startDate: fmt(startDate),
                endDate: fmt(endDate),
                insurance,
                scope: desc,
                status: 'Active',
                expiryText: `Expires ${fmt(endDate)}`
            });

            renderContractorPermits();
            closeModal('contractorPermitModal');
            document.getElementById('contractorPermitForm').reset();
            updatePermitStats();
            persistAllData();
            showToast('‚úÖ Contractor permit issued!', 'success');
        }

        function closeContractorPermit(id) {
            if (!confirm('Close this contractor permit? It will be moved to the closed permits archive.')) return;
            var permit = contractorPermits.find(function(p) { return p.id === id; });
            if (permit) {
                var now = new Date();
                permit.status = 'Closed';
                permit.expiryText = 'Closed';
                permit.closedDate = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                permit.closedBy = currentUserName || 'User';
                closedContractorPermits.unshift(permit);
            }
            contractorPermits = contractorPermits.filter(p => p.id !== id);
            renderContractorPermits();
            renderClosedPermits();
            updatePermitStats();
            persistAllData();
            showToast('Contractor permit closed and archived.', 'info');
        }

        function openPermitDetail(type, permitId) {
            if (type === 'contractor') {
                const permit = contractorPermits.find(p => p.id === permitId);
                if (!permit) return;
                currentEditPermitType = type;
                currentEditPermitId = permitId;
                document.getElementById('permitDetailTitle').textContent = 'üë∑ ' + permit.title;
                document.getElementById('permitDetailContent').innerHTML = `
                    <div class="form-group"><label class="form-label">Permit ID</label><div style="font-family:'IBM Plex Mono',monospace;font-weight:600;">CP-${String(permit.id).padStart(4,'0')}</div></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Company</label><div style="font-weight:600;">${escHtml(permit.company)}</div></div>
                        <div class="form-group"><label class="form-label">Status</label><span class="status-badge in-progress">${escHtml(permit.status)}</span></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Supervisor</label><div>${escHtml(permit.supervisor)}</div></div>
                        <div class="form-group"><label class="form-label">Phone</label><div>${escHtml(permit.phone)}</div></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Workers</label><div>${permit.workers}</div></div>
                        <div class="form-group"><label class="form-label">Location</label><div>${escHtml(permit.location)}</div></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">Valid From</label><div>${escHtml(permit.startDate)}</div></div>
                        <div class="form-group"><label class="form-label">Valid Until</label><div>${escHtml(permit.endDate)}</div></div>
                    </div>
                    <div class="form-group"><label class="form-label">Insurance Certificate</label><div style="font-family:'IBM Plex Mono',monospace;font-weight:600;">${escHtml(permit.insurance)}</div></div>
                    <div class="form-group"><label class="form-label">Scope of Work</label><div style="padding:1rem;background:var(--gray-100);border-radius:8px;">${escHtml(permit.scope)}</div></div>
                    <div class="form-group"><label class="form-label">Compliance Checklist</label>
                        <div style="display:flex;flex-direction:column;gap:0.75rem;padding:1rem;background:var(--gray-100);border-radius:8px;">
                            <div>‚úÖ Safety orientation completed</div>
                            <div>‚úÖ Insurance certificate verified</div>
                            <div>‚úÖ Emergency procedures explained</div>
                            <div>‚úÖ PPE requirements communicated</div>
                            <div>‚úÖ Tools and equipment inspected</div>
                        </div>
                    </div>`;
                document.getElementById('permitActionBtn').textContent = 'Revoke Permit';
                openModal('permitDetailModal');
            }
        }

        function revokePermitFromModal() {
            if (!confirm('Revoke/close this permit?')) return;
            if (currentEditPermitType === 'contractor') {
                var permit = contractorPermits.find(function(p) { return p.id === currentEditPermitId; });
                if (permit) {
                    var now = new Date();
                    permit.status = 'Closed';
                    permit.expiryText = 'Closed';
                    permit.closedDate = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    permit.closedBy = currentUserName || 'User';
                    closedContractorPermits.unshift(permit);
                }
                contractorPermits = contractorPermits.filter(p => p.id !== currentEditPermitId);
                renderContractorPermits();
                renderClosedPermits();
                updatePermitStats();
            }
            closeModal('permitDetailModal');
            persistAllData();
            showToast('Permit closed and archived.', 'info');
        }

        function closePermit(type, permitId) {
            if (type === 'hotwork') {
                closeHotWorkPermit(permitId);
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // PERMIT FILTERING & CLOSED PERMITS ARCHIVE
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var currentPermitFilter = 'active';

        function filterPermits(mode) {
            currentPermitFilter = mode;
            var typeFilter = document.getElementById('permitFilterType').value;
            var hwListEl = document.getElementById('hotWorkList');
            var activeHW = hwListEl ? hwListEl.closest('.card') : null;
            var cpListEl = document.getElementById('contractorPermitsList');
            var activeCP = cpListEl ? cpListEl.closest('.card') : null;
            var closedCard = document.getElementById('closedPermitsCard');

            // Reset filter button styles
            ['permitFilterActive', 'permitFilterClosed', 'permitFilterAll'].forEach(function(id) {
                var btn = document.getElementById(id);
                if (btn) { btn.style.background = ''; btn.style.color = ''; btn.className = 'btn btn-secondary btn-small'; }
            });
            var activeBtn = document.getElementById('permitFilter' + mode.charAt(0).toUpperCase() + mode.slice(1));
            if (activeBtn) { activeBtn.style.background = 'var(--primary)'; activeBtn.style.color = 'white'; }

            var showActive = (mode === 'active' || mode === 'all');
            var showClosed = (mode === 'closed' || mode === 'all');

            // Type filter
            var showHW = !typeFilter || typeFilter === 'hotwork';
            var showCP = !typeFilter || typeFilter === 'contractor';

            if (activeHW) activeHW.style.display = (showActive && showHW) ? '' : 'none';
            if (activeCP) activeCP.style.display = (showActive && showCP) ? '' : 'none';
            if (closedCard) closedCard.style.display = showClosed ? '' : 'none';

            if (showClosed) renderClosedPermits();
        }

        function renderClosedPermits() {
            var container = document.getElementById('closedPermitsList');
            if (!container) return;

            var typeFilter = document.getElementById('permitFilterType').value;
            var searchTerm = (document.getElementById('closedPermitSearch') ? document.getElementById('closedPermitSearch').value.trim().toLowerCase() : '');

            var items = [];

            // Closed hot work permits
            if (!typeFilter || typeFilter === 'hotwork') {
                closedHotWorkPermits.forEach(function(p) {
                    items.push({ type: 'hotwork', data: p, sortDate: p.closedDate || '' });
                });
            }

            // Closed contractor permits
            if (!typeFilter || typeFilter === 'contractor') {
                closedContractorPermits.forEach(function(p) {
                    items.push({ type: 'contractor', data: p, sortDate: p.closedDate || '' });
                });
            }

            // Search filter
            if (searchTerm) {
                items = items.filter(function(item) {
                    var d = item.data;
                    var searchable = (d.title + ' ' + (d.company || '') + ' ' + (d.location || '') + ' ' + (d.engineer || '') + ' ' + (d.supervisor || '') + ' ' + (d.closedDate || '')).toLowerCase();
                    return searchable.indexOf(searchTerm) !== -1;
                });
            }

            if (items.length === 0) {
                container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--gray-600);">No closed permits found.</div>';
                return;
            }

            container.innerHTML = items.map(function(item) {
                var p = item.data;
                if (item.type === 'hotwork') {
                    return '<div class="work-order-item" style="border-left: 6px solid var(--gray-400); opacity: 0.85;">' +
                        '<div class="wo-priority" style="background: var(--gray-400);"></div>' +
                        '<div class="wo-details">' +
                            '<div class="wo-title">' + escHtml(p.title) + '</div>' +
                            '<div class="wo-meta">' +
                                '<div class="wo-meta-item"><span>üè≠</span><span>' + escHtml(p.location) + '</span></div>' +
                                '<div class="wo-meta-item"><span>üë§</span><span>' + escHtml(p.engineer) + '</span></div>' +
                                '<div class="wo-meta-item"><span>üî•</span><span>Fire Watch: ' + escHtml(p.fireWatch) + '</span></div>' +
                                '<div class="wo-meta-item"><span>‚è±Ô∏è</span><span>' + escHtml(p.startTime) + ' ‚Äì ' + escHtml(p.endTime) + '</span></div>' +
                            '</div>' +
                            '<div class="wo-meta" style="margin-top: 0.5rem;">' +
                                '<div class="wo-meta-item"><span>üìÖ</span><span>Closed: ' + escHtml(p.closedDate) + '</span></div>' +
                                (p.closedBy ? '<div class="wo-meta-item"><span>üë§</span><span>Closed by: ' + escHtml(p.closedBy) + '</span></div>' : '') +
                            '</div>' +
                        '</div>' +
                        '<div class="status-badge" style="background: var(--gray-200); color: var(--gray-700);">CLOSED</div>' +
                        '<span style="font-size: 0.8rem; color: var(--gray-500); padding: 0.5rem;">Hot Work</span>' +
                    '</div>';
                } else {
                    return '<div class="work-order-item" style="border-left: 6px solid var(--gray-400); opacity: 0.85;">' +
                        '<div class="wo-priority" style="background: var(--gray-400);"></div>' +
                        '<div class="wo-details">' +
                            '<div class="wo-title">' + escHtml(p.title) + '</div>' +
                            '<div class="wo-meta">' +
                                '<div class="wo-meta-item"><span>üè¢</span><span>' + escHtml(p.company) + '</span></div>' +
                                '<div class="wo-meta-item"><span>üë§</span><span>Supervisor: ' + escHtml(p.supervisor) + '</span></div>' +
                                '<div class="wo-meta-item"><span>üè≠</span><span>' + escHtml(p.location) + '</span></div>' +
                                '<div class="wo-meta-item"><span>üìÖ</span><span>' + escHtml(p.startDate) + ' ‚Äì ' + escHtml(p.endDate) + '</span></div>' +
                            '</div>' +
                            '<div class="wo-meta" style="margin-top: 0.5rem;">' +
                                '<div class="wo-meta-item"><span>üìÖ</span><span>Closed: ' + escHtml(p.closedDate) + '</span></div>' +
                                (p.closedBy ? '<div class="wo-meta-item"><span>üë§</span><span>Closed by: ' + escHtml(p.closedBy) + '</span></div>' : '') +
                                '<div class="wo-meta-item"><span>üìã</span><span>Insurance: ' + escHtml(p.insurance) + '</span></div>' +
                            '</div>' +
                            (p.scope ? '<div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--gray-600); line-height: 1.5;">' + escHtml(p.scope) + '</div>' : '') +
                        '</div>' +
                        '<div class="status-badge" style="background: var(--gray-200); color: var(--gray-700);">CLOSED</div>' +
                        '<span style="font-size: 0.8rem; color: var(--gray-500); padding: 0.5rem;">Contractor</span>' +
                    '</div>';
                }
            }).join('');
        }

        function updatePermitStats() {
            var activeTotal = hotWorkPermits.length + contractorPermits.length;
            var closedTotal = closedHotWorkPermits.length + closedContractorPermits.length;

            var el = document.getElementById('permitStatActive');
            if (el) el.textContent = activeTotal;
            var noteEl = document.getElementById('permitStatActiveNote');
            if (noteEl) noteEl.textContent = activeTotal === 0 ? 'No active permits' : activeTotal + ' currently active';

            var hwEl = document.getElementById('permitStatHW');
            if (hwEl) hwEl.textContent = hotWorkPermits.length;
            var hwNote = document.getElementById('permitStatHWNote');
            if (hwNote) hwNote.textContent = hotWorkPermits.length === 0 ? 'None active' : hotWorkPermits.length + ' active';

            var cpEl = document.getElementById('permitStatCP');
            if (cpEl) cpEl.textContent = contractorPermits.length;
            var cpNote = document.getElementById('permitStatCPNote');
            if (cpNote) cpNote.textContent = contractorPermits.length === 0 ? 'None active' : 'All valid';

            var clEl = document.getElementById('permitStatClosed');
            if (clEl) clEl.textContent = closedTotal;
            var clNote = document.getElementById('permitStatClosedNote');
            if (clNote) clNote.textContent = 'Available for audit';
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // WORK REQUESTS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function renderWorkRequests(data) {
            var container = document.getElementById('workRequestsList');
            if (!container) return;
            var list = data || workRequestsData;
            if (list.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìã</div><div class="empty-state-title">No Requests</div><div class="empty-state-text">' + (data ? 'No requests match your filters.' : 'No maintenance requests have been submitted yet.') + '</div></div>';
                // Still update badge from full data
                var pending = workRequestsData.filter(function(r) { return r.status === 'pending'; }).length;
                var tab = document.getElementById('workRequestsTab');
                if (tab) tab.textContent = 'Work Requests' + (pending > 0 ? ' (' + pending + ')' : '');
                return;
            }
            var isAdminOrManager = currentUserRole === 'admin' || currentUserRole === 'manager';
            container.innerHTML = list.map(function(req) {
                var urgColors = { high: 'var(--danger)', medium: 'var(--warning)', low: 'var(--success)' };
                var urgLabels = { high: 'HIGH', medium: 'MEDIUM', low: 'LOW' };
                var statusBadge = req.status === 'pending' ? '<span class="status-badge" style="background:rgba(0,102,255,0.1);color:var(--primary);">PENDING</span>' :
                    req.status === 'approved' ? '<span class="status-badge" style="background:rgba(0,200,83,0.1);color:var(--success);">APPROVED</span>' :
                    '<span class="status-badge" style="background:rgba(220,38,38,0.1);color:var(--danger);">DECLINED</span>';
                var actions = '';
                if (isAdminOrManager && req.status === 'pending') {
                    actions = '<div style="display:flex;gap:0.5rem;align-items:center;margin-top:0.75rem;flex-wrap:wrap;">' +
                        '<select class="form-select" id="reqAssign_' + req.id + '" style="min-width:160px;flex:1;">' +
                        '<option value="">Assign to engineer...</option>' +
                        '<option value="John Smith">John Smith</option>' +
                        '<option value="Mike Johnson">Mike Johnson</option>' +
                        '<option value="Sarah Williams">Sarah Williams</option>' +
                        '</select>' +
                        '<button class="btn btn-success btn-small" onclick="approveRequest(' + req.id + ')">Approve & Create WO</button>' +
                        '<button class="btn btn-danger btn-small" onclick="declineRequest(' + req.id + ')">Decline</button>' +
                        '</div>';
                }
                if (req.status === 'approved' && req.approvedWoId) {
                    actions = '<div style="margin-top:0.5rem;font-size:0.85rem;color:var(--success);font-weight:600;">Created as ' + escHtml(req.approvedWoId) + (req.assignedTo ? ' ‚Äî Assigned to ' + escHtml(req.assignedTo) : '') + '</div>';
                }
                return '<div style="padding:1rem;background:var(--gray-100);border-radius:8px;margin-bottom:0.75rem;border-left:4px solid ' + (urgColors[req.urgency] || 'var(--gray-400)') + ';">' +
                    '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:0.5rem;">' +
                    '<div><div style="font-weight:700;">' + escHtml(req.equipment) + '</div><div style="font-size:0.85rem;color:var(--gray-600);">Submitted by ' + escHtml(req.submitter || 'Unknown') + ' ¬∑ ' + escHtml(req.submitted) + '</div></div>' +
                    '<div style="display:flex;gap:0.5rem;align-items:center;">' +
                    '<span class="status-badge" style="background:' + urgColors[req.urgency] + '15;color:' + urgColors[req.urgency] + ';">' + urgLabels[req.urgency] + '</span>' +
                    statusBadge +
                    '</div></div>' +
                    '<div style="line-height:1.5;">' + escHtml(req.description) + '</div>' +
                    actions +
                    '</div>';
            }).join('');
            // Update pending count badge
            var pending = workRequestsData.filter(function(r) { return r.status === 'pending'; }).length;
            var tab = document.getElementById('workRequestsTab');
            if (tab) tab.textContent = 'Work Requests' + (pending > 0 ? ' (' + pending + ')' : '');
        }

        function submitWorkRequest() {
            var equipment = document.getElementById('requestEquipment').value;
            var description = document.getElementById('requestDescription').value.trim();
            var urgency = document.getElementById('requestUrgency').value;
            var submitter = document.getElementById('requestSubmitter').value.trim() || currentUserName || 'Unknown';
            if (!equipment || !description) { showToast('Please select equipment and describe the issue.', 'error'); return; }
            var now = new Date();
            var timestamp = now.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' }) + ' - ' + now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            workRequestsData.push({ id: nextRequestId++, equipment: equipment, description: description, urgency: urgency, submitter: submitter, submitted: timestamp, status: 'pending' });
            saveData('workRequests', workRequestsData);
            saveData('nextRequestId', nextRequestId);
            closeModal('submitRequestModal');
            document.getElementById('requestForm').reset();
            renderWorkRequests();
            showToast('Maintenance request submitted!', 'success');
        }

        function approveRequest(reqId) {
            var req = workRequestsData.find(function(r) { return r.id === reqId; });
            if (!req) return;
            // Get assigned engineer from dropdown
            var assignSel = document.getElementById('reqAssign_' + reqId);
            var assignedTo = assignSel ? assignSel.value : '';
            req.status = 'approved';
            req.assignedTo = assignedTo;
            // Create a work order from this request
            var now = new Date();
            var timestamp = now.toLocaleDateString('en-GB', { month: 'short', day: 'numeric', year: 'numeric' }) + ' - ' + now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            var woIdStr = 'WO-' + now.getFullYear() + '-' + String(nextWoId).padStart(3, '0');
            workOrdersData.push({
                id: nextWoId++, woId: woIdStr, title: req.equipment + ' - ' + req.description.substring(0, 50),
                equipment: req.equipment, priority: req.urgency, status: 'open', assignedTo: assignedTo,
                createdBy: currentUserName || 'System', created: timestamp,
                description: 'From maintenance request by ' + req.submitter + ':\n\n' + req.description,
                hasPhotos: false, comments: [], startTime: '', finishTime: '', totalJobTime: '', machineDowntime: ''
            });
            req.approvedWoId = woIdStr;
            saveData('nextWoId', nextWoId);
            saveData('workRequests', workRequestsData);
            persistAllData();
            renderWorkRequests();
            renderWorkOrders();
            if (typeof renderEngineerDashboard === 'function') renderEngineerDashboard();
            var msg = 'Request approved ‚Äî Work Order ' + woIdStr + ' created!';
            if (assignedTo) msg += ' Assigned to ' + assignedTo + '.';
            showToast(msg, 'success');
        }

        function declineRequest(reqId) {
            var req = workRequestsData.find(function(r) { return r.id === reqId; });
            if (!req) return;
            if (!confirm('Decline this maintenance request?')) return;
            req.status = 'declined';
            saveData('workRequests', workRequestsData);
            renderWorkRequests();
            showToast('Request declined.', 'info');
        }

        function populateRequestEquipDropdown() {
            var sel = document.getElementById('requestEquipment');
            if (!sel) return;
            sel.innerHTML = '<option value="">Select equipment...</option>';
            equipmentList.forEach(function(eq) {
                sel.innerHTML += '<option value="' + escHtml(eq.name) + '">' + escHtml(eq.name) + ' (' + escHtml(eq.equipId) + ')</option>';
            });
        }

        function filterWorkRequests() {
            var status = document.getElementById('reqFilterStatus').value;
            var urgency = document.getElementById('reqFilterUrgency').value;
            var filtered = workRequestsData.filter(function(r) {
                if (status && r.status !== status) return false;
                if (urgency && r.urgency !== urgency) return false;
                return true;
            });
            renderWorkRequests(filtered);
        }

        function clearRequestFilter() {
            document.getElementById('reqFilterStatus').value = '';
            document.getElementById('reqFilterUrgency').value = '';
            renderWorkRequests();
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // PART SUPPLIER BUILDER
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var partSupplierItems = [];

        function addPartSupplier() {
            var supplier    = document.getElementById('partSupplierName').value;
            var partNo      = document.getElementById('partSupplierPartNo').value.trim();
            var price       = parseFloat(document.getElementById('partSupplierPrice').value);
            var leadTime    = document.getElementById('partSupplierLeadTime').value.trim();
            if (!supplier) { showToast('Please select a supplier.', 'error'); return; }
            if (!partNo) { showToast('Please enter a supplier part number.', 'error'); return; }
            partSupplierItems.push({ supplier: supplier, supplierPartNo: partNo, price: isNaN(price) ? 0 : price, leadTime: leadTime || '‚Äî' });
            document.getElementById('partSupplierName').value = '';
            document.getElementById('partSupplierPartNo').value = '';
            document.getElementById('partSupplierPrice').value = '';
            document.getElementById('partSupplierLeadTime').value = '';
            renderPartSupplierBuilder();
        }

        function removePartSupplier(idx) {
            partSupplierItems.splice(idx, 1);
            renderPartSupplierBuilder();
        }

        function renderPartSupplierBuilder() {
            var container = document.getElementById('partSupplierBuilder');
            if (!container) return;
            if (partSupplierItems.length === 0) { container.innerHTML = ''; return; }
            container.innerHTML = partSupplierItems.map(function(s, i) {
                return '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:var(--gray-100);border-radius:6px;margin-bottom:0.5rem;">' +
                    '<span style="flex:1;"><strong>' + escHtml(s.supplier) + '</strong> ¬∑ ' + escHtml(s.supplierPartNo) + ' ¬∑ ¬£' + s.price.toFixed(2) + ' ¬∑ ' + escHtml(s.leadTime) + '</span>' +
                    '<button type="button" onclick="removePartSupplier(' + i + ')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:1.1rem;">‚úï</button>' +
                '</div>';
            }).join('');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // PM CRUD
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // PM Checklist builder helpers
        var pmChecklistItems = [];

        function addPMChecklistItem() {
            var input = document.getElementById('pmChecklistInput');
            var text = input.value.trim();
            if (!text) { showToast('Enter a checklist item.', 'error'); return; }
            pmChecklistItems.push(text);
            input.value = '';
            input.focus();
            renderPMChecklistBuilder();
        }

        function removePMChecklistItem(idx) {
            pmChecklistItems.splice(idx, 1);
            renderPMChecklistBuilder();
        }

        function renderPMChecklistBuilder() {
            var container = document.getElementById('pmChecklistBuilder');
            if (!container) return;
            if (pmChecklistItems.length === 0) { container.innerHTML = ''; return; }
            container.innerHTML = pmChecklistItems.map(function(item, i) {
                return '<div style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:var(--gray-100);border-radius:6px;">' +
                    '<span style="color:var(--primary);font-weight:600;">' + (i + 1) + '.</span>' +
                    '<span style="flex:1;">' + escHtml(item) + '</span>' +
                    '<button type="button" onclick="removePMChecklistItem(' + i + ')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:1.1rem;padding:0 4px;">‚úï</button>' +
                '</div>';
            }).join('');
        }

        function submitAddPM() {
            const taskName    = document.getElementById('pmTaskName').value.trim();
            const equipment   = document.getElementById('pmEquipment').value;
            const description = document.getElementById('pmDescription').value.trim();
            const frequency   = document.getElementById('pmFrequency').value;
            const duration    = document.getElementById('pmDuration').value.trim();
            const assignTo    = document.getElementById('pmAssignTo').value;
            const dueDate     = document.getElementById('pmDueDate').value;

            if (!taskName || !equipment || !frequency || !assignTo || !dueDate) {
                showToast('Please fill in all required fields.', 'error');
                return;
            }

            if (pmChecklistItems.length === 0) {
                showToast('Please add at least one checklist item.', 'error');
                return;
            }

            const today = new Date();
            const due   = new Date(dueDate + 'T00:00:00');
            const diff  = Math.ceil((due - today) / 86400000);
            let dueStatus = 'upcoming', dueText = `Due in ${diff} days`;
            if (diff < 0)      { dueStatus = 'overdue';  dueText = `Overdue by ${Math.abs(diff)} day(s)`; }
            else if (diff <= 3){ dueStatus = 'due-soon'; dueText = diff === 0 ? 'Due today' : diff === 1 ? 'Due tomorrow' : `Due in ${diff} days`; }

            var checklist = pmChecklistItems.map(function(text) {
                return { text: text, checked: false, note: '' };
            });

            pmData.push({
                id: 'pm-' + (nextPmId++),
                title: taskName,
                equipment, frequency, description,
                duration: duration || '‚Äî',
                assignedTo: assignTo,
                dueStatus, dueText,
                status: dueStatus,
                lastCompleted: '‚Äî',
                scheduledDate: dueDate,
                checklist: checklist
            });

            // Auto-create calendar event for the scheduled PM
            if (dueDate) {
                var calType = frequency.toLowerCase().indexOf('week') !== -1 ? 'weekly-pm' : 'monthly-pm';
                calendarEvents.push({
                    id: nextCalId++,
                    title: taskName,
                    equipment: equipment,
                    type: calType,
                    date: dueDate,
                    duration: duration || '30 min',
                    assignedTo: assignTo,
                    notes: 'Auto-scheduled PM',
                    status: 'planned'
                });
            }

            renderPM();
            renderCalendar();
            closeModal('addPMModal');
            document.getElementById('addPMForm').reset();
            pmChecklistItems = [];
            renderPMChecklistBuilder();
            persistAllData();
            showToast('‚úÖ PM task scheduled!', 'success');
        }

        var currentCompletePMId = null;

        function completePM(pmId) {
            var pm = pmData.find(function(p) { return p.id === pmId; });
            if (!pm) return;
            currentCompletePMId = pmId;

            // Reset checklist checked state for fresh completion
            var checklist = pm.checklist || [];
            checklist.forEach(function(item) { item.checked = false; item.note = ''; });

            var body = document.getElementById('completePMBody');
            var nowStr = new Date().toTimeString().slice(0,5);
            var html = '<div style="margin-bottom:1.5rem;">' +
                '<div style="font-weight:700;font-size:1.1rem;margin-bottom:0.25rem;">' + escHtml(pm.title) + '</div>' +
                '<div style="color:var(--gray-500);font-size:0.9rem;">' +
                    '<span>üè≠ ' + escHtml(pm.equipment) + '</span> &nbsp;¬∑&nbsp; ' +
                    '<span>üë§ ' + escHtml(pm.assignedTo) + '</span> &nbsp;¬∑&nbsp; ' +
                    '<span>üîÑ ' + escHtml(pm.frequency) + '</span>' +
                '</div>' +
                (pm.description ? '<div style="margin-top:0.5rem;color:var(--gray-600);font-size:0.9rem;">' + escHtml(pm.description) + '</div>' : '') +
            '</div>' +
            '<div style="display:flex;gap:1rem;margin-bottom:1.5rem;">' +
                '<div style="flex:1;"><label style="font-weight:600;font-size:0.85rem;display:block;margin-bottom:0.25rem;">Start Time *</label>' +
                '<input type="time" id="pmStartTime" class="form-input" value="' + nowStr + '" required></div>' +
                '<div style="flex:1;"><label style="font-weight:600;font-size:0.85rem;display:block;margin-bottom:0.25rem;">Finish Time *</label>' +
                '<input type="time" id="pmFinishTime" class="form-input" required></div>' +
            '</div>';

            if (checklist.length === 0) {
                html += '<div style="padding:1rem;background:var(--gray-100);border-radius:8px;color:var(--gray-500);">No checklist items defined for this task.</div>';
            } else {
                html += '<div style="font-weight:600;margin-bottom:0.75rem;">Checklist ‚Äî tick off each item as you complete it:</div>';
                html += '<div style="display:flex;flex-direction:column;gap:0.75rem;">';
                checklist.forEach(function(item, i) {
                    html += '<div style="padding:0.75rem;background:var(--gray-100);border-radius:8px;border-left:3px solid var(--gray-300);" id="pmCheckItem' + i + '">' +
                        '<label style="display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-weight:500;">' +
                            '<input type="checkbox" onchange="togglePMCheck(' + i + ')" style="width:18px;height:18px;cursor:pointer;">' +
                            '<span>' + escHtml(item.text) + '</span>' +
                        '</label>' +
                        '<input type="text" placeholder="Add a note (optional)..." ' +
                            'onchange="updatePMCheckNote(' + i + ', this.value)" ' +
                            'style="margin-top:0.5rem;width:100%;padding:0.4rem 0.6rem;border:1px solid var(--gray-300);border-radius:6px;font-size:0.85rem;">' +
                    '</div>';
                });
                html += '</div>';
            }

            body.innerHTML = html;
            document.getElementById('completePMSubmitBtn').disabled = checklist.length > 0;
            openModal('completePMModal');
        }

        function togglePMCheck(idx) {
            var pm = pmData.find(function(p) { return p.id === currentCompletePMId; });
            if (!pm || !pm.checklist) return;
            pm.checklist[idx].checked = !pm.checklist[idx].checked;

            // Update visual style
            var itemEl = document.getElementById('pmCheckItem' + idx);
            if (itemEl) {
                itemEl.style.borderLeftColor = pm.checklist[idx].checked ? 'var(--success)' : 'var(--gray-300)';
                itemEl.style.background = pm.checklist[idx].checked ? '#f0fdf4' : 'var(--gray-100)';
            }

            // Enable/disable complete button based on all items checked
            var allChecked = pm.checklist.every(function(item) { return item.checked; });
            document.getElementById('completePMSubmitBtn').disabled = !allChecked;
        }

        function updatePMCheckNote(idx, note) {
            var pm = pmData.find(function(p) { return p.id === currentCompletePMId; });
            if (!pm || !pm.checklist) return;
            pm.checklist[idx].note = note;
        }

        function submitCompletePM() {
            var pm = pmData.find(function(p) { return p.id === currentCompletePMId; });
            if (!pm) return;

            // Verify all checked
            if (pm.checklist && pm.checklist.length > 0) {
                var allChecked = pm.checklist.every(function(item) { return item.checked; });
                if (!allChecked) { showToast('Please complete all checklist items.', 'error'); return; }
            }

            var startTime = document.getElementById('pmStartTime').value;
            var finishTime = document.getElementById('pmFinishTime').value;
            if (!startTime || !finishTime) { showToast('Please enter start and finish times.', 'error'); return; }

            var now = new Date().toLocaleString('en-GB', { day:'numeric', month:'short', year:'numeric' });
            pm.status = 'completed';
            pm.dueStatus = 'completed';
            pm.lastCompleted = now;
            pm.dueText = 'Completed: ' + now;
            pm.lastChecklistResults = JSON.parse(JSON.stringify(pm.checklist || []));
            pm.completedBy = pm.assignedTo;
            pm.completedAt = now;
            pm.lastStartTime = startTime;
            pm.lastFinishTime = finishTime;

            // Reset checklist for next time
            if (pm.checklist) {
                pm.checklist.forEach(function(item) { item.checked = false; item.note = ''; });
            }

            closeModal('completePMModal');
            renderPM();
            if (typeof renderEngineerDashboard === 'function') renderEngineerDashboard();
            persistAllData();
            currentCompletePMId = null;
            showToast('‚úÖ "' + pm.title + '" completed with all checks verified!', 'success');
        }

        function openPMDetail(pmId) {
            var pm = pmData.find(function(p) { return p.id === pmId; });
            if (!pm) return;

            var body = document.getElementById('pmDetailBody');
            var html = '<div style="margin-bottom:1.5rem;">' +
                '<div style="font-weight:700;font-size:1.1rem;margin-bottom:0.25rem;">' + escHtml(pm.title) + '</div>' +
                '<div style="color:var(--gray-500);font-size:0.9rem;">' +
                    '<span>üè≠ ' + escHtml(pm.equipment) + '</span> &nbsp;¬∑&nbsp; ' +
                    '<span>üë§ ' + escHtml(pm.assignedTo) + '</span> &nbsp;¬∑&nbsp; ' +
                    '<span>üîÑ ' + escHtml(pm.frequency) + '</span> &nbsp;¬∑&nbsp; ' +
                    '<span>‚è±Ô∏è ' + escHtml(pm.duration) + '</span>' +
                '</div>' +
                (pm.description ? '<div style="margin-top:0.5rem;color:var(--gray-600);font-size:0.9rem;">' + escHtml(pm.description) + '</div>' : '') +
            '</div>';

            // Show last completion info
            if (pm.lastCompleted && pm.lastCompleted !== '‚Äî') {
                html += '<div style="padding:0.75rem;background:#f0fdf4;border-radius:8px;margin-bottom:1rem;font-size:0.9rem;">' +
                    '<strong>Last completed:</strong> ' + escHtml(pm.lastCompleted) +
                    (pm.completedBy ? ' by ' + escHtml(pm.completedBy) : '') +
                    (pm.lastStartTime ? ' &nbsp;¬∑&nbsp; <strong>Start:</strong> ' + escHtml(pm.lastStartTime) : '') +
                    (pm.lastFinishTime ? ' &nbsp;¬∑&nbsp; <strong>Finish:</strong> ' + escHtml(pm.lastFinishTime) : '') +
                '</div>';
            }

            // Show checklist template
            var checklist = pm.checklist || [];
            var lastResults = pm.lastChecklistResults || [];

            if (lastResults.length > 0) {
                html += '<div style="font-weight:600;margin-bottom:0.75rem;">Last Completion Checklist:</div>';
                html += '<div style="display:flex;flex-direction:column;gap:0.5rem;padding:1rem;background:var(--gray-100);border-radius:8px;">';
                lastResults.forEach(function(item) {
                    html += '<div style="display:flex;align-items:flex-start;gap:0.5rem;">' +
                        '<span style="color:var(--success);font-size:1.1rem;">‚úÖ</span>' +
                        '<div><span style="font-weight:500;">' + escHtml(item.text) + '</span>' +
                        (item.note ? '<div style="color:var(--gray-500);font-size:0.85rem;margin-top:2px;">üìù ' + escHtml(item.note) + '</div>' : '') +
                        '</div></div>';
                });
                html += '</div>';
            } else if (checklist.length > 0) {
                html += '<div style="font-weight:600;margin-bottom:0.75rem;">Checklist (' + checklist.length + ' items):</div>';
                html += '<div style="display:flex;flex-direction:column;gap:0.5rem;padding:1rem;background:var(--gray-100);border-radius:8px;">';
                checklist.forEach(function(item) {
                    html += '<div style="display:flex;align-items:center;gap:0.5rem;">' +
                        '<span style="color:var(--gray-400);">‚òê</span>' +
                        '<span>' + escHtml(item.text) + '</span>' +
                    '</div>';
                });
                html += '</div>';
            }

            body.innerHTML = html;
            openModal('pmDetailModal');
        }

        function schedulePM(pmId) {
            showToast('In a live system, this would open a calendar to schedule the task.', 'info');
        }

        function reassignPM(pmId, newEngineer) {
            var pm = pmData.find(function(p) { return p.id === pmId; });
            if (!pm) return;
            pm.assignedTo = newEngineer;
            persistAllData();
            showToast('PM reassigned to ' + newEngineer + '.', 'success');
            if (typeof renderEngineerDashboard === 'function') renderEngineerDashboard();
        }

        function deletePM(pmId) {
            if (!confirm('Delete this PM task?')) return;
            pmData = pmData.filter(p => p.id !== pmId);
            renderPM();
            persistAllData();
            showToast('PM task removed.', 'info');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ANALYTICS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function toggleExportMenu() {
            var menu = document.getElementById('exportMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
        // Close export menu on outside click
        document.addEventListener('click', function(e) {
            var menu = document.getElementById('exportMenu');
            if (menu && !e.target.closest('#exportMenu') && !e.target.closest('[onclick*="toggleExportMenu"]')) menu.style.display = 'none';
        });

        function csvEscape(val) {
            var s = String(val == null ? '' : val);
            if (s.indexOf(',') !== -1 || s.indexOf('"') !== -1 || s.indexOf('\n') !== -1) return '"' + s.replace(/"/g, '""') + '"';
            return s;
        }

        function buildCSV(headers, rows) {
            return headers.join(',') + '\n' + rows.map(function(r) { return r.map(csvEscape).join(','); }).join('\n');
        }

        function exportCSV(type) {
            var csv = '', filename = '';
            var today = new Date().toISOString().slice(0, 10);
            if (type === 'workOrders') {
                filename = 'work-orders-' + today + '.csv';
                csv = buildCSV(['WO ID','Title','Equipment','Priority','Status','Assigned To','Created By','Created','Start Time','Finish Time','Total Job Time','Machine Downtime'],
                    workOrdersData.map(function(w) { return [w.woId, w.title, w.equipment, w.priority, w.status, w.assignedTo || 'Unassigned', w.createdBy, w.created, w.startTime || '', w.finishTime || '', w.totalJobTime || '', w.machineDowntime || '']; }));
            } else if (type === 'equipment') {
                filename = 'equipment-' + today + '.csv';
                csv = buildCSV(['ID','Name','Equipment ID','Manufacturer','Model','Location','Install Date','Status','Criticality','Warranty Expiry','Warranty Provider','Work Orders 30d'],
                    equipmentList.map(function(e) { return [e.id, e.name, e.equipId, e.manufacturer, e.model, e.location, e.installDate, e.status, e.criticality || 'B', e.warrantyExpiry || '', e.warrantyProvider || '', e.workOrders30d]; }));
            } else if (type === 'parts') {
                filename = 'parts-inventory-' + today + '.csv';
                csv = buildCSV(['ID','Name','Part Number','Quantity','Min Stock','Shelf','Bin','Monthly Usage','Compatible Equipment','Suppliers'],
                    partsData.map(function(p) {
                        var eqNames = (p.compatibleEquipment || []).map(function(eId) { var eq = equipmentList.find(function(e) { return e.id === eId; }); return eq ? eq.name : ''; }).filter(Boolean).join('; ');
                        var supNames = (p.suppliers || []).map(function(s) { return s.supplier + ' (' + s.supplierPartNo + ' ¬£' + s.price + ')'; }).join('; ');
                        return [p.id, p.name, p.partNumber, p.qty, p.minStock, p.shelf, p.bin, p.monthlyUsage, eqNames, supNames];
                    }));
            } else if (type === 'breakdowns') {
                filename = 'breakdowns-' + today + '.csv';
                csv = buildCSV(['BR ID','Machine','Date','Time','Fault Description','Root Cause','Action Taken','Resolved By','Time to Resolve','Production Loss','Status'],
                    breakdownsData.map(function(b) { return [b.brId, b.machine, b.dateISO, b.time, b.faultDescription, b.rootCause || '', b.actionTaken || '', b.resolvedBy || '', b.timeToResolve || '', b.productionLoss || '', b.status]; }));
            } else if (type === 'pm') {
                filename = 'pm-schedule-' + today + '.csv';
                csv = buildCSV(['ID','Title','Equipment','Frequency','Duration','Assigned To','Status','Due Status','Scheduled Date','Last Completed'],
                    pmData.map(function(pm) { return [pm.id, pm.title, pm.equipment, pm.frequency, pm.duration, pm.assignedTo, pm.status || '', pm.dueStatus, pm.scheduledDate || '', pm.lastCompleted || '']; }));
            } else if (type === 'purchaseOrders') {
                filename = 'purchase-orders-' + today + '.csv';
                csv = buildCSV(['PO Number','Title','Vendor','Status','Priority','Total','Created','Items','Expected Delivery','Budget Code','Requested By'],
                    purchaseOrdersData.map(function(po) { return [po.poNumber, po.title, po.vendor, po.status, po.priority, po.total, po.created, po.items, po.expectedDelivery, po.budgetCode, po.requestedBy]; }));
            }
            if (csv) {
                downloadFile(filename, csv, 'text/csv');
                showToast('Exported ' + type + ' as CSV!', 'success');
            }
            document.getElementById('exportMenu').style.display = 'none';
        }

        function exportFullReport() {
            var today = new Date().toISOString().slice(0, 10);
            var lines = [];
            lines.push('MAINTENANCE REPORT ‚Äî ' + today);
            lines.push('='.repeat(50));
            lines.push('');

            // KPIs
            var openWo = workOrdersData.filter(function(w) { return w.status === 'open'; }).length;
            var inProgressWo = workOrdersData.filter(function(w) { return w.status === 'in-progress'; }).length;
            var completedWo = workOrdersData.filter(function(w) { return w.status === 'completed'; }).length;
            var overduePm = pmData.filter(function(pm) { return pm.dueStatus === 'overdue'; }).length;
            var lowStockParts = partsData.filter(function(p) { return p.qty > 0 && p.qty <= p.minStock; }).length;
            var outOfStockParts = partsData.filter(function(p) { return p.qty === 0; }).length;

            lines.push('KEY METRICS');
            lines.push('-'.repeat(30));
            lines.push('Open Work Orders: ' + openWo);
            lines.push('In-Progress Work Orders: ' + inProgressWo);
            lines.push('Completed Work Orders: ' + completedWo);
            lines.push('Total Equipment: ' + equipmentList.length);
            lines.push('Overdue PMs: ' + overduePm);
            lines.push('Low Stock Parts: ' + lowStockParts);
            lines.push('Out of Stock Parts: ' + outOfStockParts);
            lines.push('');

            // Equipment summary
            lines.push('EQUIPMENT STATUS');
            lines.push('-'.repeat(30));
            equipmentList.forEach(function(eq) {
                lines.push(eq.equipId + ' | ' + eq.name + ' | ' + eq.status.toUpperCase() + ' | Criticality: ' + (eq.criticality || 'B'));
            });
            lines.push('');

            // Active work orders
            lines.push('ACTIVE WORK ORDERS');
            lines.push('-'.repeat(30));
            workOrdersData.filter(function(w) { return w.status !== 'completed'; }).forEach(function(w) {
                lines.push(w.woId + ' | ' + w.title + ' | ' + w.priority.toUpperCase() + ' | ' + w.status + ' | ' + (w.assignedTo || 'Unassigned'));
            });
            lines.push('');

            // PM compliance
            lines.push('PM SCHEDULE');
            lines.push('-'.repeat(30));
            pmData.forEach(function(pm) {
                lines.push(pm.title + ' | ' + pm.frequency + ' | ' + pm.dueStatus + ' | ' + (pm.assignedTo || 'Unassigned'));
            });
            lines.push('');

            // Parts at risk
            lines.push('PARTS REQUIRING ATTENTION');
            lines.push('-'.repeat(30));
            partsData.filter(function(p) { return p.qty <= p.minStock; }).forEach(function(p) {
                lines.push(p.partNumber + ' | ' + p.name + ' | Qty: ' + p.qty + '/' + p.minStock + ' | ' + (p.qty === 0 ? 'OUT OF STOCK' : 'LOW STOCK'));
            });

            downloadFile('maintenance-report-' + today + '.txt', lines.join('\n'), 'text/plain');
            showToast('Full maintenance report exported!', 'success');
            document.getElementById('exportMenu').style.display = 'none';
        }

        function exportReport() {
            toggleExportMenu();
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // INITIALIZE
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        document.addEventListener('DOMContentLoaded', async function() {
            // Offline indicator
            var offlineEl = document.getElementById('offlineIndicator');
            if (offlineEl) {
                if (!navigator.onLine) offlineEl.style.display = 'inline-block';
                window.addEventListener('online', function() { offlineEl.style.display = 'none'; });
                window.addEventListener('offline', function() { offlineEl.style.display = 'inline-block'; });
            }

            var authed = await checkAuthOnLoad();
            if (!authed) return;
            renderWorkOrders();
            renderEquipment();
            renderParts();
            renderPurchaseOrders();
            renderHotWorkPermits();
            renderContractorPermits();
            renderPM();
            renderEngineerDashboard();
            updateNotificationCount();
            initializeCharts();
        });

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // CHARTS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function initializeCharts() {
            const downtimeCtx = document.getElementById('downtimeChart');
            if (downtimeCtx) {
                new Chart(downtimeCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Line 1', 'Line 2', 'Line 3', 'Line 4'],
                        datasets: [{ label: 'Downtime Hours', data: [3.2, 2.8, 8.5, 4.1],
                            backgroundColor: ['rgba(0,200,83,0.7)','rgba(0,200,83,0.7)','rgba(255,61,0,0.7)','rgba(255,179,0,0.7)'],
                            borderColor: ['rgba(0,200,83,1)','rgba(0,200,83,1)','rgba(255,61,0,1)','rgba(255,179,0,1)'],
                            borderWidth: 2 }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } } }
                });
            }

            const workOrderCtx = document.getElementById('workOrderChart');
            if (workOrderCtx) {
                new Chart(workOrderCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Open', 'In Progress', 'Completed'],
                        datasets: [{ data: [12, 8, 45],
                            backgroundColor: ['rgba(0,102,255,0.7)','rgba(255,179,0,0.7)','rgba(0,200,83,0.7)'],
                            borderColor: ['rgba(0,102,255,1)','rgba(255,179,0,1)','rgba(0,200,83,1)'],
                            borderWidth: 2 }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'bottom', labels: { padding: 15, font: { size: 12, family: "'Work Sans', sans-serif" } } } } }
                });
            }

            const complianceCtx = document.getElementById('complianceChart');
            if (complianceCtx) {
                new Chart(complianceCtx, {
                    type: 'line',
                    data: {
                        labels: ['Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'],
                        datasets: [{ label: 'PM Compliance %', data: [88, 89, 91, 90, 92, 94],
                            borderColor: 'rgba(0,102,255,1)', backgroundColor: 'rgba(0,102,255,0.1)',
                            borderWidth: 3, fill: true, tension: 0.4, pointRadius: 5,
                            pointBackgroundColor: 'rgba(0,102,255,1)', pointBorderColor: '#fff', pointBorderWidth: 2 }]
                    },
                    options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: false, min: 85, max: 100, title: { display: true, text: 'Compliance %' }, ticks: { callback: v => v + '%' } } } }
                });
            }
        }

        // =================================================================
        // REACTIVE MAINTENANCE
        // =================================================================
        var nextBrId = loadData('nextBrId', 4);
        var breakdownsData = loadData('breakdowns', [
            {
                id: 1, brId: 'BR-2026-001',
                machine: 'Line 3 - Filler Machine', dateISO: '2026-02-13', time: '08:45',
                faultDescription: 'Motor overheating \u2014 production stopped on Line 3',
                rootCause: 'Failed motor bearing causing excessive friction and heat',
                actionTaken: 'Replaced motor bearing 6205, cleaned cooling vents, tested for 30 minutes before restart',
                resolvedBy: 'Mike Johnson', timeToResolve: '2.5 hours',
                productionLoss: '3 hours', status: 'resolved', linkedWoId: null
            },
            {
                id: 2, brId: 'BR-2026-002',
                machine: 'Line 1 - Conveyor System', dateISO: '2026-02-16', time: '14:20',
                faultDescription: 'Conveyor belt tracking issue \u2014 product falling off right side of belt',
                rootCause: 'Belt tensioner came loose after vibration during weekend run',
                actionTaken: 'Re-tensioned and re-aligned belt, checked all idler rollers, ran for 1 hour to confirm fix',
                resolvedBy: 'John Smith', timeToResolve: '1.5 hours',
                productionLoss: '1.5 hours', status: 'resolved', linkedWoId: null
            },
            {
                id: 3, brId: 'BR-2026-003',
                machine: 'Line 4 - Packaging Unit', dateISO: '2026-02-20', time: '09:10',
                faultDescription: 'Sealing jaw not reaching temperature \u2014 packs not sealing correctly',
                rootCause: 'Heater element failed. Awaiting replacement part.',
                actionTaken: '',
                resolvedBy: '', timeToResolve: '',
                productionLoss: 'Ongoing', status: 'pending', linkedWoId: 5
            }
        ]);

        // Seed WO for pending breakdown BR-2026-003 (only on first load)
        if (!_hasStoredData) {
            workOrdersData.push({
                id: 5, woId: 'WO-2026-005',
                title: '\u26A1 Breakdown: Sealing jaw not reaching temperature',
                equipment: 'Line 4 - Packaging Unit',
                priority: 'high', status: 'open',
                assignedTo: '', createdBy: 'System',
                created: '20 Feb 2026',
                description: 'Auto-raised from Reactive Maintenance Log. Breakdown: BR-2026-003. Heater element failed.',
                hasPhotos: false, fromBreakdown: 'BR-2026-003'
            });
            nextWoId = 6;
        }

        // =================================================================
        // CALENDAR DATA
        // =================================================================
        var nextCalId = loadData('nextCalId', 8);
        var calendarEvents = loadData('calendarEvents', [
            { id: 1, title: 'Line 3 Annual Service',        equipment: 'Line 3 - Filler Machine',   type: 'major-service', date: '2026-02-20', duration: '8 hours',  assignedTo: 'John Smith',     notes: 'Full strip-down and inspection',                status: 'planned' },
            { id: 2, title: 'Fire Suppression Annual Test', equipment: 'Facility-Wide',              type: 'inspection',    date: '2026-02-25', duration: '2 hours',  assignedTo: 'Mike Johnson',   notes: 'Annual statutory inspection',                   status: 'planned' },
            { id: 3, title: 'Line 1 Weekly Belt Check',     equipment: 'Line 1 - Conveyor System',  type: 'weekly-pm',     date: '2026-02-17', duration: '30 min',   assignedTo: 'John Smith',     notes: '',                                              status: 'completed' },
            { id: 4, title: 'Line 2 Gearbox Oil Change',    equipment: 'Line 2 - Industrial Mixer', type: 'monthly-pm',    date: '2026-02-24', duration: '1 hour',   assignedTo: 'Mike Johnson',   notes: 'Use ISO VG 220 gear oil',                       status: 'planned' },
            { id: 5, title: 'Line 4 Weekly Check',          equipment: 'Line 4 - Packaging Unit',   type: 'weekly-pm',     date: '2026-02-24', duration: '30 min',   assignedTo: 'Sarah Williams', notes: '',                                              status: 'planned' },
            { id: 6, title: 'Factory Shutdown \u2014 Deep Clean', equipment: 'Facility-Wide',        type: 'shutdown',      date: '2026-03-06', duration: 'Full Day', assignedTo: '',               notes: 'Planned shutdown for deep clean and major PMs', status: 'planned' },
            { id: 7, title: 'Line 1 Monthly Lubrication',   equipment: 'Line 1 - Conveyor System',  type: 'monthly-pm',    date: '2026-03-09', duration: '45 min',   assignedTo: 'John Smith',     notes: '',                                              status: 'planned' }
        ]);

        var currentCalYear  = 2026;
        var currentCalMonth = 1;
        var currentCalView  = 'month';
        var currentCalDay   = 22;
        var currentEditBrId = null;

        // =================================================================
        // REACTIVE HELPERS
        // =================================================================
        function brStatusLabel(s) {
            return s === 'resolved' ? 'Resolved' : s === 'in-progress' ? 'In Progress' : 'Pending';
        }
        function evtTypeLabel(t) {
            var m = { 'weekly-pm':'Weekly PM','monthly-pm':'Monthly PM','major-service':'Major Service','inspection':'Inspection','shutdown':'Shutdown' };
            return m[t] || t;
        }
        function formatDateISO(iso) {
            if (!iso) return '';
            var p = iso.split('-');
            var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            return parseInt(p[2]) + ' ' + months[parseInt(p[1]) - 1] + ' ' + p[0];
        }
        function populateEquipDropdown(selectId, includeAll) {
            var sel = document.getElementById(selectId);
            if (!sel) return;
            var prev = sel.value;
            sel.innerHTML = includeAll ? '<option value="">All Machines</option>' : '<option value="">Select machine...</option>';
            equipmentList.forEach(function(eq) {
                var opt = document.createElement('option');
                opt.value = eq.name; opt.textContent = eq.name;
                sel.appendChild(opt);
            });
            var fw = document.createElement('option');
            fw.value = 'Facility-Wide'; fw.textContent = 'Facility-Wide';
            sel.appendChild(fw);
            if (prev) sel.value = prev;
        }

        // =================================================================
        // RENDER BREAKDOWNS
        // =================================================================
        function renderBreakdowns(data) {
            var container = document.getElementById('breakdownsList');
            if (!container) return;
            var list = (data !== undefined) ? data : breakdownsData;
            if (list.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">\u26A1</div><div class="empty-state-title">No Breakdowns Found</div><div class="empty-state-text">No breakdowns match your filter, or none have been logged yet.</div></div>';
                return;
            }
            container.innerHTML = list.map(function(br) {
                var resHtml = '';
                if (br.status === 'resolved' && br.actionTaken) {
                    resHtml = '<div class="breakdown-resolution" style="border-left:3px solid var(--success);">\u2705 <strong>Fix:</strong> ' + escHtml(br.actionTaken) + '</div>';
                } else if (br.status !== 'resolved') {
                    resHtml = '<div class="breakdown-resolution" style="border-left:3px solid var(--danger);">\u26A0\uFE0F Not yet resolved' + (br.linkedWoId ? ' \u2014 Work Order raised' : '') + '</div>';
                }
                var woLink = br.linkedWoId ? ' <span style="font-size:0.78rem;background:var(--warning);color:var(--dark);padding:2px 7px;border-radius:4px;font-weight:700;">\u26A1 WO Raised</span>' : '';
                return '<div class="breakdown-card">'
                    + '<div class="breakdown-bar ' + br.status + '"></div>'
                    + '<div class="breakdown-body">'
                    +   '<div class="breakdown-machine">' + escHtml(br.machine) + '</div>'
                    +   '<div class="breakdown-fault">' + escHtml(br.faultDescription) + '</div>'
                    +   '<div class="breakdown-meta">'
                    +     '<span>\uD83D\uDCC5 ' + formatDateISO(br.dateISO) + (br.time ? ' at ' + br.time : '') + '</span>'
                    +     (br.resolvedBy ? '<span>\uD83D\uDC64 ' + escHtml(br.resolvedBy) + '</span>' : '')
                    +     (br.timeToResolve ? '<span>\u23F1 ' + escHtml(br.timeToResolve) + '</span>' : '')
                    +     (br.productionLoss ? '<span>\u23F3 Loss: ' + escHtml(br.productionLoss) + '</span>' : '')
                    +     woLink
                    +   '</div>'
                    +   resHtml
                    + '</div>'
                    + '<div class="breakdown-status"><span class="status-badge ' + br.status + '">' + brStatusLabel(br.status) + '</span></div>'
                    + '<div class="breakdown-actions">'
                    +   '<button class="btn btn-primary btn-small" onclick="openBreakdownDetail(' + br.id + ')">View / Edit</button>'
                    +   '<button class="btn btn-danger btn-small" onclick="deleteBreakdown(' + br.id + ')">Delete</button>'
                    + '</div></div>';
            }).join('');
        }

        function filterBreakdowns() {
            var machine = document.getElementById('brFilterMachine').value;
            var status  = document.getElementById('brFilterStatus').value;
            var from    = document.getElementById('brFilterFrom').value;
            var to      = document.getElementById('brFilterTo').value;
            var filtered = breakdownsData.slice();
            if (machine) filtered = filtered.filter(function(b) { return b.machine === machine; });
            if (status)  filtered = filtered.filter(function(b) { return b.status  === status;  });
            if (from)    filtered = filtered.filter(function(b) { return b.dateISO >= from; });
            if (to)      filtered = filtered.filter(function(b) { return b.dateISO <= to;   });
            renderBreakdowns(filtered);
        }

        function clearBreakdownFilter() {
            document.getElementById('brFilterMachine').value = '';
            document.getElementById('brFilterStatus').value  = '';
            document.getElementById('brFilterFrom').value    = '';
            document.getElementById('brFilterTo').value      = '';
            renderBreakdowns();
        }

        function filterPMs() {
            var status    = document.getElementById('pmFilterStatus').value;
            var equipment = document.getElementById('pmFilterEquipment').value;
            var from      = document.getElementById('pmFilterFrom').value;
            var to        = document.getElementById('pmFilterTo').value;
            var filtered  = pmData.slice();
            if (status === 'completed') {
                filtered = filtered.filter(function(pm) { return pm.status === 'completed'; });
            } else if (status === 'scheduled') {
                filtered = filtered.filter(function(pm) { return pm.status !== 'completed' && pm.scheduledDate; });
            } else if (status === 'unscheduled') {
                filtered = filtered.filter(function(pm) { return pm.status !== 'completed' && !pm.scheduledDate; });
            }
            if (equipment) filtered = filtered.filter(function(pm) { return pm.equipment === equipment; });
            if (from) filtered = filtered.filter(function(pm) { return pm.scheduledDate && pm.scheduledDate >= from; });
            if (to)   filtered = filtered.filter(function(pm) { return pm.scheduledDate && pm.scheduledDate <= to; });
            renderPM(filtered);
        }

        function clearPMFilter() {
            document.getElementById('pmFilterStatus').value    = '';
            document.getElementById('pmFilterEquipment').value = '';
            document.getElementById('pmFilterFrom').value      = '';
            document.getElementById('pmFilterTo').value        = '';
            renderPM();
        }

        function toggleBrResolutionField() {
            var status  = document.getElementById('brStatus').value;
            var wrap1   = document.getElementById('brResolutionWrap');
            var wrap2   = document.getElementById('brTimeResolveWrap');
            var raiseWo = document.getElementById('brRaiseWo');
            wrap1.style.display = (status === 'pending') ? 'none' : '';
            wrap2.style.display = (status === 'pending') ? 'none' : '';
            raiseWo.checked = (status === 'in-progress' || status === 'pending');
        }

        function submitBreakdown() {
            var machine  = document.getElementById('brMachine').value;
            var dateISO  = document.getElementById('brDate').value;
            var time     = document.getElementById('brTime').value;
            var fault    = document.getElementById('brFaultDesc').value.trim();
            var root     = document.getElementById('brRootCause').value.trim();
            var engineer = document.getElementById('brEngineer').value;
            var prodLoss = document.getElementById('brProductionLoss').value.trim();
            var status   = document.getElementById('brStatus').value;
            var action   = document.getElementById('brActionTaken').value.trim();
            var ttr      = document.getElementById('brTimeToResolve').value.trim();
            var raiseWo  = document.getElementById('brRaiseWo').checked;

            if (!machine || !dateISO || !fault) {
                showToast('Please fill in: machine, date, and fault description.', 'error');
                return;
            }

            var newBrId = 'BR-2026-' + String(nextBrId).padStart(3, '0');
            var linkedWoId = null;

            if (raiseWo || status === 'in-progress' || status === 'pending') {
                var woNum = nextWoId++;
                workOrdersData.unshift({
                    id: woNum,
                    woId: 'WO-2026-' + String(woNum).padStart(3, '0'),
                    title: '\u26A1 Breakdown: ' + fault.slice(0, 60),
                    equipment: machine,
                    priority: 'high', status: 'open',
                    assignedTo: engineer || '',
                    createdBy: engineer || 'System',
                    created: formatDateISO(dateISO),
                    description: 'Auto-raised from Reactive Maintenance. Breakdown: ' + newBrId + '. Root cause: ' + (root || 'Under investigation.'),
                    hasPhotos: false,
                    fromBreakdown: newBrId
                });
                renderWorkOrders();
                linkedWoId = woNum;
            }

            breakdownsData.unshift({
                id: nextBrId++, brId: newBrId,
                machine: machine, dateISO: dateISO, time: time,
                faultDescription: fault, rootCause: root,
                actionTaken: action, resolvedBy: engineer,
                timeToResolve: ttr, productionLoss: prodLoss,
                status: status, linkedWoId: linkedWoId
            });

            closeModal('logBreakdownModal');
            document.getElementById('logBreakdownForm').reset();
            renderBreakdowns();
            populateEquipDropdown('brFilterMachine', true);
            persistAllData();
            showToast('Breakdown logged' + (linkedWoId ? ' \u2014 Work Order raised.' : '.'), 'success');
        }

        function openBreakdownDetail(brId) {
            var br = breakdownsData.find(function(b) { return b.id === brId; });
            if (!br) return;
            currentEditBrId = brId;
            document.getElementById('brDetailTitle').textContent = 'Breakdown \u2014 ' + br.brId;
            populateEquipDropdown('brEditMachine', false);
            document.getElementById('brEditMachine').value        = br.machine;
            document.getElementById('brEditDate').value           = br.dateISO;
            document.getElementById('brEditTime').value           = br.time || '';
            document.getElementById('brEditFaultDesc').value      = br.faultDescription;
            document.getElementById('brEditRootCause').value      = br.rootCause || '';
            document.getElementById('brEditEngineer').value       = br.resolvedBy || '';
            document.getElementById('brEditProductionLoss').value = br.productionLoss || '';
            document.getElementById('brEditStatus').value         = br.status;
            document.getElementById('brEditActionTaken').value    = br.actionTaken || '';
            document.getElementById('brEditTimeToResolve').value  = br.timeToResolve || '';
            var linkedDiv = document.getElementById('brDetailLinkedWo');
            linkedDiv.innerHTML = br.linkedWoId
                ? '<div style="background:var(--gray-100);padding:0.6rem 0.75rem;border-radius:8px;font-size:0.85rem;">\u26A1 Linked Work Order: <strong>WO-2026-' + String(br.linkedWoId).padStart(3,'0') + '</strong></div>'
                : '';
            openModal('breakdownDetailModal');
        }

        function saveBreakdownEdit() {
            var br = breakdownsData.find(function(b) { return b.id === currentEditBrId; });
            if (!br) return;
            var prevStatus       = br.status;
            br.machine           = document.getElementById('brEditMachine').value;
            br.dateISO           = document.getElementById('brEditDate').value;
            br.time              = document.getElementById('brEditTime').value;
            br.faultDescription  = document.getElementById('brEditFaultDesc').value.trim();
            br.rootCause         = document.getElementById('brEditRootCause').value.trim();
            br.resolvedBy        = document.getElementById('brEditEngineer').value;
            br.productionLoss    = document.getElementById('brEditProductionLoss').value.trim();
            br.actionTaken       = document.getElementById('brEditActionTaken').value.trim();
            br.timeToResolve     = document.getElementById('brEditTimeToResolve').value.trim();
            var newStatus        = document.getElementById('brEditStatus').value;

            // If newly resolved and linked WO exists, mark WO completed
            if (newStatus === 'resolved' && prevStatus !== 'resolved' && br.linkedWoId) {
                var wo = workOrdersData.find(function(w) { return w.id === br.linkedWoId; });
                if (wo) { wo.status = 'completed'; renderWorkOrders(); }
            }
            br.status = newStatus;

            closeModal('breakdownDetailModal');
            renderBreakdowns();
            persistAllData();
            showToast('Breakdown updated.', 'success');
        }

        function deleteBreakdown(brId) {
            breakdownsData = breakdownsData.filter(function(b) { return b.id !== brId; });
            renderBreakdowns();
            persistAllData();
            showToast('Breakdown deleted.', 'info');
        }

        // =================================================================
        // MAINTENANCE CALENDAR
        // =================================================================
        var MONTH_NAMES = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        var CAL_DAY_NAMES = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

        function renderCalendar() {
            if (currentCalView === 'month') renderMonthView(currentCalYear, currentCalMonth);
            else renderWeekView(currentCalYear, currentCalMonth, currentCalDay);
            var mb = document.getElementById('calMonthBtn');
            var wb = document.getElementById('calWeekBtn');
            if (mb) mb.classList.toggle('active', currentCalView === 'month');
            if (wb) wb.classList.toggle('active', currentCalView === 'week');
        }

        function renderMonthView(year, month) {
            var titleEl = document.getElementById('calTitle');
            if (titleEl) titleEl.textContent = MONTH_NAMES[month] + ' ' + year;
            var container = document.getElementById('calendarView');
            if (!container) return;

            var todayObj    = new Date(2026, 1, 22);
            var firstDay    = new Date(year, month, 1);
            var daysInMonth = new Date(year, month + 1, 0).getDate();
            var startDow    = (firstDay.getDay() + 6) % 7; // Mon=0

            var html = '<div class="cal-grid">';
            CAL_DAY_NAMES.forEach(function(d) { html += '<div class="cal-day-header">' + d + '</div>'; });
            for (var i = 0; i < startDow; i++) html += '<div class="cal-day empty"></div>';

            for (var d = 1; d <= daysInMonth; d++) {
                var iso = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
                var isToday = (year === todayObj.getFullYear() && month === todayObj.getMonth() && d === todayObj.getDate());
                var dayEvts = calendarEvents.filter(function(e) { return e.date === iso; });
                var visible = dayEvts.slice(0, 3);
                var overflow = dayEvts.length - visible.length;
                var pills = visible.map(function(ev) {
                    return '<span class="cal-event-pill evt-' + ev.type + '" title="' + escHtml(ev.title) + '" onclick="showEventToast(' + ev.id + ')">' + escHtml(ev.title) + '</span>';
                }).join('');
                if (overflow > 0) pills += '<span class="cal-more">+' + overflow + ' more</span>';
                html += '<div class="cal-day' + (isToday ? ' today' : '') + '"><div class="cal-day-num">' + d + '</div>' + pills + '</div>';
            }
            var total = startDow + daysInMonth;
            var rem   = total % 7;
            if (rem !== 0) { for (var j = 0; j < 7 - rem; j++) html += '<div class="cal-day empty"></div>'; }
            html += '</div>';
            container.innerHTML = html;
        }

        function renderWeekView(year, month, day) {
            var pivot  = new Date(year, month, day);
            var dow    = (pivot.getDay() + 6) % 7;
            var monday = new Date(pivot);
            monday.setDate(pivot.getDate() - dow);
            var todayObj = new Date(2026, 1, 22);

            var titleEl = document.getElementById('calTitle');
            if (titleEl) titleEl.textContent = 'Week of Mon ' + monday.getDate() + ' ' + MONTH_NAMES[monday.getMonth()].slice(0,3) + ' ' + monday.getFullYear();

            var container = document.getElementById('calendarView');
            if (!container) return;

            var html = '<div class="week-grid">';
            for (var i = 0; i < 7; i++) {
                var dd = new Date(monday);
                dd.setDate(monday.getDate() + i);
                var iso = dd.getFullYear() + '-' + String(dd.getMonth() + 1).padStart(2, '0') + '-' + String(dd.getDate()).padStart(2, '0');
                var isToday = (dd.toDateString() === todayObj.toDateString());
                var dayEvts = calendarEvents.filter(function(e) { return e.date === iso; });
                var evHtml  = dayEvts.map(function(ev) {
                    return '<div class="week-event evt-' + ev.type + '" onclick="showEventToast(' + ev.id + ')" title="' + escHtml(ev.notes || ev.title) + '">'
                        + '<div>' + escHtml(ev.title) + '</div>'
                        + '<div style="font-weight:400;font-size:0.72rem;opacity:0.85;">' + (ev.duration || '') + (ev.assignedTo ? ' \u2014 ' + escHtml(ev.assignedTo) : '') + '</div>'
                        + '</div>';
                }).join('');
                html += '<div class="week-day-col">'
                    + '<div class="week-day-header' + (isToday ? ' today-header' : '') + '">'
                    + CAL_DAY_NAMES[i] + '<br><span style="font-size:1.1rem;">' + dd.getDate() + '</span></div>'
                    + '<div class="week-events">' + evHtml + '</div></div>';
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function prevPeriod() {
            if (currentCalView === 'month') {
                currentCalMonth--;
                if (currentCalMonth < 0) { currentCalMonth = 11; currentCalYear--; }
            } else {
                var p = new Date(currentCalYear, currentCalMonth, currentCalDay);
                p.setDate(p.getDate() - 7);
                currentCalYear = p.getFullYear(); currentCalMonth = p.getMonth(); currentCalDay = p.getDate();
            }
            renderCalendar();
        }

        function nextPeriod() {
            if (currentCalView === 'month') {
                currentCalMonth++;
                if (currentCalMonth > 11) { currentCalMonth = 0; currentCalYear++; }
            } else {
                var p = new Date(currentCalYear, currentCalMonth, currentCalDay);
                p.setDate(p.getDate() + 7);
                currentCalYear = p.getFullYear(); currentCalMonth = p.getMonth(); currentCalDay = p.getDate();
            }
            renderCalendar();
        }

        function toggleCalendarView(mode) {
            currentCalView = mode;
            if (mode === 'week') { currentCalYear = 2026; currentCalMonth = 1; currentCalDay = 22; }
            renderCalendar();
        }

        function showEventToast(evId) {
            var ev = calendarEvents.find(function(e) { return e.id === evId; });
            if (!ev) return;
            showToast(ev.title + ' \u2014 ' + formatDateISO(ev.date) + (ev.assignedTo ? ' (' + ev.assignedTo + ')' : ''), 'info');
        }

        function submitAddCalendarEvent() {
            var title      = document.getElementById('calJobTitle').value.trim();
            var equipment  = document.getElementById('calEquipment').value;
            var type       = document.getElementById('calType').value;
            var date       = document.getElementById('calDate').value;
            var duration   = document.getElementById('calDuration').value.trim();
            var assignedTo = document.getElementById('calAssignedTo').value;
            var status     = document.getElementById('calStatus').value;
            var notes      = document.getElementById('calNotes').value.trim();
            if (!title || !date) { showToast('Job title and date are required.', 'error'); return; }
            calendarEvents.push({ id: nextCalId++, title: title, equipment: equipment, type: type, date: date, duration: duration, assignedTo: assignedTo, notes: notes, status: status });
            closeModal('addCalendarEventModal');
            document.getElementById('addCalendarEventForm').reset();
            renderCalendar();
            persistAllData();
            showToast('Job added to calendar.', 'success');
        }

        function deleteCalendarEvent(evId) {
            calendarEvents = calendarEvents.filter(function(e) { return e.id !== evId; });
            renderCalendar();
            persistAllData();
            showToast('Calendar event deleted.', 'info');
        }

        // Init new tabs ‚Äî handled by showApp() after authentication

    </script>
</body>
</html>
